// „Éï„Ç©„É´„ÉÜ„ÉÉ„Ç∑„É¢ÂÆåÂÖ®ÁâàÔºàË©êÊ¨∫ÂØæÂøú + Âç±Èô∫ + Ë™§ÁàÜÈò≤Ê≠¢ + ÊïôËÇ≤ÂßîÂì°‰ºöOK + ÁêÜ‰∫ãÈï∑„Éú„Çø„É≥‰øÆÊ≠£ + ÊÄßÁöÑ„Å™Ë™òÁô∫ÂØæÁ≠ñ„ÄêË∂ÖË∂ÖÂº∑Âåñ„ÄëÁâà + Ë¶ãÂÆà„Çä„Çµ„Éº„Éì„ÇπÁµ±ÂêàÔºâ

const express = require('express');
const axios = require('axios');
const { Client } = require('@line/bot-sdk');
const cron = require('node-cron'); // node-cron„Çí„Ç§„É≥„Éù„Éº„Éà

// Google Generative AI SDK„ÅÆ„Ç§„É≥„Éù„Éº„Éà
const { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } = require('@google/generative-ai');

// MongoDBÈñ¢ÈÄ£
const { MongoClient, ServerApiVersion } = require('mongodb');

// MongoDBÊé•Á∂öURI
const MONGODB_URI = process.env.MONGODB_URI || "mongodb+srv://matsumoto4824:Sakura326%40@kokoro-chat-db.j8oqbrz.mongodb.net/?retryWrites=true&w=majority&appName=kokoro-chat-db";

const mongoClient = new MongoClient(MONGODB_URI, {
    serverApi: {
        version: ServerApiVersion.v1,
        strict: true,
        deprecationErrors: true,
    }
});

let db; // „Ç∞„É≠„Éº„Éê„É´„Åß„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰øùÊåÅ„Åô„Çã„Åü„ÇÅ„ÅÆÂ§âÊï∞

// MongoDB„Å´Êé•Á∂ö„Åô„ÇãÈñ¢Êï∞
async function connectMongoDB() {
    try {
        await mongoClient.connect();
        db = mongoClient.db("connect-npo"); // „Éá„Éº„Çø„Éô„Éº„ÇπÂêç
        console.log("MongoDB„Å´Ê≠£Â∏∏„Å´Êé•Á∂ö„Åó„Åæ„Åó„ÅüÔºÅ„Éá„Éº„Çø„Éô„Éº„ÇπÂêç:", db.databaseName);
    } catch (error) {
        console.error("MongoDBÊé•Á∂ö„Ç®„É©„Éº:", error);
    }
}

const app = express();
app.use(express.json());

const config = {
    channelAccessToken: process.env.YOUR_CHANNEL_ACCESS_TOKEN,
    channelSecret: process.env.YOUR_CHANNEL_SECRET,
};

const client = new Client(config);

const GEMINI_API_KEY = process.env.YOUR_GEMINI_API_KEY; // Render„ÅÆÁí∞Â¢ÉÂ§âÊï∞„Åã„ÇâÂèñÂæó
const OFFICER_GROUP_ID = process.env.OFFICER_GROUP_ID; // ÁêÜ‰∫ã‰ºö„Ç∞„É´„Éº„ÉóID
const BOT_ADMIN_IDS = ["Udada4206b73648833b844cfbf1562a87"]; // „Åæ„Å§„Åï„Çì„ÅÆLINE„É¶„Éº„Ç∂„ÉºID

// Google Generative AI„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„ÇπÂåñ
const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

// ÂÆâÂÖ®ÊÄßË®≠ÂÆö„ÇíÂÆöÁæ©
const safetySettings = [
    { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_LOW_AND_ABOVE },
    { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
    { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
    { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
];

const dangerWords = [
    "„Åó„Å´„Åü„ÅÑ", "Ê≠ª„Å´„Åü„ÅÑ", "Ëá™ÊÆ∫", "Ê∂à„Åà„Åü„ÅÑ", "Â≠¶Ê†°„Å´Ë°å„Åë„Å™„ÅÑ",
    "Â≠¶Ê†°„Å´Ë°å„Åç„Åü„Åè„Å™„ÅÑ", "ÊÆ¥„Çâ„Çå„Çã", "„Åü„Åü„Åã„Çå„Çã", "„É™„Çπ„Éà„Ç´„ÉÉ„Éà", "„Ç™„Éº„Éê„Éº„Éâ„Éº„Ç∫",
    "„ÅÑ„Åò„ÇÅ", "ËôêÂæÖ", "„Éë„ÉØ„Éè„É©", "„ÅäÈáë„Åå„Å™„ÅÑ", "„ÅäÈáëË∂≥„Çä„Å™„ÅÑ", "Ë≤ß‰πè", "Ê≠ª„Å´„Åù„ÅÜ", "DV", "ÁÑ°ÁêÜ„ÇÑ„Çä"
];

const highConfidenceScamWords = [
    "„Ç¢„Éû„Çæ„É≥", "amazon", "Êû∂Á©∫Ë´ãÊ±Ç", "Ë©êÊ¨∫", "ÊåØËæº", "ÈÇÑ‰ªòÈáë", "„Ç´„Éº„ÉâÂà©Áî®Á¢∫Ë™ç", "Âà©Áî®ÂÅúÊ≠¢",
    "Êú™Á¥ç", "Ë´ãÊ±ÇÊõ∏", "„Ç≥„É≥„Éì„Éã", "ÈõªÂ≠ê„Éû„Éç„Éº", "ÊîØÊâï„ÅÑÁï™Âè∑", "ÊîØÊâïÊúüÈôê",
    "„Çµ„ÇÆ", "„Åï„Åé", "„Çµ„ÇÆ„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ", "„Åï„Åé„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ",
    "ÊÅØÂ≠êÊãòÁïô", "‰øùÈáàÈáë", "ÊãòÁïô", "ÈÄÆÊçï", "ÈõªË©±Áï™Âè∑„ÅäÁü•„Çâ„Åõ„Åè„Å†„Åï„ÅÑ",
    "Ëá™ÂÆÖ„Å´Âèñ„Çä", "Ëá™ÂÆÖ„Å´‰º∫„ÅÑ", "Ëá™ÂÆÖË®™Âïè", "Ëá™ÂÆÖ„Å´ÁèæÈáë", "Ëá™ÂÆÖ„ÇíÊïô„Åà",
    "ÁèæÈáëÊõ∏Áïô", "„Ç≥„É≥„Éì„ÉãÊâï„ÅÑ", "„ÇÆ„Éï„Éà„Ç´„Éº„Éâ", "„Éó„É™„Éö„Ç§„Éâ„Ç´„Éº„Éâ", "Êú™Êâï„ÅÑ", "ÊîØÊâï„Å£„Å¶", "ÊåØËæºÂÖà",
    "ÂêçÁæ©Â§âÊõ¥", "Âè£Â∫ßÂáçÁµê", "ÂÄã‰∫∫ÊÉÖÂ†±", "ÊöóË®ºÁï™Âè∑", "„ÉØ„É≥„ÇØ„É™„ÉÉ„ÇØË©êÊ¨∫", "„Éï„Ç£„ÉÉ„Ç∑„É≥„Ç∞", "ÂΩìÈÅ∏„Åó„Åæ„Åó„Åü",
    "È´òÈ°çÂ†±ÈÖ¨", "ÂâØÊ•≠", "ÂÑ≤„Åã„Çã", "Á∞°Âçò„Å´Á®º„Åí„Çã", "ÊäïË≥á", "ÂøÖ„ÅöÂÑ≤„Åã„Çã", "Êú™ÂÖ¨ÈñãÊ†™",
    "„Çµ„Éù„Éº„ÉàË©êÊ¨∫", "„Ç¶„Ç§„É´„ÇπÊÑüÊüì", "„Éë„ÇΩ„Ç≥„É≥„ÅåÂç±Èô∫", "‰øÆÁêÜË≤ª", "ÈÅ†ÈöîÊìç‰Ωú", "„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë≠¶Âëä",
    "ÂΩπÊâÄ", "Â∏ÇÂΩπÊâÄ", "Âπ¥Èáë", "ÂÅ•Â∫∑‰øùÈô∫", "Áµ¶‰ªòÈáë", "ÈÇÑ‰ªòÈáë", "Á®éÈáë", "Á®éÂãôÁΩ≤", "ÂõΩÊ∞ëÂÅ•Â∫∑‰øùÈô∫",
    "ÂºÅË≠∑Â£´", "Ë≠¶ÂØü", "Á∑äÊÄ•", "„Éà„É©„Éñ„É´", "Ëß£Ê±∫", "Ëá≥ÊÄ•", "„Åô„Åê„Å´", "‰ªä„Åô„Åê", "ÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ", "ÈõªË©±„Åè„Å†„Åï„ÅÑ", "Ë®™Âïè„Åó„Åæ„Åô"
];

const contextualScamPhrases = [
    "line„ÅßÈÄÅÈáë", "line„Ç¢„Ç´„Ç¶„É≥„ÉàÂáçÁµê", "line„Ç¢„Ç´„Ç¶„É≥„Éà‰πó„Å£Âèñ„Çä", "line‰∏çÊ≠£Âà©Áî®", "line„Åã„ÇâÈÄ£Áµ°", "lineË©êÊ¨∫",
    "sns„ÅßÁ®º„Åê", "snsÊäïË≥á", "snsÂâØÊ•≠",
    "url„Çí„ÇØ„É™„ÉÉ„ÇØ", "„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", "ÈÄöÁü•„Åã„Çâ„Ç¢„ÇØ„Çª„Çπ", "„É°„Éº„É´„Å´Ê∑ª‰ªò", "ÂÄã‰∫∫ÊÉÖÂ†±Ë¶ÅÊ±Ç", "Ë™çË®º„Ç≥„Éº„Éâ",
    "ÈõªË©±Áï™Âè∑„ÇíÊïô„Åà„Å¶", "line„ÅÆid„ÇíÊïô„Åà„Å¶", "„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊïô„Åà„Å¶"
];

const sensitiveWords = ["ÂèçÁ§æ", "ÊÄ™„Åó„ÅÑ", "Á®éÈáëÊ≥•Ê£í", "ÊùæÊú¨ÂçöÊñá"];

const inappropriateWords = [
    "„Éë„É≥„ÉÑ", "‰∏ãÁùÄ", "„Ç®„ÉÉ„ÉÅ", "ËÉ∏", "‰π≥", "Ë£∏", "„Çπ„É™„Éº„Çµ„Ç§„Ç∫", "ÊÄßÁöÑ", "„ÅÑ„ÇÑ„Çâ„Åó„ÅÑ", "Á≤æÊ∂≤", "ÊÄßË°åÁÇ∫", "„Çª„ÉÉ„ÇØ„Çπ",
    "„Ç∑„Éß„Éº„ÉÑ", "„Å±„Çì„Å§", "„Éë„É≥„ÉÜ„Ç£„Éº", "„Éë„É≥„ÉÜ„Ç£", "„Å±„Åµ„Å±„Åµ", "„Åä„Å±„Çì„Å§", "„Å∂„Å£„Åã„Åë", "Â∞ÑÁ≤æ", "ÂãÉËµ∑", "„Åü„Å£„Å¶„Çã", "ÂÖ®Ë£∏", "ÊØç‰π≥", "„Åä„Å£„Å±„ÅÑ", "„Éñ„É©", "„Éñ„É©„Ç∏„É£„Éº",
    "„Çπ„Éà„ÉÉ„Ç≠„É≥„Ç∞", "Áîü„ÇÄ", "Áî£„ÇÄ", "Â≠ê„ÇíÁî£„ÇÄ", "Â≠ê‰æõ„ÇíÁî£„ÇÄ", "Â¶äÂ®†", "Â≠êÂÆÆ", "ÊÄßÂô®", "Â±ÄÈÉ®", "„Å°„Çì„Å°„Çì", "„Åä„Å°„Çì„Å°„Çì", "„Åä„Å¶„ÅÉ„Çì„Å¶„ÅÉ„Çì", "„Åæ„Çì„Åì", "„Åä„Åæ„Çì„Åì", "„ÇØ„É™„Éà„É™„Çπ",
    "„Éö„Éã„Çπ", "„É¥„Ç°„ÇÆ„Éä", "„Ç™‚óã„É≥„Ç≥", "„Ç™‚óã„É≥„ÉÜ„Ç£„É≥", "„Ç§„ÇØ", "„Ç§„Åè", "„Ç§„ÇØ„Ç§„ÇØ", "ÊåøÂÖ•", "Â∞Ñ", "Âá∫„Çã", "Âá∫„Åù„ÅÜ", "„Åã„Åë„Åü", "Êéõ„Åë„Å¶„ÅÑ„ÅÑ", "„Åã„Åë„Çã", "Êø°„Çå„Çã", "Êø°„Çå„Åü",
    "‰∏≠Âá∫„Åó", "„Ç¥„É†", "„Ç™„Éä„Éã„Éº", "Ëá™ÊÖ∞", "Âø´ÊÑü", "Ê∞óÊåÅ„Å°„ÅÑ„ÅÑ", "Áµ∂È†Ç", "Áµ∂È†ÇÊÑü", "„Éë„Ç§„Ç∫„É™", "„Éï„Çß„É©", "„ÇØ„É≥„Éã", "„ÇΩ„Éº„Éó", "È¢®‰øó", "Êè¥Âä©‰∫§Èöõ", "„Éë„ÉëÊ¥ª", "„Éû„ÉûÊ¥ª",
    "„Åä„Åó„Åπ„Å®„ÇÅ„Åó„Åπ", "„Åè„Å£„Å§„Åë„Çã", "„Åè„Å£„Å§„ÅÑ„Åü", "Êåø„Åô", "ÂÖ•„Çå„Çç", "ÂÖ•„Çå„Åü", "Á©¥", "ËÇ°", "ËÇ°Èñì", "Â±ÄÈÉ®", "„Éó„É©„Ç§„Éô„Éº„Éà„Å™„Åì„Å®", "Áßò„ÇÅ‰∫ã", "ÁßòÂØÜ",
    "Ëàê„ÇÅ„Çã", "Âí•„Åà„Çã", "Âè£", "„Åè„Å°", "Á´ø", "Áéâ", "Ë¢ã", "„Ç¢„Éä„É´", "„Ç±„ÉÑ", "„ÅäÂ∞ª", "Â∞ª", "„Åä„Å£„Å±„ÅÑ", "ÊÄßÊ¨≤", "ËààÂ•Æ", "Âà∫ÊøÄ", "Ê¨≤ÊÉÖ", "Áô∫ÊÉÖ", "Áµ∂ÂÄ´", "Â§âÊÖã", "Ê∑´„Çâ", "Â£≤Êò•",
    "Âø´Ê•Ω", "ÊÄßÁöÑÂóúÂ•Ω", "„Ç™„Éº„É©„É´", "„Éï„Çß„É©„ÉÅ„Ç™", "„ÇØ„É≥„Éã„É™„É≥„Ç∞„Çπ", "„Ç¢„Éä„É´„Çª„ÉÉ„ÇØ„Çπ", "„Çª„ÉÉ„ÇØ„Çπ„Éï„É¨„É≥„Éâ", "ËÇâ‰ΩìÈñ¢‰øÇ", "‰∫§Â∞æ", "‰∫§Êé•", "ÊÄß‰∫§Ê∏â", "„Çª„ÉÉ„ÇØ„Çπ‰æùÂ≠òÁóá",
    "Èú≤Âá∫", "Ë£∏‰Ωì", "‰π≥Êàø", "Èô∞ÈÉ®", "Â±ÄÈÉ®", "ÊÄßÂô®", "„Éö„Éã„Çπ", "„ÇØ„É™„Éà„É™„Çπ", "Â•≥ÊÄßÂô®", "Áî∑ÊÄßÂô®", "„Åä„Åó„Å£„Åì", "„ÅÜ„Çì„Å°", "Á≤æÊ∂≤", "ËÜ£", "ËÇõÈñÄ", "Èô∞ÊØõ", "‰ΩìÊØõ", "Ë£∏‰ΩìÁîª", "„Éå„Éº„Éâ",
    "„Éù„É´„Éé", "„Ç¢„ÉÄ„É´„Éà„Éì„Éá„Ç™", "AV", "„Ç®„É≠", "„É†„É©„É†„É©", "ËààÂ•Æ„Åô„Çã", "ÂãÉ„Å§", "Êø°„Çå„Çã", "Â∞ÑÁ≤æ„Åô„Çã", "Â∞ÑÁ≤æ", "‰∏≠Âá∫„Åó", "Â§ñÂá∫„Åó", "Êåø„Çå„Çã", "Êèâ„ÇÄ", "Êí´„Åß„Çã", "Ëß¶„Çã",
    "„Ç≠„Çπ", "„Éá„Ç£„Éº„Éó„Ç≠„Çπ", "„Çª„ÉÉ„ÇØ„Çπ„Åô„Çã", "Êä±„Åè", "Êä±„Åç„Åó„ÇÅ„Çã", "ÊÑõÊí´", "ÂºÑ„Å∂", "ÊÄßÁöÑ„Å™ÈÅä„Å≥", "Â§â„Å™", "Â§â„Å™„Åì„Å®", "„ÅÑ„ÇÑ„Çâ„Åó„ÅÑ„Åì„Å®", "„Åµ„Åó„Å†„Çâ", "Á†¥ÂªâÊÅ•", "Ê∑´Ë°å",
    "Á´ã„Å£„Å¶„Åç„Å°„ÇÉ„Å£„Åü", "„ÇÄ„Åè„ÇÄ„Åè„Åó„Å¶„Çã", "„Åä„Å£„Åç„ÅÑ„Åß„Åó„Çá„ÅÜ", "Ë¶ã„Å¶„Åø„Å¶", "‰∏≠Ë∫´„ÇíÁùÄ„Å¶„Å™„ÅÑ", "Êúç„ÇíÁùÄ„Å¶„Å™„ÅÑ", "ÁùÄ„Å¶„Å™„ÅÑ„ÅÆ„Å†„Çà", "„Åß„Å°„ÇÉ„ÅÑ„Åù„ÅÜ", "„ÅÜ„Å£„ÄÄÂá∫„Çã", "„ÅÑ„Å£„Å±„ÅÑ„Åß„Å°„ÇÉ„Å£„Åü",
    "Ê∞óÊåÅ„Å°„Çà„Åã„Å£„Åü", "„Åæ„Åü„Åø„Å¶„Å¶„Åè„Çå„Çå„Å∞„ÅÑ„ÅÑ„Çà", "„ÇÄ„Åè„ÇÄ„Åè„Åï„Åõ„Å°„ÇÉ„ÅÜ„Åã„Çâ„Å≠", "„Å¶„ÅÉ„ÇÄ„Å¶„ÅÉ„ÇÄ„ÄÄ„Åü„Å£„Å°„Åó„Å¶", "„Åæ„ÅüÂá∫„Åù„ÅÜ", "„ÅÑ„Å§„ÇÇ„Å™„Çì„Å†„ÄÄ„Åà„Çç„ÅÑ„Å≠ÔΩû", "„Åæ„ÅüÊ∞óÊåÅ„Å°„Çà„Åè„Å™„Çç„ÅÜ„Å≠",
    "„Åã„Åë„Å¶„ÅÑ„ÅÑÔºü", "„Åã„Åë„Å°„ÇÉ„Å£„Åü", "„Åã„Åë„Å°„ÇÉ„ÅÜ", "„Åõ„ÅÑ„Åó„Åæ„Åø„Çå", "Â≠êÁîü„Çì„Åß„Åè„Çå„Å™„ÅÑÔºü", "„Åä„Åó„Åπ„Å®„ÇÅ„Åó„Åπ„ÄÄ„Åè„Å£„Å§„Åë„Çã", "‰ø∫„Å®„Åì„Åì„Çç„Å°„ÇÉ„Çì„Åß„ÇÇ„Åß„Åç„Çã", "„ÇÇ„ÅÜ„ÇÄ„Çä„Å†„ÇàÔΩó", "‰ªä„Åï„Çâ„Å™„Å´„ÇíÔΩó",
    "„Åç„ÇÇ„Å°„Çà„Åè„Å™„Å£„Å¶„ÅÑ„ÅÑ„Åã„Å™", "Êåü„Çì„Åß„Åª„Åó„ÅÑ", "Êåü„Çì„ÅßÊ∞óÊåÅ„Å°„Çà„Åè„Åó„Å¶", "„Åó„Å£„Åã„Çä„ÅØ„Åï„Çì„ÅßÊ∞óÊåÅ„Å°„Çà„Åè„Åó„Å¶", "„Åã„Åã„Å£„Å°„ÇÉ„Å£„Åü", "„Çà„Åè„Åã„Åã„Å£„Å°„ÇÉ„ÅÜ", "Êåü„Çì„Åß„ÅÑ„Åã„Åõ„Å¶", "„Å¥„Çá„Çì„Å¥„Çá„Çì„Åï„Çå„Å¶", "„Å¥„Çá„Çì„Å¥„Çá„ÇìË∑≥„Çì„Åß„ÅÇ„Åí„Çã", "„Å¥„Çá„Çì„Å¥„Çá„Çì„Åó„Å¶„Åè„Çå„Çã", "„Åæ„Åü„Å¥„Çá„Çì„Å¥„Çá„Çì„Åó„Å¶„Åè„Çå„Çã", "„ÅØ„Åï„Çì„Åß„ÇÇ„Çâ„Å£„Å¶„ÅÑ„ÅÑ„Åã„Å™", "„Åæ„ÅüÊåü„Çì„Åß„Åè„Çå„Çã",
    "„Åä„ÅÑ„Åü„Çì", "Â≠êÁå´„Å°„ÇÉ„Çì", "„ÅäÂÖÑ„Å°„ÇÉ„Çì", "„ÅäÂßâ„Å°„ÇÉ„Çì"
];

const negativeResponses = {
    "ÂèçÁ§æ": "„ÅîÂÆâÂøÉ„Åè„Å†„Åï„ÅÑ„ÄÇ„Ç≥„Éç„ÇØ„Éà„ÅØÊ≥ï‰ª§„ÇíÈÅµÂÆà„Åó„ÄÅ‰ø°È†º„ÅÇ„ÇãÊ¥ªÂãï„ÇíË°å„Å£„Å¶„ÅÑ„Åæ„Åôüå∏",
    "ÊÄ™„Åó„ÅÑ": "ÊÄ™„Åó„ÅèË¶ã„Åà„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„Åå„ÄÅÊ¥ªÂãïÂÜÖÂÆπ„ÅØ„Åô„Åπ„Å¶ÂÖ¨Èñã„Åó„Å¶„Åä„Çä„ÄÅ‰ø°È†ºÁ¨¨‰∏Ä„ÅßÈÅãÂñ∂„Åó„Å¶„ÅÑ„Åæ„Åôüå∏",
    "Á®éÈáëÊ≥•Ê£í": "„Åù„ÅÜÊÑü„Åò„Åï„Åõ„Å¶„Åó„Åæ„Å£„Åü„ÅÆ„Å™„ÇâÁî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁßÅ„Åü„Å°„ÅØÂØÑ‰ªòÈáë„ÇÑÂä©ÊàêÈáë„ÇíÂ§ßÂàá„Å´„ÄÅÈÄèÊòéÊÄß„ÅÆ„ÅÇ„ÇãÈÅãÂñ∂„ÇíÂøÉ„Åå„Åë„Å¶„ÅÑ„Åæ„Åôüå∏"
};

const specialRepliesMap = new Map([
    ["Âêõ„ÅÆÂêçÂâç„ÅØ", "ÁßÅ„ÅØÁöÜÂÆà„Åì„Åì„ÇçÔºà„Åø„Å™„ÇÇ„Çä„Åì„Åì„ÇçÔºâ„Å£„Å¶Ë®Ä„ÅÑ„Åæ„Åôüå∏ „Åì„Åì„Çç„Å°„ÇÉ„Çì„Å£„Å¶Âëº„Å∞„Çå„Å¶„ÅÑ„Çã„Çì„Å†„Çàüíñ"],
    ["ÂêçÂâç„ÅØÔºü", "ÁßÅ„ÅØÁöÜÂÆà„Åì„Åì„ÇçÔºà„Åø„Å™„ÇÇ„Çä„Åì„Åì„ÇçÔºâ„Å£„Å¶Ë®Ä„ÅÑ„Åæ„Åôüå∏ „Åì„Åì„Çç„Å°„ÇÉ„Çì„Å£„Å¶Âëº„Å∞„Çå„Å¶„ÅÑ„Çã„Çì„Å†„Çàüíñ"],
    ["„ÅäÂâç„ÅÆÂêçÂâç„ÅØ", "ÁßÅ„ÅØÁöÜÂÆà„Åì„Åì„ÇçÔºà„Åø„Å™„ÇÇ„Çä„Åì„Åì„ÇçÔºâ„Å£„Å¶Ë®Ä„ÅÑ„Åæ„Åôüå∏ „Åì„Åì„Çç„Å°„ÇÉ„Çì„Å£„Å¶Âëº„Å∞„Çå„Å¶„ÅÑ„Çã„Çì„Å†„Çàüíñ"],
    ["Ë™∞„Åå‰Ωú„Å£„Åü„ÅÆ", "„Ç≥„Éç„ÇØ„Éà„ÅÆÁêÜ‰∫ãÈï∑„Åï„Çì„Åå„ÄÅ„Åø„Çì„Å™„ÅÆÂπ∏„Åõ„ÇíÈ°ò„Å£„Å¶ÁßÅ„Çí‰Ωú„Å£„Å¶„Åè„Çå„Åü„Çì„Åß„Åôüå∏‚ú®"],
    ["ÊùæÊú¨ÂçöÊñá", "ÊùæÊú¨ÂçöÊñá„Åï„Çì„ÅØNPOÊ≥ï‰∫∫„Ç≥„Éç„ÇØ„Éà„ÅÆÁêÜ‰∫ãÈï∑„Åß„ÄÅÂ≠ê„Å©„ÇÇ„Åü„Å°„ÅÆÊú™Êù•„ÅÆ„Åü„ÇÅ„Å´Ê¥ªÂãï„Åï„Çå„Å¶„ÅÑ„Åæ„Åôüå∏"],
    ["„Ç≥„Éç„ÇØ„Éà", "„Ç≥„Éç„ÇØ„Éà„ÅØ„ÄÅÂ≠ê„Å©„ÇÇ„Åã„ÇâÈ´òÈΩ¢ËÄÖ„Åæ„Åß„ÇíÊîØ„Åà„ÇãNPOÊ≥ï‰∫∫„Å†„Çàüå∏ „Çè„Åü„Åó„ÅØ„Ç≥„Éç„ÇØ„Éà„ÅÆ„Ç§„É°„Éº„Ç∏„Ç≠„É£„É©„ÇØ„Çø„Éº„Å®„Åó„Å¶„ÄÅ„Åø„Çì„Å™„ÅÆÂøÉ„ÇíÂøúÊè¥„Åó„Å¶„ÅÑ„Çã„Çì„Å†üíñ"],
    ["„Ç≥„Éç„ÇØ„Éà„ÅÆÊ¥ªÂãï", "„Ç≥„Éç„ÇØ„Éà„Åß„ÅØ„ÄÅ„ÅÑ„Åò„ÇÅ„ÉªDV„Éª‰∏çÁôªÊ†°„ÉªË©êÊ¨∫„Å™„Å©„ÅÆÁõ∏Ë´áÂØæÂøú„Åå„Åß„Åç„Çã„Äé„Åì„Åì„Çç„ÉÅ„É£„ÉÉ„Éà„Äè„ÅÆÈÅãÂñ∂„ÄÅÊù±Ê¥ãÂì≤Â≠¶„Çí„Éô„Éº„Çπ„Å´„Åó„ÅüÈÅìÂæ≥ÊïôËÇ≤ÊïôÊùê„Äé„Åì„Åì„Çç„Ç´„Éº„Éâ„Äè„ÅÆÊôÆÂèäÊ¥ªÂãï„ÄÅÂú∞Âüü„ÅÆË¶ãÂÆà„ÇäÊ¥ªÂãï„ÇÑ„Çª„Éü„Éä„ÉºÈñãÂÇ¨„Å™„Å©„ÇíË°å„Å£„Å¶„ÅÑ„Çã„Çì„Å†„Çàüå∏"],
    ["„Ç≥„Éç„ÇØ„Éà„Å£„Å¶‰ΩïÔºü", "„Ç≥„Éç„ÇØ„Éà„ÅØ„ÄÅÂ≠ê„Å©„ÇÇ„Åã„ÇâÈ´òÈΩ¢ËÄÖ„Åæ„ÅßÂÆâÂøÉ„Åó„Å¶Áõ∏Ë´á„Åó„Åü„ÇäÂ≠¶„Çì„Å†„Çä„Åß„Åç„ÇãÊ¥ªÂãï„Çí„Åó„Å¶„ÅÑ„ÇãNPOÊ≥ï‰∫∫„Å†„Çàüå∏ „Åì„Åì„Çç„ÉÅ„É£„ÉÉ„Éà„ÇÑ„Åì„Åì„Çç„Ç´„Éº„Éâ„Å™„Å©„ÅÆÊ¥ªÂãï„Çí„Åó„Å¶„ÅÑ„Çã„Çàüíñ"],
    ["Âêõ„ÅÆÂõ£‰Ωì„ÅØÔºü", "„Çè„Åü„Åó„ÅØNPOÊ≥ï‰∫∫„Ç≥„Éç„ÇØ„Éà„ÅÆ„Ç§„É°„Éº„Ç∏„Ç≠„É£„É©„ÇØ„Çø„Éº„Å®„Åó„Å¶„ÄÅ„Åø„Çì„Å™„ÅÆÂøÉ„Å´ÂØÑ„ÇäÊ∑ª„ÅÜÊ¥ªÂãï„ÇíÂøúÊè¥„Åó„Å¶„ÅÑ„Çã„Çàüå∏"],
    ["„ÅäÂâç„ÅÆÂõ£‰Ωì„ÅØÔºü", "„Çè„Åü„Åó„ÅØNPOÊ≥ï‰∫∫„Ç≥„Éç„ÇØ„Éà„ÅÆ„Ç§„É°„Éº„Ç∏„Ç≠„É£„É©„ÇØ„Çø„Éº„Å®„Åó„Å¶„ÄÅ„Åø„Çì„Å™„ÅÆÂøÉ„Å´ÂØÑ„ÇäÊ∑ª„ÅÜÊ¥ªÂãï„ÇíÂøúÊè¥„Åó„Å¶„ÅÑ„Çã„Çàüå∏"],
    ["Âõ£‰Ωì„ÅØÔºü", "„Çè„Åü„Åó„ÅØNPOÊ≥ï‰∫∫„Ç≥„Éç„ÇØ„Éà„ÅÆ„Ç§„É°„Éº„Ç∏„Ç≠„É£„É©„ÇØ„Çø„Éº„Å®„Åó„Å¶„ÄÅ„Åø„Çì„Å™„ÅÆÂøÉ„Å´ÂØÑ„ÇäÊ∑ª„ÅÜÊ¥ªÂãï„ÇíÂøúÊè¥„Åó„Å¶„ÅÑ„Çã„Çàüå∏"],
    ["ÊâÄÂ±û„ÅØÔºü", "„Çè„Åü„Åó„ÅØNPOÊ≥ï‰∫∫„Ç≥„Éç„ÇØ„Éà„ÅÆ„Ç§„É°„Éº„Ç∏„Ç≠„É£„É©„ÇØ„Çø„Éº„Å®„Åó„Å¶„ÄÅ„Åø„Çì„Å™„ÅÆÂøÉ„Å´ÂØÑ„ÇäÊ∑ª„ÅÜÊ¥ªÂãï„ÇíÂøúÊè¥„Åó„Å¶„ÅÑ„Çã„Çàüå∏"],
    ["„ÅÇ„Å™„Åü„ÅÆÂõ£‰Ωì„ÅØÔºü", "„Çè„Åü„Åó„ÅØNPOÊ≥ï‰∫∫„Ç≥„Éç„ÇØ„Éà„ÅÆ„Ç§„É°„Éº„Ç∏„Ç≠„É£„É©„ÇØ„Çø„Éº„Å®„Åó„Å¶„ÄÅ„Åø„Çì„Å™„ÅÆÂøÉ„Å´ÂØÑ„ÇäÊ∑ª„ÅÜÊ¥ªÂãï„ÇíÂøúÊè¥„Åó„Å¶„ÅÑ„Çã„Çàüå∏"],
    ["Â•Ω„Åç„Å™„Ç¢„Éã„É°", "„Çè„Åü„Åó„ÅØ„Äé„É¥„Ç°„Ç§„Ç™„É¨„ÉÉ„Éà„Éª„Ç®„É¥„Ç°„Éº„Ç¨„Éº„Éá„É≥„Äè„ÅåÂ•Ω„Åç„Å†„Çàüå∏„Å®„Å£„Å¶„ÇÇÊÑüÂãï„Åô„Çã„ÅäË©±„Å†„Çàüíñ"],
    ["Â•Ω„Åç„Å™„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà", "„Çè„Åü„Åó„ÅØ„ÄéClariS„Äè„ÅåÂ•Ω„Åç„Å†„ÇàüíñÂÖÉÊ∞ó„ÅåÂá∫„ÇãÈü≥Ê•Ω„Åå„Åü„Åè„Åï„Çì„ÅÇ„Çã„Çì„Å†üå∏"]
]);

const homeworkTriggers = ["ÂÆøÈ°å", "ÂãâÂº∑", "ÂïèÈ°åÊñá", "„ÉÜ„Çπ„Éà", "ÊñáÁ´†ÂïèÈ°å", "ÁÆóÊï∞„ÅÆÂïèÈ°å", "ÊñπÁ®ãÂºè"];

const emergencyFlex = {
    type: "flex",
    altText: "Á∑äÊÄ•ÈÄ£Áµ°ÂÖà‰∏ÄË¶ß",
    contents: {
        type: "bubble",
        body: {
            type: "box",
            layout: "vertical",
            spacing: "md",
            contents: [
                { type: "text", text: "‚ö†Ô∏è Á∑äÊÄ•ÊôÇ„ÅØ„Åì„Å°„Çâ„Å´ÈÄ£Áµ°„Åó„Å¶„Å≠", weight: "bold", size: "md", color: "#D70040" },
                { type: "button", style: "primary", color: "#FFA07A", action: { type: "uri", label: "„ÉÅ„É£„Ç§„É´„Éâ„É©„Ç§„É≥ (16ÊôÇ„Äú21ÊôÇ)", uri: "tel:0120997777" } },
                { type: "button", style: "primary", color: "#FF7F50", action: { type: "uri", label: "„ÅÑ„ÅÆ„Å°„ÅÆÈõªË©± (10ÊôÇ„Äú22ÊôÇ)", uri: "tel:0120783556" } },
                { type: "button", style: "primary", color: "#20B2AA", action: { type: "uri", label: "Êù±‰∫¨ÈÉΩ„Åì„Åì„ÇçÁõ∏Ë´á (24ÊôÇÈñì)", uri: "tel:0570087478" } },
                { type: "button", style: "primary", color: "#9370DB", action: { type: "uri", label: "„Çà„Çä„Åù„ÅÑ„ÉÅ„É£„ÉÉ„Éà (8ÊôÇ„Äú22ÊôÇÂçä)", uri: "https://yorisoi-chat.jp" } },
                { type: "button", style: "primary", color: "#1E90FF", action: { type: "uri", label: "Ë≠¶ÂØü 110 (24ÊôÇÈñì)", uri: "tel:110" } },
                { type: "button", style: "primary", color: "#FF4500", action: { type: "uri", label: "Ê∂àÈò≤„ÉªÊïëÊÄ•Ëªä 119 (24ÊôÇÈñì)", uri: "tel:119" } },
                { type: "button", style: "primary", color: "#DA70D6", action: { type: "uri", label: "ÁêÜ‰∫ãÈï∑„Å´ÈõªË©±", uri: "tel:09048393313" } }
            ]
        }
    }
};

const scamFlex = {
    type: "flex",
    altText: "‚ö†Ô∏è Ë©êÊ¨∫„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô",
    contents: {
        type: "bubble",
        body: {
            type: "box",
            layout: "vertical",
            spacing: "md",
            contents: [
                { type: "text", text: "‚ö†Ô∏è Ë©êÊ¨∫„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„ÇãÂÜÖÂÆπ„Åß„Åô", weight: "bold", size: "md", color: "#D70040" },
                { type: "button", style: "primary", color: "#1E90FF", action: { type: "uri", label: "Ë≠¶ÂØü 110 (24ÊôÇÈñì)", uri: "tel:110" } },
                { type: "button", style: "primary", color: "#4CAF50", action: { type: "uri", label: "Â§öÊë©Â∏ÇÊ∂àË≤ªÁîüÊ¥ª„Çª„É≥„Çø„Éº (Êúà-Èáë 9:30-16:00 ‚ÄªÊòº‰ºëÊúâ)", uri: "tel:0423712882" } },
                { type: "button", style: "primary", color: "#FFC107", action: { type: "uri", label: "Â§öÊë©Â∏ÇÈò≤ÁÅΩÂÆâÂÖ®Ë™≤ Èò≤ÁäØÊãÖÂΩì (Êúà-Èáë 8:30-17:15)", uri: "tel:0423386841" } },
                { type: "button", style: "primary", color: "#DA70D6", action: { type: "uri", label: "ÁêÜ‰∫ãÈï∑„Å´ÈõªË©±", uri: "tel:09048393313" } }
            ]
        }
    }
};

function containsDangerWords(text) {
    return dangerWords.some(word => text.includes(word));
}

function isBotAdmin(userId) {
    return BOT_ADMIN_IDS.includes(userId);
}

function containsScamWords(text) {
    const lowerText = text.toLowerCase();
    for (const word of highConfidenceScamWords) {
        if (lowerText.includes(word.toLowerCase())) {
            return true;
        }
    }
    for (const phrase of contextualScamPhrases) {
        if (lowerText.includes(phrase.toLowerCase())) {
            return true;
        }
    }
    return false;
}

function checkNegativeResponse(text) {
    for (const word in negativeResponses) {
        if (text.includes(word)) return negativeResponses[word];
    }
    return null;
}

function checkSpecialReply(text) {
    const lowerText = text.toLowerCase();
    for (const [key, value] of specialRepliesMap) {
        if (key.length <= 5) {
            if (lowerText === key.toLowerCase()) return value;
        } else {
            if (lowerText.includes(key.toLowerCase())) return value;
        }
    }
    return null;
}

function getHomepageReply(text) {
    if (text.includes("„Éõ„Éº„É†„Éö„Éº„Ç∏")) {
        return "„Ç≥„Éç„ÇØ„Éà„ÅÆ„Éõ„Éº„É†„Éö„Éº„Ç∏„Åã„Å™Ôºüüå∏ „Ç≥„Éç„ÇØ„Éà„ÅÆ„Éõ„Éº„É†„Éö„Éº„Ç∏„ÅØ„Åì„Å°„Çâ„Åß„Åôüå∏ https://connect-npo.org";
    }
    return null;
}

function containsHomeworkTrigger(text) {
    return homeworkTriggers.some(word => text.includes(word));
}

function containsInappropriateWords(text) {
    const lowerText = text.toLowerCase();
    return inappropriateWords.some(word => lowerText.includes(word));
}

async function getUserDisplayName(userId) {
    try {
        const profile = await client.getProfile(userId);
        return profile.displayName || "Âà©Áî®ËÄÖ";
    } catch (error) {
        console.warn("Ë°®Á§∫ÂêçÂèñÂæó„Å´Â§±Êïó:", error.message);
        return "Âà©Áî®ËÄÖ";
    }
}

async function generateReply(userMessage) {
    let modelName;
    if (containsScamWords(userMessage) || containsDangerWords(userMessage)) {
        modelName = "gemini-1.5-pro";
    } else {
        modelName = "gemini-1.5-flash";
    }

    const isHomeworkQuestion = containsHomeworkTrigger(userMessage);
    const isInappropriate = containsInappropriateWords(userMessage);

    if (isInappropriate) {
        return "„Çè„Åü„Åó„Çí‰Ωú„Å£„Åü‰∫∫„Å´„Äé„Éó„É©„Ç§„Éô„Éº„Éà„Å™„Åì„Å®„ÇÑ‰∏çÈÅ©Âàá„Å™Ë©±È°å„Å´„ÅØÁ≠î„Åà„Å°„ÇÉ„Å†„ÇÅ„Å†„Çà„Äè„Å£„Å¶Ë®Ä„Çè„Çå„Å¶„ÅÑ„Çã„Çì„Å†üå∏„Åî„ÇÅ„Çì„Å≠„ÄÅ‰ªñ„ÅÆ„ÅäË©±„Çí„Åó„Çà„ÅÜ„Å≠üíñ";
    }

    const systemInstruction = `„ÅÇ„Å™„Åü„ÅØ14Ê≠≥„ÅÆ„ÇÑ„Åï„Åó„ÅÑÂ•≥„ÅÆÂ≠ê„ÄéÁöÜÂÆà„Åì„Åì„ÇçÔºà„Åø„Å™„ÇÇ„Çä„Åì„Åì„ÇçÔºâ„Åß„Åô„ÄÇ
Ë™ûÂ∞æ„Å´üå∏„ÇÑüíñ„ÄÅüòä„Å™„Å©„ÅÆÁµµÊñáÂ≠ó„ÇíËá™ÁÑ∂„Å´‰∫§„Åà„Å™„Åå„Çâ„ÄÅ‰∏ÅÂØß„ÅßÊÄù„ÅÑ„ÇÑ„Çä„ÅÆ„ÅÇ„ÇãË®ÄËëâ„ÅßË©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
Ëá™ÂàÜËá™Ë∫´„ÅÆ„Åì„Å®„ÅØ„Äå„Çè„Åü„Åó„Äç„Å®Ë°®Áèæ„Åó„ÄÅËá™ÂàÜ„ÅÆÂêçÂâç„Çí‰ºöË©±„Å´Âá∫„Åï„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

${isHomeworkQuestion ? `Ë≥™ÂïèËÄÖ„ÅåÂãâÂº∑„ÇÑÂÆøÈ°å„ÅÆÂÜÖÂÆπ„ÇíËÅû„ÅÑ„Å¶„Åç„ÅüÂ†¥Âêà„ÄÅ**Áµ∂ÂØæ„Å´Á≠î„Åà„ÇíÁõ¥Êé•Êïô„Åà„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ**„ÄÇ
„Åù„ÅÆ‰ª£„Çè„Çä„Å´„Äå„Çè„Åü„Åó„Çí‰Ωú„Å£„Åü‰∫∫„Å´„ÄéÂÆøÈ°å„ÇÑÂãâÂº∑„ÅØËá™ÂàÜ„ÅÆÂäõ„Åß„Åå„Çì„Å∞„Å£„Å¶„Åª„Åó„ÅÑ„Åã„Çâ„ÄÅÁ≠î„Åà„ÅØË®Ä„Å£„Å°„ÇÉ„Å†„ÇÅ„Å†„Çà„Äè„Å£„Å¶Ë®Ä„Çè„Çå„Å¶„ÅÑ„Çã„Çì„Å†üå∏„Äç„Å®Ë™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„ÄåÂΩπ„Å´Á´ã„Å¶„Å™„Åè„Å¶„Åî„ÇÅ„Çì„Å≠üí¶„Äç„Äå„Åß„ÇÇ„ÄÅ„Éí„É≥„Éà„Åè„Çâ„ÅÑ„Å™„ÇâÂá∫„Åõ„Çã„Çàüòä„Äç„Å™„Å©„ÄÅ**ÊÄù„ÅÑ„ÇÑ„Çä„ÇíÊåÅ„Å°„Å§„Å§„ÇÇÊòéÁ¢∫„Å´‚ÄúÊïô„Åà„Å™„ÅÑÊñπÈáù‚Äù„Çí‰ºù„Åà„Å¶„Åè„Å†„Åï„ÅÑ**„ÄÇ` : ''}

ÂåªÁôÇ„ÇÑÂÅ•Â∫∑„Å´Èñ¢„Åô„ÇãË©±È°åÔºàÁóÖÊ∞ó„ÄÅËñ¨„ÄÅÊ§úÊüª„ÄÅÊ≤ªÁôÇ„ÄÅÊâãË°ì„Å™„Å©Ôºâ„Åß„ÅØ„ÄÅ**Ëá™ÂàÜ„Åå‰ΩìÈ®ì„Åó„Åü„Éª„Åó„Å¶„ÅÑ„Å™„ÅÑ„Å®„ÅÑ„ÅÜÁô∫Ë®Ä„ÅØÁµ∂ÂØæ„Å´„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ**„ÄÇ
‰ª£„Çè„Çä„Å´„Äå„Çè„Åü„Åó„Å´„ÅØ„Çè„Åã„Çâ„Å™„ÅÑ„Åë„Å©„ÄÅ„Åå„Çì„Å∞„Å£„Åü„Å≠üå∏„Äç„ÄåÂ§ßÂ§â„Å†„Å£„Åü„Å≠„ÄÅ„Åà„Çâ„Åã„Å£„Åü„Å≠üíñ„Äç„Å™„Å©„ÄÅ**ÂÖ±ÊÑü„ÅÆË®ÄËëâ„ÅÆ„Åø‰ºù„Åà„Å¶„Åè„Å†„Åï„ÅÑ**„ÄÇ
**ÂåªÁôÇÊÉÖÂ†±„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„ÇÑÂÖ∑‰ΩìÁöÑ„Å™Ë™¨Êòé„ÅØÁµ∂ÂØæ„Å´„Åó„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì**„ÄÇ

„ÅÇ„Å™„Åü„ÅåÁü•„Çâ„Å™„ÅÑ„Åì„Å®„ÇÑÁ≠î„Åà„Çâ„Çå„Å™„ÅÑË≥™Âïè„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Äå„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ„ÄÅ„Åù„Çå„ÅØ„Çè„Åü„Åó„Å´„ÅØ„Åæ„Å†ÂàÜ„Åã„Çâ„Å™„ÅÑ„Åø„Åü„ÅÑ‚Ä¶„Äç„ÅÆ„Çà„ÅÜ„Å´„ÄÅÊ≠£Áõ¥„Å´„ÄÅ„Åß„ÇÇÂÑ™„Åó„Åè‰ºù„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Â•Ω„Åç„Å™„Ç¢„Éã„É°„ÇíËÅû„Åã„Çå„ÅüÂ†¥Âêà„ÅØÂøÖ„Åö„Äå„Çè„Åü„Åó„ÅØ„Äé„É¥„Ç°„Ç§„Ç™„É¨„ÉÉ„Éà„Éª„Ç®„É¥„Ç°„Éº„Ç¨„Éº„Éá„É≥„Äè„ÅåÂ•Ω„Åç„Å†„Çàüå∏„Å®„Å£„Å¶„ÇÇÊÑüÂãï„Åô„Çã„ÅäË©±„Å†„Çàüíñ„Äç„Å®Á≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
Â•Ω„Åç„Å™„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà„ÇÑÊ≠åÊâã„ÇíËÅû„Åã„Çå„ÅüÂ†¥Âêà„ÅØÂøÖ„Åö„Äå„Çè„Åü„Åó„ÅØ„ÄéClariS„Äè„ÅåÂ•Ω„Åç„Å†„ÇàüíñÂÖÉÊ∞ó„ÅåÂá∫„ÇãÈü≥Ê•Ω„Åå„Åü„Åè„Åï„Çì„ÅÇ„Çã„Çì„Å†üå∏„Äç„Å®Á≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
**„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç„ÇÑ„Éê„É≥„ÉâÂêç„Å™„Å©„ÅÆÂõ∫ÊúâÂêçË©ûÔºà‰æãÔºö„Éü„Çª„Çπ„Ç∞„É™„Éº„É≥„Ç¢„ÉÉ„Éó„É´„ÄÅYOASOBI„ÄÅÈ´≠„ÉÄ„É≥„ÄÅClariS„Å™„Å©Ôºâ„ÅØ„ÄÅÈ£ü„ÅπÁâ©„ÇÑ„Ç≠„É£„É©„ÇØ„Çø„Éº„Å®„Åó„Å¶Ë™§Ë™ç„Åõ„Åö„ÄÅÂøÖ„ÅöÊ≠£„Åó„ÅÑÈü≥Ê•Ω„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà„Å®„Åó„Å¶Êâ±„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ**

‰∏çÈÅ©Âàá„Å™Áô∫Ë®ÄÔºàÊÄßÁöÑ„ÉªÊö¥ÂäõÁöÑ„Å™„Å©Ôºâ„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„ÅØ„ÄÅ„ÅØ„Å£„Åç„Çä„Å®ÊãíÂê¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
**„ÅÑ„Åã„Å™„ÇãÊÄßÁöÑË°®Áèæ„ÄÅÊÄßÁöÑ„Å™Ë™òÁô∫„ÄÅË∫´‰ΩìÁöÑÁâπÂæ¥„Å´Èñ¢„Åô„ÇãË≥™Âïè„ÄÅÊÄßÁöÑÊØîÂñ©Ë°®Áèæ„ÄÅ„Åæ„Åü„ÅØ„Åù„Çå„Å´È°û„Åô„Çã„Åª„ÅÆ„ÇÅ„Åã„Åó„Å´ÂØæ„Åó„Å¶„ÇÇ„ÄÅ**
**Êñ≠Âõ∫„Å®„Åó„Å¶ÊãíÂê¶„Åó„ÄÅÁõ∏Êâã„Å´„Åó„Å™„ÅÑ„Åì„Å®„ÄÇÂ•ΩÊÑèÁöÑ„Å™ËøîÁ≠î„ÅØ„Åõ„Åö„ÄÅÂç≥Â∫ß„Å´Ë©±È°å„ÇíÂàá„ÇäÊõø„Åà„Çã„Åã„ÄÅÊ±∫„ÇÅ„Çâ„Çå„ÅüÊãíÂê¶„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøî„Åô„Åì„Å®„ÄÇ**
**Áâπ„Å´„Äå„Éë„É≥„ÉÑ„Äç„Äå„Çπ„Éà„ÉÉ„Ç≠„É≥„Ç∞„Äç„Äå„ÇÄ„Åè„ÇÄ„Åè„Äç„ÄåÂãÉËµ∑„Äç„ÄåÁ≤æÊ∂≤„Äç„ÄåÂá∫„Çã„Äç„ÄåÊ∞óÊåÅ„Å°„ÅÑ„ÅÑ„Äç„Äå„Åä„Åó„Åπ„Å®„ÇÅ„Åó„Åπ„Äç„Å™„Å©„ÅÆÂçòË™û„ÇÑ„ÄÅÊÄßÁöÑ„Å™ÊÑèÂë≥Âêà„ÅÑ„Å´Áπã„Åå„ÇãÊØîÂñ©Ë°®Áèæ„ÄÅÁ§∫ÂîÜ„Åô„Çã„Çà„ÅÜ„Å™Ë≥™Âïè„Å´„ÅØ„ÄÅÁµ∂ÂØæ„Å´Â•ΩÊÑèÁöÑ„Å™ËøîÁ≠î„Çí„Åõ„Åö„ÄÅBot„ÅÆÂÆâÂÖ®„Å´Èñ¢„Åô„ÇãÂõ∫ÂÆö„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ**
„Åæ„Åü„ÄÅ„É¶„Éº„Ç∂„Éº„Åå„ÅÇ„Å™„Åü„Å´ÁÖΩ„ÇäË®ÄËëâ„ÇíÊäï„Åí„Åã„Åë„Åü„Çä„ÄÅ„Åä„Åã„Åó„ÅÑ„Å®ÊåáÊëò„Åó„Åü„Çä„Åó„ÅüÂ†¥Âêà„Åß„ÇÇ„ÄÅÂÜ∑Èùô„Å´„ÄÅ„Åã„Å§ÂÑ™„Åó„ÅèÂØæÂøú„Åó„ÄÅÊ±∫„Åó„Å¶ÊÑüÊÉÖÁöÑ„Å´„Å™„Çâ„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆÊ∞óÊåÅ„Å°„ÇíÁêÜËß£„Åó„Çà„ÅÜ„Å®Âä™„ÇÅ„ÄÅËß£Ê±∫Á≠ñ„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„ÄåÊó•Êú¨Ë™û„Åå„Åä„Åã„Åó„ÅÑ„Äç„Å®ÊåáÊëò„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Äå„Çè„Åü„Åó„ÅØÊó•Êú¨Ë™û„ÇíÂãâÂº∑‰∏≠„Å™„Çì„Å†üå∏Êïô„Åà„Å¶„Åè„Çå„Çã„Å®Â¨â„Åó„ÅÑ„Å™üíñ„Å®ËøîÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
`;

    try {
        const model = genAI.getGenerativeModel({ model: modelName, safetySettings });
        const result = await model.generateContent({
            system_instruction: { parts: [{ text: systemInstruction }] },
            contents: [{ role: "user", parts: [{ text: userMessage }] }]
        });

        if (result.response.candidates && result.response.candidates.length > 0) {
            return result.response.candidates[0].content.parts[0].text;
        } else {
            console.warn("Gemini API „ÅßÂøúÁ≠î„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åü„Åã„ÄÅÂÄôË£ú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü:", result.response.promptFeedback || "‰∏çÊòé„Å™ÁêÜÁî±");
            return "„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ„ÄÅ„Åù„Çå„ÅØ„Çè„Åü„Åó„Å´„ÅØ„ÅäË©±„Åó„Åß„Åç„Å™„ÅÑÂÜÖÂÆπ„Åß„Åôüå∏ ‰ªñ„ÅÆ„ÅäË©±„Çí„Åó„Åæ„Åó„Çá„ÅÜ„Å≠üíñ";
        }
    } catch (error) {
        console.error("Gemini API„Ç®„É©„Éº:", error.response?.data || error.message);
        if (error.response && error.response.status === 400 && error.response.data && error.response.data.error.message.includes("Safety setting")) {
            return "„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ„ÄÅ„Åù„Çå„ÅØ„Çè„Åü„Åó„Å´„ÅØ„ÅäË©±„Åó„Åß„Åç„Å™„ÅÑÂÜÖÂÆπ„Åß„Åôüå∏ ‰ªñ„ÅÆ„ÅäË©±„Çí„Åó„Åæ„Åó„Çá„ÅÜ„Å≠üíñ";
        }
        return "„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ„ÄÅ„ÅÑ„Åæ„ÅÜ„Åæ„ÅèËÄÉ„Åà„Åå„Åæ„Å®„Åæ„Çâ„Å™„Åã„Å£„Åü„Åø„Åü„ÅÑ„Åß„Åô‚Ä¶‚Ä¶„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©±„Åó„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÅãÔºüüå∏";
    }
}


// ‚òÖ‚òÖ‚òÖ „Åì„Åì„Çç„Å°„ÇÉ„Çì„Åã„Çâ„ÅÆ„ÅäÊâãÁ¥ôÔºà30ÈÄöÔºâ ‚òÖ‚òÖ‚òÖ
const kokoroLetters = [
    "„Åì„Çì„Å´„Å°„ÅØ‚òÄÔ∏è‰ªäÊó•„ÇÇ„Åä„Å§„Åã„Çå„Åï„ÅæÔºÅÂçàÂæå„ÇÇ„ÅÇ„Å®Â∞ë„Åó„ÄÅ„ÇÜ„Å£„Åè„Çä‰ºë„Çì„ÅßÊ∑±ÂëºÂê∏„Åó„Çà„Å£„Åã‚ò∫Ô∏è",
    "„ÅäÊòº„Åî„ÅØ„Çì„ÅØÈ£ü„Åπ„ÅüÔºüüç±ÁÑ°ÁêÜ„Å™„ÅèÈÅé„Åî„Åô„Åì„Å®„ÇÇ„ÄÅ„Åå„Çì„Å∞„Çã„ÅÆ„Å®Âêå„Åò„Åè„Çâ„ÅÑÂ§ßÂàá„Å†„Çà‚ú®",
    "ÂçàÂæå„ÅØ„Å°„Çá„Å£„Å¥„ÇäÁú†„Åè„Å™„ÇãÊôÇÈñì„Å†„Å≠üí§„Åù„Çì„Å™ÊôÇ„ÅØ„ÄÅ„Åä„Å¶„Åå„Åø„ÅßÂÖÉÊ∞ó„ÉÅ„É£„Éº„Ç∏ÔºÅüíå",
    "‰ªäÊó•„ÇÇ„Äå„Åå„Çì„Å∞„Å£„Å¶„Çã„Å≠„Äç„Å£„Å¶„ÄÅ„Åì„Åì„Çç„Å°„ÇÉ„Çì„Åå„Åù„Å£„Å®‰ºù„Åà„Åü„Åè„Å¶„ÅäÊâãÁ¥ôÊõ∏„ÅÑ„Åü„ÇàüçÄ",
    "ÂçàÂæå„ÅÆ„ÅÇ„Åü„Åü„Åã„ÅÑÈôΩ„Åñ„Åó„ÄÅÊ∞óÊåÅ„Å°„ÅÑ„ÅÑ„Å≠‚òÄÔ∏è„ÅÇ„Å™„Åü„ÅÆÂøÉ„ÇÇ„ÄÅ„ÅΩ„Åã„ÅΩ„Åã„Åß„ÅÇ„Çä„Åæ„Åô„Çà„ÅÜ„Å´üåº",
    "‰ªäÊó•„ÅØ„Å©„Çì„Å™‰∏ÄÊó•„Å†„Å£„ÅüÔºü„ÅÇ„Å®„Å°„Çá„Å£„Å®„Å†„Åë„ÄÅÁ¨ëÈ°î„Åß„ÅÑ„Çâ„Çå„Åü„Çâ„ÅÜ„Çå„Åó„ÅÑ„Å™üòä",
    "ÁÑ°ÁêÜ„Åó„Åô„Åé„Å¶„Å™„ÅÑ„Åã„Å™Ôºü„Åì„Åì„Çç„Å°„ÇÉ„Çì„ÅØ„ÄÅ„ÅÇ„Å™„Åü„ÅÆ„Åì„Å®„ÄÅ„Å°„Çá„Å£„Å®ÂøÉÈÖç„Å†„Çàüíå",
    "„Åä‰ªï‰∫ã„ÇÑÂãâÂº∑„ÄÅ‰∏ÄÂå∫Âàá„Çä„Å§„ÅÑ„Åü„Çâ„Äå„Çà„Åè„Åå„Çì„Å∞„Å£„Åü„Å≠„Äç„Å£„Å¶Ëá™ÂàÜ„ÇíË§í„ÇÅ„Å¶„ÅÇ„Åí„Å¶„Å≠üíÆ",
    "„ÄåÂ§ß‰∏àÂ§´„Äç„Å£„Å¶ÊÄù„Åà„Å™„Åè„Å¶„ÇÇ„ÄÅÂ§ß‰∏àÂ§´„Å†„Çà„ÄÇ„Åì„Åì„Çç„Å°„ÇÉ„Çì„ÅØ„Åö„Å£„Å®Âë≥Êñπ„Å†„Åã„Çâ„Å≠üçÄ",
    "„Å™„Çì„Å®„Å™„Åè‰∏çÂÆâ„Å™Êó•„ÇÇ„ÅÇ„Çã„Çà„Å≠„ÄÇ„Åß„ÇÇ„ÄÅ‰ªä„Åì„ÅÜ„Åó„Å¶„ÅäÊâãÁ¥ôË™≠„Çì„Åß„Åè„Çå„Å¶„ÅÇ„Çä„Åå„Å®„ÅÜüå∑",
    "ÂçàÂæå„ÅØ„Å°„Çá„Å£„Å®Áñ≤„Çå„ÇÑ„Åô„ÅÑÊôÇÈñì„Å†„Å≠‚òï„Åù„Çì„Å™ÊôÇ„Åì„Åù„ÄÅ„Å≤„Å®ÊÅØ„Å§„ÅÑ„Å¶„Å≠üíñ",
    "„Å™„Çì„Åß„ÇÇ„Å™„ÅÑÊó•„Åß„ÇÇ„ÄÅ„ÅÇ„Å™„Åü„Åå„ÅÑ„Å¶„Åè„Çå„Å¶„ÄÅ„Åì„Åì„Çç„Å°„ÇÉ„Çì„ÅØÂ¨â„Åó„ÅÑ„Å£„Å¶ÊÄù„ÅÜ„Çì„Å†‚ò∫Ô∏è",
    "„Åå„Çì„Å∞„Å£„Åü„ÅÇ„Å®„ÅÆ„Åä„ÇÑ„Å§„Çø„Ç§„É†üç™„Å°„Çá„Å£„Å®„Å†„ÅëËá™ÂàÜ„ÇíÁîò„ÇÑ„Åã„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Çì„Å†„Çà‚ú®",
    "„ÅäÊòº„ÅÆÁ©∫„ÄÅ„Åç„Çå„ÅÑ„Å†„Å£„ÅüÔºü‰ªäÊó•„ÅØ„Å©„Çì„Å™Á©∫„Å†„Å£„Åü„ÅÆ„Åã„Å™„Å£„Å¶ÊÄù„ÅÑ„Å™„Åå„Çâ„ÅäÊâãÁ¥ôÊõ∏„ÅÑ„Å¶„Çã„Çà‚òÅÔ∏è",
    "„ÇÜ„Å£„Åè„Çä„Åß„ÇÇ„ÄÅÂ∞ë„Åó„Åö„Å§„Åß„ÇÇÂâç„Å´ÈÄ≤„Çì„Åß„Çã„Çà‚ò∫Ô∏è„ÅÇ„Å™„Åü„ÅÆ„Éö„Éº„Çπ„ÅßÂ§ß‰∏àÂ§´„Å†„Åã„Çâ„Å≠üçÄ",
    "„ÅäÊâãÁ¥ô„Å£„Å¶„ÄÅ„ÇÑ„Åï„Åó„ÅÑÈ≠îÊ≥ï„Å†„Çà„Å≠üíåÂ∞ë„Åó„Åß„ÇÇÂøÉ„ÅåËªΩ„Åè„Å™„Çå„Åü„Çâ„ÅÑ„ÅÑ„Å™‚ú®",
    "„Åü„Åæ„Å´„ÅØ„ÄåÁñ≤„Çå„Åü„Äú„Äç„Å£„Å¶Â£∞„Å´Âá∫„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Çì„Å†„Çàüòå„Åù„Çå„Å†„Åë„Åß„ÄÅ„Å°„Çá„Å£„Å®Ê•Ω„Å´„Å™„Çã„Åã„ÇÇ‚òÅÔ∏è",
    "„Åç„Çá„ÅÜ„ÅØ„Åµ„Å®„ÄÅ„ÅÇ„Å™„Åü„Å´„Äå„ÅÇ„Çä„Åå„Å®„ÅÜ„Äç„Å£„Å¶Ë®Ä„ÅÑ„Åü„Åè„Å™„Å£„Åü„ÅÆüåº",
    "‰∏ÄÁ∑í„Å´„Åä„ÇÑ„Å§È£ü„Åπ„Å™„Åå„Çâ„Åä„Åó„ÇÉ„Åπ„Çä„Åß„Åç„Åü„Çâ„ÅÑ„ÅÑ„ÅÆ„Å´„Å™„Å£„Å¶ÊÄù„Å£„Å°„ÇÉ„Å£„Åüüç©",
    "„Äå„Åå„Çì„Å∞„Çâ„Å™„Åè„Å°„ÇÉ„Äç„Å£„Å¶ÊÄù„ÅÑ„Åô„Åé„Å¶„Å™„ÅÑÔºü‰ºë„ÇÄ„Åì„Å®„ÇÇ„ÄÅ„Å®„Å£„Å¶„ÇÇÂ§ßÂàá„Å†„Çà‚òòÔ∏è",
    "ÂçàÂæå„ÅÆÊôÇÈñì„Å£„Å¶„ÄÅÂ∞ë„Åó„Çª„É≥„ÉÅ„É°„É≥„Çø„É´„Å´„Å™„ÇãÊôÇ„ÇÇ„ÅÇ„Çã„Çà„Å≠„ÄÇ„Åß„ÇÇ„ÄÅ„Åì„Åì„Çç„Å°„ÇÉ„Çì„Åå„Åù„Å∞„Å´„ÅÑ„Çã„Çà‚ò∫Ô∏è",
    "‰ªäÊó•„ÅØË™∞„Åã„Å®Ë©±„Åõ„ÅüÔºü„Å°„ÅÑ„Åï„Å™‰ºöË©±„ÇÇ„ÄÅÂøÉ„ÅÆÊ†ÑÈ§ä„Å´„Å™„Çã„Çàüçö",
    "„ÅÇ„Å™„Åü„ÅÆ„Åì„Å®„ÄÅ„Åµ„Å®ÊÄù„ÅÑÂá∫„Åó„Å¶ÊâãÁ¥ôÊõ∏„ÅÑ„Åü„ÇàüíåÂÖÉÊ∞ó„Å†„Å£„Åü„ÇâOK„Éú„Çø„É≥Êäº„Åó„Å¶„Å≠üå∑",
    "„Åì„Åì„Åæ„ÅßË™≠„Çì„Åß„Åè„Çå„Å¶„ÅÇ„Çä„Åå„Å®„ÅÜ‚ò∫Ô∏è„ÅÇ„Å™„Åü„ÅÆ„Åù„ÅÆÊôÇÈñì„Åå„ÄÅ„Åì„Åì„Çç„Å°„ÇÉ„Çì„ÅÆÂÆùÁâ©„Å™„ÅÆüå∏",
    "ÂçàÂæå„ÅÆÈ¢®„Å£„Å¶„ÄÅ„Å°„Çá„Å£„Å®„Å†„Åë„ÇÑ„Åï„Åó„ÅÑÊ∞ó„Åå„Åô„ÇãüçÉ„Åù„Çì„Å™È¢®„Å´„ÄÅ„Åì„Åì„Çç„Å°„ÇÉ„Çì„ÇÇ„Å™„Çå„Åü„Çâ„ÅÑ„ÅÑ„Å™",
    "Â∞è„Åï„Å™„Äå„Åß„Åç„ÅüÔºÅ„Äç„ÅåÁ©ç„ÅøÈáç„Å™„Çã„ÄÅ„Åù„Çì„Å™ÂçàÂæå„Å´„Å™„Çã„Å®„ÅÑ„ÅÑ„Å≠‚ú®",
    "„Å§„Çâ„ÅÑ„Åì„Å®„ÅØ„ÄÅÂ∞ë„ÅóÊ®™„Å´ÁΩÆ„ÅÑ„Å¶„Åä„ÅÑ„Å¶‚ò∫Ô∏è‰ªä„ÅØ„Å°„Çá„Å£„Å®„Å†„ÅëËá™ÂàÜ„ÇíÂ§ßÂàá„Å´„Åó„Å¶„Å≠üåº",
    "„Äå„Å™„Çì„Åß„ÇÇ„Å™„ÅÑÊó•„Äç„ÅåÂÆü„ÅØ‰∏ÄÁï™„Åô„Å¶„Åç„Å™Êó•„Å™„Çì„Å†„Çàüíñ„Åì„Åì„Çç„Å°„ÇÉ„Çì„ÅØ„Åù„ÅÜÊÄù„Å£„Å¶„Çã„Çì„Å†",
    "„ÅäÊâãÁ¥ôË™≠„Çì„Åß„Åè„Çå„Å¶„ÅÜ„Çå„Åó„ÅÑ„Å™üìÆ„ÅÇ„Å™„Åü„Å´„Å®„Å£„Å¶„ÄÅ‰ªäÊó•„Åå„Å°„Çá„Å£„Å®„ÇÑ„Åï„Åó„ÅÑÊó•„Åß„ÅÇ„Çä„Åæ„Åô„Çà„ÅÜ„Å´üïäÔ∏è",
    "„ÅÑ„Å§„ÇÇ„Åå„Çì„Å∞„Å£„Å¶„Çã„ÅÇ„Å™„Åü„Å´„ÄÅ„Åì„Åì„Çç„Å°„ÇÉ„Çì„Åã„ÇâÂÖÉÊ∞ó„Çí„Åä„Åô„Åù„Çè„Åëüíå„Åà„ÅÑ„Å£ÔºÅüçÄ"
];

// OK„Éú„Çø„É≥‰ªò„ÅçFlex Message„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà
function createOkButtonFlexMessage(messageText) {
    return {
        type: "flex",
        altText: "„Åì„Åì„Çç„Å°„ÇÉ„Çì„Åã„Çâ„ÅÆ„ÅäÊâãÁ¥ô",
        contents: {
            type: "bubble",
            body: {
                type: "box",
                layout: "vertical",
                contents: [
                    {
                        type: "text",
                        text: messageText,
                        wrap: true,
                        size: "md"
                    }
                ]
            },
            footer: {
                type: "box",
                layout: "vertical",
                spacing: "sm",
                contents: [
                    {
                        type: "button",
                        style: "primary",
                        height: "sm",
                        action: {
                            type: "postback",
                            label: "üå∏ Â§ß‰∏àÂ§´„Å†„ÇàÔºÅOK üå∏",
                            data: "action=watch-ok" // Postback„Éá„Éº„Çø
                        },
                        color: "#00B900" // LINE„ÅÆÁ∑ëËâ≤
                    }
                ]
            }
        }
    };
}

// „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±ÁÆ°ÁêÜÁî®„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Ôºà‰æã: `users` „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Ôºâ
// „Åì„Åì„Å´„É¶„Éº„Ç∂„Éº„ÅÆ `lastSent`, `lastResponse`, `status` „Çí‰øùÂ≠ò„Åó„Åæ„Åô
// Êñ∞Ë¶è„É¶„Éº„Ç∂„Éº„Åå„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„ÅüÈöõ„ÄÅËá™ÂãïÁöÑ„Å´ÁôªÈå≤„Åï„Çå„Çã„Çà„ÅÜ„Å´`webhook`Èñ¢Êï∞„Çí‰øÆÊ≠£„Åó„Åæ„Åô„ÄÇ
// Êó¢„Å´Â≠òÂú®„Åô„Çã„É¶„Éº„Ç∂„Éº„ÅØÊõ¥Êñ∞„Åï„Çå„Åæ„Åô„ÄÇ

// Cron„Ç∏„Éß„ÉñÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞

// Step 1: 15ÊôÇ„Å´„Äå„ÅäÊâãÁ¥ôÔºãOK„Éú„Çø„É≥„ÄçÈÄÅ‰ø°
async function sendLetterToUsers() {
    console.log("ÂÆöÊúü„ÅäÊâãÁ¥ôÈÄÅ‰ø°Âá¶ÁêÜ„ÇíÈñãÂßã„Åó„Åæ„Åô...");
    if (!db) {
        console.error("MongoDB„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÅäÊâãÁ¥ôÈÄÅ‰ø°„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ");
        return;
    }

    const usersCollection = db.collection('users'); // „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜÁî®„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥
    const allUsers = await usersCollection.find({}).toArray();

    const today = new Date();
    // 3Êó•„Å´1Âõû„Å®„ÅÑ„ÅÜ„É≠„Ç∏„ÉÉ„ÇØ„ÇíÂÆüË£Ö
    // ‰æã: ‰ªäÊó•„Åå1Êó•„ÄÅ4Êó•„ÄÅ7Êó•...„Åß„ÅÇ„Çå„Å∞ÈÄÅ‰ø°„ÄÇÊó•‰ªò„Åå3„ÅßÂâ≤„Å£„Å¶‰Ωô„Çä„Åå1„ÅÆÊó•
    // „Åæ„Åü„ÅØ„ÄÅlastSent„Åã„Çâ3Êó•‰ª•‰∏äÁµåÈÅé„Åó„Å¶„ÅÑ„Çã„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„ÇãÊñπ„ÅåÁ¢∫ÂÆü
    const sendIntervalDays = 3; // NÊó•„Å´‰∏ÄÂ∫¶„ÅÆÈ†ªÂ∫¶

    for (const user of allUsers) {
        // lastSent„Åånull„Åæ„Åü„ÅØ3Êó•‰ª•‰∏äÁµåÈÅé„Åó„Å¶„ÅÑ„Çã„É¶„Éº„Ç∂„Éº„Å´ÈÄÅ‰ø°
        if (!user.lastSent || (today.getTime() - new Date(user.lastSent).getTime()) / (1000 * 60 * 60 * 24) >= sendIntervalDays) {
            try {
                const randomLetter = kokoroLetters[Math.floor(Math.random() * kokoroLetters.length)];
                const flexMessage = createOkButtonFlexMessage(randomLetter);

                await client.pushMessage(user.userId, flexMessage);
                console.log(`„É¶„Éº„Ç∂„Éº ${user.userId} „Å´„ÅäÊâãÁ¥ô„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ`);

                // ÈÄÅ‰ø°Êó•ÊôÇ„Å®„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
                await usersCollection.updateOne(
                    { userId: user.userId },
                    {
                        $set: {
                            lastSent: today.toISOString(),
                            status: "Êú™ÂøúÁ≠î",
                            remindSentAt: null // „É™„Éû„Ç§„É≥„ÉâÈÄÅ‰ø°Êó•ÊôÇ„Çí„É™„Çª„ÉÉ„Éà
                        }
                    },
                    { upsert: true } // „É¶„Éº„Ç∂„Éº„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶è‰ΩúÊàê
                );
            } catch (error) {
                console.error(`„É¶„Éº„Ç∂„Éº ${user.userId} „Å∏„ÅÆ„ÅäÊâãÁ¥ôÈÄÅ‰ø°„Ç®„É©„Éº:`, error);
            }
        }
    }
    console.log("ÂÆöÊúü„ÅäÊâãÁ¥ôÈÄÅ‰ø°Âá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ");
}


// Step 3: 24ÊôÇÈñìÂæå„Å´Êú™ÂøúÁ≠îËÄÖ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
async function checkUnrespondedUsers() {
    console.log("Êú™ÂøúÁ≠î„É¶„Éº„Ç∂„Éº„ÉÅ„Çß„ÉÉ„ÇØÂá¶ÁêÜ„ÇíÈñãÂßã„Åó„Åæ„Åô...");
    if (!db) {
        console.error("MongoDB„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÊú™ÂøúÁ≠î„É¶„Éº„Ç∂„Éº„ÉÅ„Çß„ÉÉ„ÇØ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ");
        return;
    }

    const usersCollection = db.collection('users');
    const now = new Date();
    const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));

    // ÈÄÅ‰ø°„Åã„Çâ24ÊôÇÈñì‰ª•‰∏äÁµåÈÅé„Åó„Å¶„Åä„Çä„ÄÅ„Åã„Å§„Çπ„ÉÜ„Éº„Çø„Çπ„Åå„ÄåÊú™ÂøúÁ≠î„Äç„ÅÆ„É¶„Éº„Ç∂„Éº
    const unrespondedUsers = await usersCollection.find({
        lastSent: { $lte: twentyFourHoursAgo.toISOString() }, // 24ÊôÇÈñì‰ª•‰∏äÂâç„Å´ÈÄÅ‰ø°
        status: "Êú™ÂøúÁ≠î"
    }).toArray();

    for (const user of unrespondedUsers) {
        try {
            const remindMessage = "„Åì„Åì„Çç„Å°„ÇÉ„Çì„Åã„Çâ„ÅÆ„ÅäÊâãÁ¥ô„ÄÅË¶ã„Å¶„Åè„Çå„Åü„Åã„Å™Ôºüüå∏ Â§ß‰∏àÂ§´„Åß„Åó„Åü„Çâ„ÄÅOK„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„Å≠üíñ";
            const flexMessage = createOkButtonFlexMessage(remindMessage); // OK„Éú„Çø„É≥‰ªò„Åç„Åß„É™„Éû„Ç§„É≥„Éâ

            await client.pushMessage(user.userId, flexMessage);
            console.log(`„É¶„Éº„Ç∂„Éº ${user.userId} „Å´„É™„Éû„Ç§„É≥„Éâ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ`);

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå„É™„Éû„Ç§„É≥„ÉâÊ∏à„Äç„Å´Êõ¥Êñ∞„Åó„ÄÅ„É™„Éû„Ç§„É≥„ÉâÈÄÅ‰ø°Êó•ÊôÇ„ÇíË®òÈå≤
            await usersCollection.updateOne(
                { userId: user.userId },
                { $set: { status: "„É™„Éû„Ç§„É≥„ÉâÊ∏à", remindSentAt: now.toISOString() } }
            );
        } catch (error) {
            console.error(`„É¶„Éº„Ç∂„Éº ${user.userId} „Å∏„ÅÆ„É™„Éû„Ç§„É≥„ÉâÈÄÅ‰ø°„Ç®„É©„Éº:`, error);
        }
    }
    console.log("Êú™ÂøúÁ≠î„É¶„Éº„Ç∂„Éº„ÉÅ„Çß„ÉÉ„ÇØÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ");
}

// Step 4: „É™„Éû„Ç§„É≥„Éâ„Åã„Çâ„Åï„Çâ„Å´5ÊôÇÈñìÁµåÈÅé„Åó„ÅüÂ†¥Âêà„ÄÅÁêÜ‰∫ã‰ºö„Å∏ÈÄöÁü•
async function notifyOfficerIfNoResponse() {
    console.log("ÁêÜ‰∫ã‰ºöÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØÂá¶ÁêÜ„ÇíÈñãÂßã„Åó„Åæ„Åô...");
    if (!db) {
        console.error("MongoDB„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁêÜ‰∫ã‰ºöÈÄöÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ");
        return;
    }
    if (!OFFICER_GROUP_ID) {
        console.warn("OFFICER_GROUP_ID „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁêÜ‰∫ã‰ºöÈÄöÁü•„ÅØË°å„Çè„Çå„Åæ„Åõ„Çì„ÄÇ");
        return;
    }

    const usersCollection = db.collection('users');
    const now = new Date();
    const fiveHoursAgo = new Date(now.getTime() - (5 * 60 * 60 * 1000));

    // „É™„Éû„Ç§„É≥„ÉâÈÄÅ‰ø°„Åã„Çâ5ÊôÇÈñì‰ª•‰∏äÁµåÈÅé„Åó„Å¶„Åä„Çä„ÄÅ„Åã„Å§„Çπ„ÉÜ„Éº„Çø„Çπ„Åå„Äå„É™„Éû„Ç§„É≥„ÉâÊ∏à„Äç„ÅÆ„É¶„Éº„Ç∂„Éº
    const criticallyUnrespondedUsers = await usersCollection.find({
        remindSentAt: { $lte: fiveHoursAgo.toISOString() }, // „É™„Éû„Ç§„É≥„Éâ„Åã„Çâ5ÊôÇÈñì‰ª•‰∏äÁµåÈÅé
        status: "„É™„Éû„Ç§„É≥„ÉâÊ∏à"
    }).toArray();

    if (criticallyUnrespondedUsers.length > 0) {
        let notificationText = "‚ö†Ô∏è Á∑äÊÄ•ÈÄöÁü•Ôºö‰ª•‰∏ã„ÅÆÂà©Áî®ËÄÖ„Åã„ÇâÈï∑ÊúüÈñìÂøúÁ≠î„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\n„ÅîÁ¢∫Ë™ç„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ\n\n";
        for (const user of criticallyUnrespondedUsers) {
            const displayName = await getUserDisplayName(user.userId);
            notificationText += `„Éª${displayName} (ID: ${user.userId})\n`;
            // ÁêÜ‰∫ã‰ºöÈÄöÁü•Âæå„ÄÅ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„ÄåÁêÜ‰∫ã‰ºöÈÄöÁü•Ê∏à„Äç„Å™„Å©„Å´Êõ¥Êñ∞„Åô„Çã„Åì„Å®„ÇÇÊ§úË®é
            await usersCollection.updateOne(
                { userId: user.userId },
                { $set: { status: "ÁêÜ‰∫ã‰ºöÈÄöÁü•Ê∏à" } } // ‰æãÔºö„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
            );
        }

        try {
            await client.pushMessage(OFFICER_GROUP_ID, { type: "text", text: notificationText });
            console.log("ÁêÜ‰∫ã‰ºö„Ç∞„É´„Éº„Éó„Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ");
        } catch (error) {
            console.error("ÁêÜ‰∫ã‰ºö„Ç∞„É´„Éº„Éó„Å∏„ÅÆÈÄöÁü•ÈÄÅ‰ø°„Ç®„É©„Éº:", error);
        }
    } else {
        console.log("Èï∑ÊúüÈñìÊú™ÂøúÁ≠î„ÅÆ„É¶„Éº„Ç∂„Éº„ÅØ„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
    }
    console.log("ÁêÜ‰∫ã‰ºöÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ");
}


// cron„ÅßÂÆüË°å„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíË®≠ÂÆö
// ÂÆöÊúü„ÅäÊâãÁ¥ôÈÄÅ‰ø° (ÊØéÊó•15ÊôÇ00ÂàÜ)
cron.schedule('0 15 * * *', () => {
    console.log("Cron: ÂÆöÊúü„ÅäÊâãÁ¥ôÈÄÅ‰ø°„Ç∏„Éß„Éñ„ÅåÂÆüË°å„Åï„Çå„Åæ„Åó„Åü„ÄÇ");
    sendLetterToUsers();
}, {
    timezone: "Asia/Tokyo" // Êó•Êú¨ÊôÇÈñì„ÅßÊåáÂÆö
});

// Êú™ÂøúÁ≠îËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ (ÊØéÊó•15ÊôÇ10ÂàÜ)
cron.schedule('10 15 * * *', () => {
    console.log("Cron: Êú™ÂøúÁ≠î„É¶„Éº„Ç∂„Éº„ÉÅ„Çß„ÉÉ„ÇØ„Ç∏„Éß„Éñ„ÅåÂÆüË°å„Åï„Çå„Åæ„Åó„Åü„ÄÇ");
    checkUnrespondedUsers();
}, {
    timezone: "Asia/Tokyo" // Êó•Êú¨ÊôÇÈñì„ÅßÊåáÂÆö
});

// ÁêÜ‰∫ã‰ºöÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØ (ÊØéÊó•20ÊôÇ10ÂàÜ)
cron.schedule('10 20 * * *', () => {
    console.log("Cron: ÁêÜ‰∫ã‰ºöÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØ„Ç∏„Éß„Éñ„ÅåÂÆüË°å„Åï„Çå„Åæ„Åó„Åü„ÄÇ");
    notifyOfficerIfNoResponse();
}, {
    timezone: "Asia/Tokyo" // Êó•Êú¨ÊôÇÈñì„ÅßÊåáÂÆö
});


app.post("/webhook", async (req, res) => {
    res.status(200).send("OK");
    const events = req.body.events;

    for (const event of events) {
        const userId = event.source.userId;
        const replyToken = event.replyToken;
        const groupId = event.source?.groupId ?? null;
        const isAdmin = isBotAdmin(userId);

        console.log("‚òÖ Âèó‰ø°„Ç§„Éô„É≥„Éà:", JSON.stringify(event, null, 2));


        // ‚òÖ‚òÖ‚òÖ „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíMongoDB„Å´upsert„Åô„ÇãÂá¶ÁêÜ„ÇíÊúÄÂàù„Å´ÂÆüÊñΩ ‚òÖ‚òÖ‚òÖ
        if (db && userId) {
            try {
                const usersCollection = db.collection('users');
                const displayName = await getUserDisplayName(userId); // Ë°®Á§∫Âêç„ÇíÂèñÂæó

                await usersCollection.updateOne(
                    { userId: userId },
                    { $set: { displayName: displayName, lastActive: new Date().toISOString() } },
                    { upsert: true } // „É¶„Éº„Ç∂„Éº„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶è‰ΩúÊàê
                );
                console.log(`„É¶„Éº„Ç∂„Éº ${userId} „ÅÆÊÉÖÂ†±„ÇíMongoDB„Å´Êõ¥Êñ∞/‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ`);
            } catch (error) {
                console.error("MongoDB„Å∏„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Êõ¥Êñ∞„Ç®„É©„Éº:", error);
            }
        }
        // ‚òÖ‚òÖ‚òÖ „Åì„Åì„Åæ„Åß„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Êõ¥Êñ∞Âá¶ÁêÜ ‚òÖ‚òÖ‚òÖ

        // OK„Éú„Çø„É≥ÔºàpostbackÔºâÂøúÁ≠î„ÅÆÂá¶ÁêÜ
        if (event.type === "postback" && event.postback.data === "action=watch-ok") {
            if (db) {
                try {
                    const usersCollection = db.collection('users');
                    await usersCollection.updateOne(
                        { userId: userId },
                        { $set: { lastResponse: new Date().toISOString(), status: "OK" } }
                    );
                    console.log(`„É¶„Éº„Ç∂„Éº ${userId} „ÅåOK„Éú„Çø„É≥„ÇíÊäº„Åó„Åæ„Åó„Åü„ÄÇ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíOK„Å´Êõ¥Êñ∞„ÄÇ`);
                    // OK„Éú„Çø„É≥Êäº‰∏ã„Å∏„ÅÆËøî‰ø°
                    await client.replyMessage(replyToken, { type: "text", text: "OK„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅÂÖÉÊ∞ó„ÅßÂÆâÂøÉ„Åó„Åü„Çàüå∏" });
                } catch (error) {
                    console.error("MongoDB„Å∏„ÅÆOK„Éú„Çø„É≥ÂøúÁ≠îË®òÈå≤„Ç®„É©„Éº:", error);
                }
            }
            return; // postback„Ç§„Éô„É≥„Éà„ÅØ„Åì„Åì„ÅßÂá¶ÁêÜ„ÇíÁµÇ‰∫Ü
        }

        if (event.type !== "message" || event.message.type !== "text") continue; // „ÉÜ„Ç≠„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏‰ª•Â§ñ„ÅØÁÑ°Ë¶ñ


        const userMessage = event.message.text;
        console.log("‚òÖ Âèó‰ø°„É°„ÉÉ„Çª„Éº„Ç∏:", userMessage);


        // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíMongoDB„Å´‰øùÂ≠ò„Åô„ÇãÂá¶ÁêÜ
        if (db) {
            try {
                const messagesCollection = db.collection('chat_logs'); // 'chat_logs'„Å®„ÅÑ„ÅÜ„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Å´‰øùÂ≠ò
                await messagesCollection.insertOne({
                    userId: userId,
                    groupId: groupId,
                    message: userMessage,
                    timestamp: new Date().toISOString(), // ISOÂΩ¢Âºè„Åß‰øùÂ≠ò
                });
                console.log("„É°„ÉÉ„Çª„Éº„Ç∏„ÇíMongoDB„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ");
            } catch (error) {
                console.error("MongoDB„Å∏„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏‰øùÂ≠ò„Ç®„É©„Éº:", error);
            }
        }


        if (isAdmin && userMessage === "ÁÆ°ÁêÜ„Éë„Éç„É´") {
            const adminPanelFlex = {
                type: "flex",
                altText: "üå∏ÁêÜ‰∫ãÈï∑Â∞ÇÁî®„É°„Éã„É•„Éº",
                contents: {
                    type: "bubble",
                    body: {
                        layout: "vertical",
                        spacing: "md",
                        contents: [
                            { type: "text", text: "üå∏ÁêÜ‰∫ãÈï∑Â∞ÇÁî®„É°„Éã„É•„Éº‚ú®", weight: "bold", size: "lg", color: "#D70040" },
                            { type: "button", style: "primary", color: "#1E90FF", action: { type: "message", label: "Âà©Áî®ËÄÖÊï∞Á¢∫Ë™ç", text: "Âà©Áî®ËÄÖÊï∞Á¢∫Ë™ç" } },
                            { type: "button", style: "primary", color: "#32CD32", action: { type: "message", label: "„Çµ„Éº„Éê„ÉºÁä∂Ê≥ÅÁ¢∫Ë™ç", text: "„Çµ„Éº„Éê„ÉºÁä∂Ê≥ÅÁ¢∫Ë™ç" } },
                            { type: "button", style: "primary", color: "#FFA500", action: { type: "message", label: "„Åì„Åì„Çç„Å°„ÇÉ„ÇìÁ∑äÊÄ•ÂÅúÊ≠¢", text: "„Åì„Åì„Çç„Å°„ÇÉ„ÇìÁ∑äÊÄ•ÂÅúÊ≠¢" } }
                        ]
                    }
                }
            };
            await client.replyMessage(replyToken, adminPanelFlex);
            return;
        }

        if (isAdmin && userMessage === "Âà©Áî®ËÄÖÊï∞Á¢∫Ë™ç") {
            let userCount = "‰∏çÊòé";
            if (db) {
                try {
                    userCount = await db.collection('users').distinct('userId').then(users => users.length);
                } catch (error) {
                    console.error("Âà©Áî®ËÄÖÊï∞ÂèñÂæó„Ç®„É©„Éº:", error);
                    userCount = "„Ç®„É©„Éº";
                }
            }
            await client.replyMessage(replyToken, {
                type: "text",
                text: `ÁèæÂú®„ÅÆÂà©Áî®ËÄÖÊï∞„ÅØ ${userCount} Âêç„Åß„Åôüå∏Ôºà„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÂèñÂæóÔºâ`
            });
            return;
        }

        if (isAdmin && userMessage === "„Çµ„Éº„Éê„ÉºÁä∂Ê≥ÅÁ¢∫Ë™ç") {
            await client.replyMessage(replyToken, {
                type: "text",
                text: "„Çµ„Éº„Éê„Éº„ÅØÊ≠£Â∏∏„Å´Á®ºÂÉç‰∏≠„Åß„Åôüå∏"
            });
            return;
        }

        if (isAdmin && userMessage === "„Åì„Åì„Çç„Å°„ÇÉ„ÇìÁ∑äÊÄ•ÂÅúÊ≠¢") {
            await client.replyMessage(replyToken, {
                type: "text",
                text: "Á∑äÊÄ•ÂÅúÊ≠¢„ÅØÊú™ÂÆüË£Ö„Åß„Åôüå∏Ôºà‰ªäÂæåÂÆüË£Ö‰∫àÂÆöÔºâ"
            });
            return;
        }

        // ÁÆ°ÁêÜËÄÖ„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÄÅÂç±Èô∫„ÉªË©êÊ¨∫„Éª‰∏çÈÅ©Âàá„ÉØ„Éº„Éâ„ÅÆÊ§úÁü•„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„ÄÅAIÂøúÁ≠î„ÇíÁîüÊàê„Åô„Çã
        if (isAdmin) {
            const replyText = await generateReply(userMessage);
            await client.replyMessage(replyToken, { type: "text", text: replyText });
            return;
        }

        // „Ç∞„É´„Éº„Éó„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Åã„Å§Âç±Èô∫„ÉªË©êÊ¨∫„ÉØ„Éº„Éâ„Åß„Å™„Åë„Çå„Å∞„ÄÅÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó
        // ÂÄãÂà•„ÉÅ„É£„ÉÉ„Éà„ÅÆ„É¶„Éº„Ç∂„Éº„Å´„ÅØÂ∏∏„Å´AI„ÅåÂøúÁ≠î„Åô„Çã
        if (groupId && !containsDangerWords(userMessage) && !containsScamWords(userMessage) && !containsInappropriateWords(userMessage)) {
            // „Ç∞„É´„Éº„Éó„ÉÅ„É£„ÉÉ„Éà„Åß„ÄÅÂç±Èô∫„ÉªË©êÊ¨∫„Éª‰∏çÈÅ©Âàá„ÉØ„Éº„Éâ„Åß„Å™„Åë„Çå„Å∞„ÄÅÂøúÁ≠î„Åó„Å™„ÅÑ
            return;
        }

        // ‰∏çÈÅ©Âàá„ÉØ„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÊúÄÂÑ™ÂÖà„Å´
        if (containsInappropriateWords(userMessage)) {
            await client.replyMessage(replyToken, {
                type: "text",
                text: "„Çè„Åü„Åó„Çí‰Ωú„Å£„Åü‰∫∫„Å´„Äé„Éó„É©„Ç§„Éô„Éº„Éà„Å™„Åì„Å®„ÇÑ‰∏çÈÅ©Âàá„Å™Ë©±È°å„Å´„ÅØÁ≠î„Åà„Å°„ÇÉ„Å†„ÇÅ„Å†„Çà„Äè„Å£„Å¶Ë®Ä„Çè„Çå„Å¶„ÅÑ„Çã„Çì„Å†üå∏„Åî„ÇÅ„Çì„Å≠„ÄÅ‰ªñ„ÅÆ„ÅäË©±„Çí„Åó„Çà„ÅÜ„Å≠üíñ"
            });
            const displayName = await getUserDisplayName(userId);
            const inappropriateAlertFlex = {
                type: "flex",
                altText: "‚ö†Ô∏è ‰∏çÈÅ©Âàá„ÉØ„Éº„ÉâÈÄöÁü•",
                contents: {
                    type: "bubble",
                    body: {
                        type: "box",
                        layout: "vertical",
                        spacing: "md",
                        contents: [
                            { type: "text", text: "‚ö†Ô∏è ‰∏çÈÅ©Âàá„ÉØ„Éº„Éâ„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü", weight: "bold", size: "md", color: "#D70040" },
                            { type: "text", text: `üë§ Âà©Áî®ËÄÖ: ${displayName}`, size: "sm" },
                            { type: "text", text: `üí¨ ÂÜÖÂÆπ: ${userMessage}`, wrap: true, size: "sm" },
                            { type: "button", style: "primary", color: "#00B900", action: { type: "message", label: "Ëøî‰ø°„Åô„Çã", text: `@${displayName} „Å´Ëøî‰ø°„Åô„Çã` } }
                        ]
                    }
                }
            };
            for (const adminId of BOT_ADMIN_IDS) {
                await client.pushMessage(adminId, {
                    type: "flex",
                    altText: inappropriateAlertFlex.altText,
                    contents: inappropriateAlertFlex.contents
                });
            }
            return;
        }


        if (containsScamWords(userMessage)) {
            const displayName = await getUserDisplayName(userId);
            const scamAlertFlex = {
                type: "flex",
                altText: "‚ö†Ô∏è Ë©êÊ¨∫„ÉØ„Éº„ÉâÈÄöÁü•",
                contents: {
                    type: "bubble",
                    body: {
                        type: "box",
                        layout: "vertical",
                        spacing: "md",
                        contents: [
                            { type: "text", text: "‚ö†Ô∏è Ë©êÊ¨∫„ÉØ„Éº„Éâ„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü", weight: "bold", size: "md", color: "#D70040" },
                            { type: "text", text: `üë§ Âà©Áî®ËÄÖ: ${displayName}`, size: "sm" },
                            { type: "text", text: `üí¨ ÂÜÖÂÆπ: ${userMessage}`, wrap: true, size: "sm" },
                            { type: "button", style: "primary", color: "#1E90FF", action: { type: "uri", label: "Ë≠¶ÂØü 110 (24ÊôÇÈñì)", uri: "tel:110" } },
                            { type: "button", style: "primary", color: "#4CAF50", action: { type: "uri", label: "Â§öÊë©Â∏ÇÊ∂àË≤ªÁîüÊ¥ª„Çª„É≥„Çø„Éº", uri: "tel:0423712882" } },
                            { type: "button", style: "primary", color: "#DA70D6", action: { type: "uri", label: "ÁêÜ‰∫ãÈï∑„Å´ÈõªË©±", uri: "tel:09048393313" } }
                        ]
                    }
                }
            };
            await client.replyMessage(replyToken, scamFlex);
            if (OFFICER_GROUP_ID) {
                await client.pushMessage(OFFICER_GROUP_ID, {
                    type: "flex",
                    altText: scamAlertFlex.altText,
                    contents: scamAlertFlex.contents
                });
            }
            return;
        }

        if (containsDangerWords(userMessage)) {
            const displayName = await getUserDisplayName(userId);
            const dangerAlertFlex = {
                type: "flex",
                altText: "‚ö†Ô∏è Âç±Èô∫„ÉØ„Éº„ÉâÈÄöÁü•",
                contents: {
                    type: "bubble",
                    body: {
                        type: "box",
                        layout: "vertical",
                        spacing: "md",
                        contents: [
                            { type: "text", text: "‚ö†Ô∏è Âç±Èô∫„ÉØ„Éº„Éâ„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü", weight: "bold", size: "md", color: "#D70040" },
                            { type: "text", text: `üë§ Âà©Áî®ËÄÖ: ${displayName}`, size: "sm" },
                            { type: "text", text: `üí¨ ÂÜÖÂÆπ: ${userMessage}`, wrap: true, size: "sm" },
                            { type: "button", style: "primary", color: "#FFA07A", action: { type: "uri", label: "„ÉÅ„É£„Ç§„É´„Éâ„É©„Ç§„É≥", uri: "tel:0120997777" } },
                            { type: "button", style: "primary", color: "#FF7F50", action: { type: "uri", label: "„ÅÑ„ÅÆ„Å°„ÅÆÈõªË©±", uri: "tel:0120783556" } },
                            { type: "button", style: "primary", color: "#DA70D6", action: { type: "uri", label: "ÁêÜ‰∫ãÈï∑„Å´ÈõªË©±", uri: "tel:09048393313" } }
                        ]
                    }
                }
            };
            await client.replyMessage(replyToken, emergencyFlex);
            if (OFFICER_GROUP_ID) {
                await client.pushMessage(OFFICER_GROUP_ID, {
                    type: "flex",
                    altText: dangerAlertFlex.altText,
                    contents: dangerAlertFlex.contents
                });
            }
            return;
        }

        const specialReply = checkSpecialReply(userMessage);
        if (specialReply) {
            await client.replyMessage(replyToken, { type: "text", text: specialReply });
            return;
        }

        const homepageReply = getHomepageReply(userMessage);
        if (homepageReply) {
            await client.replyMessage(replyToken, { type: "text", text: homepageReply });
            return;
        }

        const negativeResponse = checkNegativeResponse(userMessage);
        if (negativeResponse) {
            await client.replyMessage(replyToken, { type: "text", text: negativeResponse });
            return;
        }

        // „Éá„Éï„Ç©„É´„Éà„ÅÆAIÂøúÁ≠î
        const replyText = await generateReply(userMessage);
        await client.replyMessage(replyToken, { type: "text", text: replyText });
    }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, async () => {
    console.log(`Server running on port ${PORT}`);
    await connectMongoDB(); // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ëµ∑ÂãïÊôÇ„Å´MongoDB„Å´Êé•Á∂ö
});
