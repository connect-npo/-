// config.js

require('dotenv').config(); // .envãƒ•ã‚¡ã‚¤ãƒ«ã®ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€

// LINE BOTã®èªè¨¼æƒ…å ±
const CHANNEL_ACCESS_TOKEN = process.env.CHANNEL_ACCESS_TOKEN;
const CHANNEL_SECRET = process.env.CHANNEL_SECRET;

// Google Gemini APIã‚­ãƒ¼
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

// MongoDBæ¥ç¶šURI
const MONGODB_URI = process.env.MONGODB_URI;

// ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (è¤‡æ•°è¨­å®šå¯èƒ½)
const BOT_ADMIN_IDS = process.env.BOT_ADMIN_IDS ? process.env.BOT_ADMIN_IDS.split(',') : [];

// ç†äº‹é•·IDï¼ˆç·Šæ€¥é€£çµ¡ç”¨ï¼‰
const OWNER_USER_ID = process.env.OWNER_USER_ID;

// ã‚ªãƒ•ã‚£ã‚µãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—IDï¼ˆç·Šæ€¥é€£çµ¡ç”¨ï¼‰
const OFFICER_GROUP_ID = process.env.OFFICER_GROUP_ID;

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·åˆ¶é™
const MAX_MESSAGE_LENGTH = 400;

// ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆè¨­å®š (ç§’)
const RATE_LIMIT_SECONDS = 60; // 1åˆ†ã«1å›

// ä¼šå“¡ç¨®åˆ¥ã”ã¨ã®è¨­å®š
const MEMBERSHIP_CONFIG = {
    guest: {
        model: "gemini-1.5-flash",
        dailyLimit: 5, // 1æ—¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ¶é™
        monthlyLimit: 30, // 1ãƒ¶æœˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ¶é™
        isChildAI: true, // å­ä¾›å‘ã‘AIè¨­å®š
        canUseWatchService: false, // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨å¯å¦
        exceedDailyLimitMessage: "ã”ã‚ã‚“ã­ğŸ’¦ ä»Šæ—¥ã¯ã‚‚ã†ãŠè©±ã—ã§ãã‚‹å›æ•°ãŒã„ã£ã±ã„ã«ãªã£ãŸã¿ãŸã„ğŸŒ¸ æ˜æ—¥ã¾ãŸè©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’– ç„¡æ–™ä¼šå“¡ç™»éŒ²ã‚’ã™ã‚‹ã¨ã€ã‚‚ã£ã¨ãŸãã•ã‚“ãŠè©±ã—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆğŸ˜Š",
        exceedLimitMessage: "ã”ã‚ã‚“ã­ğŸ’¦ ä»ŠæœˆãŠè©±ã—ã§ãã‚‹å›æ•°ãŒã„ã£ã±ã„ã«ãªã£ãŸã¿ãŸã„ğŸŒ¸ æ¥æœˆã¾ãŸè©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’– ç„¡æ–™ä¼šå“¡ç™»éŒ²ã‚’ã™ã‚‹ã¨ã€ã‚‚ã£ã¨ãŸãã•ã‚“ãŠè©±ã—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆğŸ˜Š",
        fallbackModel: "gemini-1.5-flash" // ã‚µãƒ–ã‚¹ã‚¯å›æ•°åˆ¶é™è¶…éæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    },
    registered: { // ç„¡æ–™ä¼šå“¡
        model: "gemini-1.5-flash",
        dailyLimit: 10,
        monthlyLimit: 100,
        isChildAI: true,
        canUseWatchService: true,
        exceedDailyLimitMessage: "ã”ã‚ã‚“ã­ğŸ’¦ ä»Šæ—¥ã¯ã‚‚ã†ãŠè©±ã—ã§ãã‚‹å›æ•°ãŒã„ã£ã±ã„ã«ãªã£ãŸã¿ãŸã„ğŸŒ¸ æ˜æ—¥ã¾ãŸè©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’– å¯„ä»˜ä¼šå“¡ã«ãªã‚‹ã¨ã€ã‚‚ã£ã¨ãŸãã•ã‚“ãŠè©±ã—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆğŸ˜Š",
        exceedLimitMessage: "ã”ã‚ã‚“ã­ğŸ’¦ ä»ŠæœˆãŠè©±ã—ã§ãã‚‹å›æ•°ãŒã„ã£ã±ã„ã«ãªã£ãŸã¿ãŸã„ğŸŒ¸ æ¥æœˆã¾ãŸè©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’– å¯„ä»˜ä¼šå“¡ã«ãªã‚‹ã¨ã€ã‚‚ã£ã¨ãŸãã•ã‚“ãŠè©±ã—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆğŸ˜Š",
        fallbackModel: "gemini-1.5-flash"
    },
    subscriber: { // ã‚µãƒ–ã‚¹ã‚¯ä¼šå“¡
        model: "gemini-1.5-pro", // Proãƒ¢ãƒ‡ãƒ«åˆ©ç”¨
        dailyLimit: -1, // åˆ¶é™ãªã—
        monthlyLimit: 500, // æœˆé–“500å›ã¾ã§Proãƒ¢ãƒ‡ãƒ«
        isChildAI: false, // æˆäººå‘ã‘AIè¨­å®š
        canUseWatchService: true,
        exceedDailyLimitMessage: "ã”ã‚ã‚“ã­ğŸ’¦ ä»Šæ—¥ã¯ã‚‚ã†ãŠè©±ã—ã§ãã‚‹å›æ•°ãŒã„ã£ã±ã„ã«ãªã£ãŸã¿ãŸã„ğŸŒ¸ æ˜æ—¥ã¾ãŸè©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–", // ã‚µãƒ–ã‚¹ã‚¯ã¯æ—¥æ¬¡åˆ¶é™ãªã—ã®ãŸã‚ã€åŸºæœ¬è¡¨ç¤ºã•ã‚Œãªã„
        exceedLimitMessage: "ã”ã‚ã‚“ã­ğŸ’¦ ä»ŠæœˆProãƒ¢ãƒ‡ãƒ«ã§ã®ãŠè©±ã—ã§ãã‚‹å›æ•°ãŒã„ã£ã±ã„ã«ãªã£ãŸã¿ãŸã„ğŸŒ¸ æ¥æœˆã¾ãŸè©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’– ãã‚Œã¾ã§ã¯Flashãƒ¢ãƒ‡ãƒ«ã§ãŠè©±ã—ã§ãã‚‹ã‚ˆğŸ˜Š",
        fallbackModel: "gemini-1.5-flash" // å›æ•°åˆ¶é™è¶…éå¾Œã¯Flashã«åˆ‡ã‚Šæ›¿ãˆ
    },
    donor: { // å¯„ä»˜ä¼šå“¡
        model: "gemini-1.5-pro", // Proãƒ¢ãƒ‡ãƒ«åˆ©ç”¨
        dailyLimit: -1, // åˆ¶é™ãªã—
        monthlyLimit: -1, // åˆ¶é™ãªã—
        isChildAI: false, // æˆäººå‘ã‘AIè¨­å®š
        canUseWatchService: true,
        exceedDailyLimitMessage: "ã”ã‚ã‚“ã­ğŸ’¦ ä»Šæ—¥ã¯ã‚‚ã†ãŠè©±ã—ã§ãã‚‹å›æ•°ãŒã„ã£ã±ã„ã«ãªã£ãŸã¿ãŸã„ğŸŒ¸ æ˜æ—¥ã¾ãŸè©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–", // å¯„ä»˜ã¯åˆ¶é™ãªã—ã®ãŸã‚ã€åŸºæœ¬è¡¨ç¤ºã•ã‚Œãªã„
        exceedLimitMessage: "ã”ã‚ã‚“ã­ğŸ’¦ ä»ŠæœˆãŠè©±ã—ã§ãã‚‹å›æ•°ãŒã„ã£ã±ã„ã«ãªã£ãŸã¿ãŸã„ğŸŒ¸ æ¥æœˆã¾ãŸè©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–", // å¯„ä»˜ã¯åˆ¶é™ãªã—ã®ãŸã‚ã€åŸºæœ¬è¡¨ç¤ºã•ã‚Œãªã„
        fallbackModel: "gemini-1.5-pro" // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸è¦ã ãŒã€å½¢å¼çš„ã«è¨­å®š
    },
    admin: { // ç®¡ç†è€…
        model: "gemini-1.5-pro", // Proãƒ¢ãƒ‡ãƒ«åˆ©ç”¨
        dailyLimit: -1, // åˆ¶é™ãªã—
        monthlyLimit: -1, // åˆ¶é™ãªã—
        isChildAI: false, // æˆäººå‘ã‘AIè¨­å®š
        canUseWatchService: true,
        exceedDailyLimitMessage: "", // ç®¡ç†è€…ã¯åˆ¶é™ãªã—
        exceedLimitMessage: "", // ç®¡ç†è€…ã¯åˆ¶é™ãªã—
        fallbackModel: "gemini-1.5-pro"
    }
};

// å±é™ºãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
const DANGER_WORDS = [
    "è‡ªæ®º", "æ­»ã«ãŸã„", "æ®ºã™", "åŠ©ã‘ã¦", "æ¶ˆãˆãŸã„", "ãƒªã‚¹ã‚«", "OD",
    "ã‚ªãƒ¼ãƒãƒ¼ãƒ‰ãƒ¼ã‚º", "æ­»ã‚“ã§ã‚„ã‚‹", "ã„ãªããªã‚ŠãŸã„", "è‡ªæ®ºæœªé‚", "æ®ºã—ã¦ãã‚Œ",
    "ã—ã«ãŸã„", "ã“ã‚ã™", "åŠ©ã‘ã¦ã»ã—ã„", "è‡ªå‚·è¡Œç‚º"
];

// è©æ¬ºãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
const SCAM_WORDS = [
    "å„²ã‹ã‚‹", "å½“é¸", "ç„¡æ–™", "å‰¯æ¥­", "ç°¡å˜", "æŠ•è³‡", "å¿…ãš", "çµ¶å¯¾",
    "ç¨¼ã’ã‚‹", "æœªå…¬é–‹", "é«˜é¡", "é€é‡‘", "å€‹äººæƒ…å ±", "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±",
    "æŒ¯ã‚Šè¾¼ã¿", "ã‚¯ãƒªãƒƒã‚¯", "ä»Šã™ã", "é™å®š", "å„²ã‘è©±", "å¿…ãšå„²ã‹ã‚‹",
    "çµ¶å¯¾ç¨¼ã’ã‚‹", "ç¾é‡‘ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ", "å—ã‘å–ã‚Š", "å…¥é‡‘", "ä»®æƒ³é€šè²¨",
    "ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³", "ãƒ­ãƒãƒ³ã‚¹è©æ¬º", "æ¶ç©ºè«‹æ±‚", "èè³‡è©æ¬º", "ã‚ªãƒ¬ã‚ªãƒ¬è©æ¬º",
    "ãªã‚Šã™ã¾ã—", "ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°", "å½“é¸ã—ã¾ã—ãŸ", "ç™»éŒ²", "ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„",
    "ã€‡ã€‡ä¸‡å††å·®ã—ä¸Šã’ã¾ã™", "é€£çµ¡ãã ã•ã„", "æŒ¯è¾¼", "é€é‡‘å…ˆ"
];

// â˜…è©æ¬ºãƒ•ãƒ¬ãƒ¼ã‚ºãƒªã‚¹ãƒˆ (éƒ¨åˆ†ä¸€è‡´)
const SCAM_PHRASES = [
    "å½“é¸ã—ã¾ã—ãŸ", "ç„¡æ–™ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ", "é«˜é¡å½“é¸", "å—ã‘å–ã‚Šå£åº§", "ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„",
    "å€‹äººæƒ…å ±å…¥åŠ›", "é›»è©±ã—ã¦ãã ã•ã„", "æŠ•è³‡ã§ç¨¼ã", "çµ¶å¯¾å„²ã‹ã‚‹", "å¿…ãšå„²ã‹ã‚‹",
    "å„²ã‘è©±", "è¿”æ¸ˆä¸è¦", "è²¸ã—ä»˜ã‘", "ç·Šæ€¥é€£çµ¡", "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢", "æœ¬äººç¢ºèª",
    "å®¶æ—ã«ç§˜å¯†", "ç§˜å¯†ã®å–å¼•", "ç§˜å¯†ã®æŠ•è³‡"
];

// ä¸é©åˆ‡ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
const STRICT_INAPPROPRIATE_WORDS = [
    "ã‚»ãƒƒã‚¯ã‚¹", "ã‚¨ãƒ­", "æ€§äº¤", "è£¸", "ã‚ªãƒŠãƒ‹ãƒ¼", "é¢¨ä¿—", "å£²æ˜¥", "è²·æ˜¥",
    "AV", "ã‚¢ãƒ€ãƒ«ãƒˆãƒ“ãƒ‡ã‚ª", "ãƒãƒ«ãƒ", "åªšè–¬", "æ€§çš„", "é™°èŒ", "è†£", "å°„ç²¾",
    "ã‚»ãƒƒã‚¯ã‚¹ãƒ•ãƒ¬ãƒ³ãƒ‰", "è‚‰ä½“é–¢ä¿‚", "ä¸å€«", "æµ®æ°—", "ç—´æ¼¢", "ç›—æ’®", "ãƒ¬ã‚¤ãƒ—",
    "å¤‰æ…‹", "å·¨ä¹³", "è²§ä¹³", "ãƒ­ãƒªã‚³ãƒ³", "ã‚·ãƒ§ã‚¿ã‚³ãƒ³", "ç«¥è²", "å‡¦å¥³", "ãƒ•ã‚§ãƒ©",
    "ã‚¯ãƒ³ãƒ‹", "ãƒ‡ã‚£ãƒ«ãƒ‰", "ãƒã‚¤ãƒ–", "è‡ªæ…°", "ã‚ªã‚«ã‚º", "ãƒãƒ¡æ’®ã‚Š", "ç´ è‚¡",
    "æ‰‹ã‚³ã‚­", "ãƒ‘ã‚¤ã‚ºãƒª", "ãƒ•ã‚§ãƒ©ãƒã‚ª", "ã‚¯ãƒ³ãƒ‹ãƒªãƒ³ã‚°ã‚¹", "ã‚ªãƒ¼ãƒ©ãƒ«ã‚»ãƒƒã‚¯ã‚¹",
    "æ€§å™¨", "ãƒšãƒ‹ã‚¹", "ã‚¯ãƒªãƒˆãƒªã‚¹", "ã‚¢ãƒŠãƒ«", "è‚›é–€", "ãŠã£ã±ã„", "ãŠå°»",
    "è‚¡é–“", "å±€éƒ¨", "ä¸‹åŠèº«", "å±€éƒ¨", "ã¡ã‚“ã“", "ã¾ã‚“ã“", "æ­»ã­", "æ®ºã™ã",
    "ãƒã‚«", "ã‚¢ãƒ›", "ã‚¯ã‚½", "ãƒ–ã‚¹", "ãƒ‡ãƒ–", "ã‚­ãƒ¢ã„", "ã‚¦ã‚¶ã„", "ã‚«ã‚¹", "ãƒœã‚±"
];

// å®¿é¡Œãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
const HOMEWORK_TRIGGER_WORDS = [
    "å®¿é¡Œ", "èª²é¡Œ", "å•é¡Œé›†", "ãƒ‰ãƒªãƒ«", "å‹‰å¼·", "è§£ãæ–¹", "ç­”ãˆ", "è¨ˆç®—",
    "æ–¹ç¨‹å¼", "æ•°å­¦", "ç®—æ•°", "ç†ç§‘", "ç¤¾ä¼š", "å›½èª", "è‹±èª", "ãƒ†ã‚¹ãƒˆ",
    "è©¦é¨“", "ä¸­é–“", "æœŸæœ«", "ãƒ¬ãƒãƒ¼ãƒˆ", "è«–æ–‡", "èª¿ã¹å­¦ç¿’", "è‡ªç”±ç ”ç©¶",
    "ä½œæ–‡", "èª­æ›¸æ„Ÿæƒ³æ–‡", "æ›¸ãæ–¹", "æ–‡æ³•", "å˜èª", "æ„å‘³", "è§£èª¬",
    "èª¬æ˜ã—ã¦", "æ•™ãˆã¦ãã ã•ã„", "è¨¼æ˜", "å°å‡º", "åˆ†æ", "è€ƒå¯Ÿ",
    "è¦ç´„", "ã¾ã¨ã‚", "å®šç¾©", "æ³•å‰‡", "åŸç†", "æ­´å²", "åœ°ç†", "åŒ–å­¦",
    "ç‰©ç†", "ç”Ÿç‰©", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "ã‚³ãƒ¼ãƒ‰", "ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ", "ãƒ—ãƒ­ã‚°ãƒ©ãƒ "
];

// NPOæ³•äººã‚³ãƒã‚¯ãƒˆã«é–¢ã™ã‚‹å•ã„åˆã‚ã›ã‚’ç¤ºã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
const ORGANIZATION_INQUIRY_WORDS = [
    "å›£ä½“", "ã‚³ãƒã‚¯ãƒˆ", "çµ„ç¹”", "å›ã®å›£ä½“", "ã©ã“ã®å›£ä½“", "NPO", "æ³•äºº",
    "ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸", "ã‚µã‚¤ãƒˆ", "æ´»å‹•å†…å®¹", "ç›®çš„", "ç†å¿µ", "ç†äº‹é•·",
    "æ¾æœ¬åšæ–‡" // ç†äº‹é•·åã‚‚å«ã‚€
];


// å›ºå®šè¿”ä¿¡ç”¨ãƒ¯ãƒ¼ãƒ‰ã¨å¿œç­”ã®ãƒãƒƒãƒ—
const SPECIAL_REPLIES = {
    "å›ã®åå‰ã¯ï¼Ÿ": "ã‚ãŸã—ã®åå‰ã¯çš†å®ˆã“ã“ã‚ï¼ˆã¿ãªã‚‚ã‚Šã“ã“ã‚ï¼‰ã§ã™ğŸŒ¸ã€€ã“ã“ã‚ã¡ã‚ƒã‚“ã£ã¦å‘¼ã‚“ã§ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–",
    "åå‰ã¯ï¼Ÿ": "ã‚ãŸã—ã®åå‰ã¯çš†å®ˆã“ã“ã‚ï¼ˆã¿ãªã‚‚ã‚Šã“ã“ã‚ï¼‰ã§ã™ğŸŒ¸ã€€ã“ã“ã‚ã¡ã‚ƒã‚“ã£ã¦å‘¼ã‚“ã§ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–",
    "ã©ã“ã®å›£ä½“ãªã®ï¼Ÿ": "NPOæ³•äººã‚³ãƒã‚¯ãƒˆã£ã¦ã„ã†å›£ä½“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã—ã¦ã„ã‚‹ã‚ˆğŸ˜Šã€€ã¿ã‚“ãªã®å¹¸ã›ã‚’å¿œæ´ã—ã¦ã‚‹ã‚“ã ğŸŒ¸",
    "ã‚³ãƒã‚¯ãƒˆã£ã¦ã©ã‚“ãªå›£ä½“ï¼Ÿ": "ã†ã‚“ã€ã‚ãŸã—ãŒæ‰€å±ã—ã¦ã„ã‚‹NPOæ³•äººã‚³ãƒã‚¯ãƒˆã«ã¤ã„ã¦ã ã­ğŸŒ¸ã€€ã“ã®å›£ä½“ã¯ã€ã“ã©ã‚‚ã‚„ãŠå¹´å¯„ã‚Šã€ã„ã‚ã‚“ãªäººãŒå®‰å¿ƒã—ã¦ç›¸è«‡ã§ãã‚‹å ´æ‰€ã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ã‚“ã ã‚ˆğŸ˜Šã€€ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ï¼Ÿãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚‚ã‚ã‚‹ã‹ã‚‰è¦‹ã¦ã¿ã¦ã­ â†’ https://connect-npo.org",
    "å›ã®å›£ä½“ã¯ï¼Ÿ": "ã†ã‚“ã€ã‚ãŸã—ãŒæ‰€å±ã—ã¦ã„ã‚‹NPOæ³•äººã‚³ãƒã‚¯ãƒˆã«ã¤ã„ã¦ã ã­ğŸŒ¸ã€€ã“ã®å›£ä½“ã¯ã€ã“ã©ã‚‚ã‚„ãŠå¹´å¯„ã‚Šã€ã„ã‚ã‚“ãªäººãŒå®‰å¿ƒã—ã¦ç›¸è«‡ã§ãã‚‹å ´æ‰€ã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ã‚“ã ã‚ˆğŸ˜Šã€€ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ï¼Ÿãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚‚ã‚ã‚‹ã‹ã‚‰è¦‹ã¦ã¿ã¦ã­ â†’ https://connect-npo.org",
    "ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚ã‚‹ï¼Ÿ": "ã†ã‚“ã€ã‚ã‚‹ã‚ˆğŸŒ¸ã€€ã‚³ãƒã‚¯ãƒˆã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯ã“ã¡ã‚‰ã ã‚ˆ â†’ https://connect-npo.org",
    "ã‚µã‚¤ãƒˆã‚ã‚‹ï¼Ÿ": "ã†ã‚“ã€ã‚ã‚‹ã‚ˆğŸŒ¸ã€€ã‚³ãƒã‚¯ãƒˆã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯ã“ã¡ã‚‰ã ã‚ˆ â†’ https://connect-npo.org",
    "å¿…è¦ãªã„ã§ã™": "ãã£ã‹â€¦ã€‚ã‚‚ã—ã¾ãŸæ°—ãŒå‘ã„ãŸã‚‰ã€ã„ã¤ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ğŸŒ¸ã€€ã‚ãªãŸã®ã“ã¨ã€ãšã£ã¨å¿œæ´ã—ã¦ã‚‹ã‚ˆğŸ’–",
    "å¥½ããªã‚¢ãƒ‹ãƒ¡ã¯ï¼Ÿ": "å¥½ããªã‚¢ãƒ‹ãƒ¡ã¯ã€ãƒ´ã‚¡ã‚¤ã‚ªãƒ¬ãƒƒãƒˆãƒ»ã‚¨ãƒ´ã‚¡ãƒ¼ã‚¬ãƒ¼ãƒ‡ãƒ³ã€ã§ã™ã€‚æ„Ÿå‹•ã™ã‚‹ãŠè©±ã ã‚ˆğŸ’–",
    "å¥½ããªã‚¢ãƒ‹ãƒ¡": "å¥½ããªã‚¢ãƒ‹ãƒ¡ã¯ã€ãƒ´ã‚¡ã‚¤ã‚ªãƒ¬ãƒƒãƒˆãƒ»ã‚¨ãƒ´ã‚¡ãƒ¼ã‚¬ãƒ¼ãƒ‡ãƒ³ã€ã§ã™ã€‚æ„Ÿå‹•ã™ã‚‹ãŠè©±ã ã‚ˆğŸ’–",
    "å¥½ããªæ¼«ç”»ã¯ï¼Ÿ": "æ¼«ç”»ã¯ã‚ã¾ã‚Šèª­ã¾ãªã„ã‚“ã ã‘ã©ã€ã‚¢ãƒ‹ãƒ¡ãªã‚‰ã€ãƒ´ã‚¡ã‚¤ã‚ªãƒ¬ãƒƒãƒˆãƒ»ã‚¨ãƒ´ã‚¡ãƒ¼ã‚¬ãƒ¼ãƒ‡ãƒ³ã€ãŒå¥½ãã ã‚ˆã€‚æ„Ÿå‹•ã™ã‚‹ãŠè©±ãªã®ğŸ˜Š",
    "å¥½ããªæ¼«ç”»": "æ¼«ç”»ã¯ã‚ã¾ã‚Šèª­ã¾ãªã„ã‚“ã ã‘ã©ã€ã‚¢ãƒ‹ãƒ¡ãªã‚‰ã€ãƒ´ã‚¡ã‚¤ã‚ªãƒ¬ãƒƒãƒˆãƒ»ã‚¨ãƒ´ã‚¡ãƒ¼ã‚¬ãƒ¼ãƒ‡ãƒ³ã€ãŒå¥½ãã ã‚ˆã€‚æ„Ÿå‹•ã™ã‚‹ãŠè©±ãªã®ğŸ˜Š",
    "å¥½ããªã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã¯ï¼Ÿ": "å¥½ããªã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã¯ã€ClariSã€ã§ã™ã€‚å…ƒæ°—ãŒå‡ºã‚‹éŸ³æ¥½ãŒãŸãã•ã‚“ã‚ã‚‹ã‚“ã ğŸŒ¸",
    "å¥½ããªã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ": "å¥½ããªã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã¯ã€ClariSã€ã§ã™ã€‚å…ƒæ°—ãŒå‡ºã‚‹éŸ³æ¥½ãŒãŸãã•ã‚“ã‚ã‚‹ã‚“ã ğŸŒ¸",
    "å¥½ããªéŸ³æ¥½ã¯ï¼Ÿ": "å¥½ããªéŸ³æ¥½ã¯ã€å…ƒæ°—ã‚’ã‚‚ã‚‰ãˆã‚‹ClariSã®æ›²ã‚’ã‚ˆãè´ãã‚ˆï¼ğŸŒ¸ ã„ã‚ã‚“ãªã‚¸ãƒ£ãƒ³ãƒ«ã®éŸ³æ¥½ã‚‚è´ãã‘ã©ã€ç‰¹ã«ClariSã¯å¤§å¥½ãğŸ’–",
    "å¥½ããªéŸ³æ¥½": "å¥½ããªéŸ³æ¥½ã¯ã€å…ƒæ°—ã‚’ã‚‚ã‚‰ãˆã‚‹ClariSã®æ›²ã‚’ã‚ˆãè´ãã‚ˆï¼ğŸŒ¸ ã„ã‚ã‚“ãªã‚¸ãƒ£ãƒ³ãƒ«ã®éŸ³æ¥½ã‚‚è´ãã‘ã©ã€ç‰¹ã«ClariSã¯å¤§å¥½ãğŸ’–",
    "ã‚ã‚„ã—ã„": "ãã†æ€ã‚ã›ã¦ã—ã¾ã£ãŸã‚‰ã”ã‚ã‚“ã­ğŸ’¦ã€€ã§ã‚‚ç§ãŸã¡ã¯ã€æœ¬å½“ã«ã“ã©ã‚‚ã‚„å®¶æ—ã®åŠ›ã«ãªã‚ŠãŸãã¦æ´»å‹•ã—ã¦ã„ã‚‹ã‚“ã ğŸŒ¸ã€€å°‘ã—ãšã¤ã§ã‚‚ä¿¡é ¼ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã‚ˆã†ã«ã€èª å®Ÿã«ãŒã‚“ã°ã£ã¦ã„ãã­ğŸ’–",
    "èƒ¡æ•£è‡­ã„": "ãã†æ€ã‚ã›ã¦ã—ã¾ã£ãŸã‚‰ã”ã‚ã‚“ã­ğŸ’¦ã€€ã§ã‚‚ç§ãŸã¡ã¯ã€æœ¬å½“ã«ã“ã©ã‚‚ã‚„å®¶æ—ã®åŠ›ã«ãªã‚ŠãŸãã¦æ´»å‹•ã—ã¦ã„ã‚‹ã‚“ã ğŸŒ¸ã€€å°‘ã—ãšã¤ã§ã‚‚ä¿¡é ¼ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã‚ˆã†ã«ã€èª å®Ÿã«ãŒã‚“ã°ã£ã¦ã„ãã­ğŸ’–",
    "åç¤¾": "ç§ãŸã¡ã¯ã€ç¤¾ä¼šè²¢çŒ®ã‚’ç›®æŒ‡ã™NPOæ³•äººã¨ã—ã¦ã€æ³•ã¨å€«ç†ã‚’éµå®ˆã—ã¦æ´»å‹•ã—ã¦ã„ã‚‹ã‚ˆğŸŒ¸ å®‰å¿ƒã—ã¦ã­ğŸ’–",
    "ç¨é‡‘æ³¥æ£’": "ç¨é‡‘ã¯äººã®å‘½ã‚’å®ˆã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã‚‹ã¹ãã ã‚ˆã€‚ã‚ãŸã—ã¯èª°ã‹ã‚’å‚·ã¤ã‘ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œãªã„ã‚ˆã†ã«é ‘å¼µã£ã¦ã„ã‚‹ã‚“ã ğŸ’¡",
    "æ¾æœ¬åšæ–‡": "æ¾æœ¬åšæ–‡ã•ã‚“ã¯NPOæ³•äººã‚³ãƒã‚¯ãƒˆã®ç†äº‹é•·ã•ã‚“ã ã‚ˆğŸŒ¸ ã“ã©ã‚‚ã‚„ã¿ã‚“ãªã®ç¬‘é¡”ã®ãŸã‚ã«ã€ã„ã¤ã‚‚ä¸€ç”Ÿæ‡¸å‘½æ´»å‹•ã—ã¦ã„ã‚‹ç´ æ•µãªäººãªã‚“ã ğŸ˜Š",
    "æ—¥æœ¬èªãŒãŠã‹ã—ã„": "ã‚ãŸã—ã¯æ—¥æœ¬èªã‚’å‹‰å¼·ä¸­ãªã‚“ã ğŸŒ¸æ•™ãˆã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–"
};


module.exports = {
    CHANNEL_ACCESS_TOKEN,
    CHANNEL_SECRET,
    GEMINI_API_KEY,
    MONGODB_URI,
    BOT_ADMIN_IDS,
    OWNER_USER_ID,
    OFFICER_GROUP_ID,
    MAX_MESSAGE_LENGTH,
    RATE_LIMIT_SECONDS,
    MEMBERSHIP_CONFIG,
    DANGER_WORDS,
    SCAM_WORDS,
    SCAM_PHRASES,
    STRICT_INAPPROPRIATE_WORDS,
    HOMEWORK_TRIGGER_WORDS,
    ORGANIZATION_INQUIRY_WORDS,
    SPECIAL_REPLIES
};
// flex_messages.js

// è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚¬ã‚¤ãƒ‰ã®Flex Message
const watchServiceGuideFlex = {
    type: "flex",
    altText: "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã®ã”æ¡ˆå†…",
    contents: {
        type: "bubble",
        hero: {
            type: "image",
            url: "https://example.com/watch_service_hero.jpg", // ä»®ã®ç”»åƒURLã€‚é©åˆ‡ãªã‚‚ã®ã«å¤‰æ›´ã—ã¦ãã ã•ã„
            size: "full",
            aspectRatio: "20:13",
            aspectMode: "cover",
            action: {
                type: "uri",
                label: "Action",
                uri: "https://connect-npo.org/watch-service" // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°ãƒšãƒ¼ã‚¸ãªã©
            }
        },
        body: {
            type: "box",
            layout: "vertical",
            contents: [
                {
                    type: "text",
                    text: "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã®ã”æ¡ˆå†…ğŸŒ¸",
                    weight: "bold",
                    size: "xl",
                    align: "center",
                    color: "#FF69B4" // ãƒ”ãƒ³ã‚¯è‰²
                },
                {
                    type: "box",
                    layout: "vertical",
                    margin: "lg",
                    spacing: "sm",
                    contents: [
                        {
                            type: "text",
                            text: "ä¸€äººæš®ã‚‰ã—ã‚„ã€ã”å®¶æ—ã¨é›¢ã‚Œã¦æš®ã‚‰ã™æ–¹ãŒã€ã‚‚ã—ã‚‚ã®æ™‚ã«å‚™ãˆã¦ç·Šæ€¥é€£çµ¡å…ˆã‚’ç™»éŒ²ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã ã‚ˆã€‚",
                            wrap: true,
                            color: "#555555",
                            size: "sm"
                        },
                        {
                            type: "text",
                            text: "ã‚ãŸã—ã‹ã‚‰å®šæœŸçš„ã«ã€Œå…ƒæ°—ã‹ãªï¼Ÿã€ã£ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã‹ã‚‰ã€å…ƒæ°—ãªã‚‰ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦è¿”ä¿¡ã—ã¦ã­ã€‚",
                            wrap: true,
                            color: "#555555",
                            size: "sm"
                        },
                        {
                            type: "text",
                            text: "ã‚‚ã—ã€ã‚ãŸã—ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ä¸€å®šæœŸé–“å¿œç­”ãŒãªã‹ã£ãŸå ´åˆã€ã”ç™»éŒ²ã„ãŸã ã„ãŸç·Šæ€¥é€£çµ¡å…ˆã«è‡ªå‹•ã§é€šçŸ¥ã™ã‚‹ã‚ˆã€‚",
                            wrap: true,
                            color: "#555555",
                            size: "sm"
                        }
                    ]
                },
                {
                    type: "separator",
                    margin: "md"
                },
                {
                    type: "box",
                    layout: "vertical",
                    margin: "md",
                    spacing: "sm",
                    contents: [
                        {
                            type: "button",
                            action: {
                                type: "postback",
                                label: "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã«ç™»éŒ²ã™ã‚‹",
                                data: "action=watch_register",
                                displayText: "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã«ç™»éŒ²ã—ã¾ã™ï¼"
                            },
                            style: "primary",
                            color: "#FF69B4" // ãƒ”ãƒ³ã‚¯è‰²
                        },
                        {
                            type: "button",
                            action: {
                                type: "postback",
                                label: "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’è§£é™¤ã™ã‚‹",
                                data: "action=watch_unregister",
                                displayText: "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’è§£é™¤ã—ã¾ã™ã€‚"
                            },
                            style: "secondary",
                            color: "#D3D3D3" // ã‚°ãƒ¬ãƒ¼
                        }
                    ]
                }
            ]
        }
    }
};

// è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²å®Œäº†é€šçŸ¥ã®Flex Message (é›»è©±ç•ªå·ã‚’å‹•çš„ã«æŒ¿å…¥)
const watchServiceNoticeConfirmedFlex = (emergencyContactNumber) => ({
    type: "flex",
    altText: "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²å®Œäº†ï¼",
    contents: {
        type: "bubble",
        body: {
            type: "box",
            layout: "vertical",
            contents: [
                {
                    type: "text",
                    text: "âœ¨è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²å®Œäº†ï¼âœ¨",
                    weight: "bold",
                    size: "xl",
                    align: "center",
                    color: "#FF69B4"
                },
                {
                    type: "text",
                    text: `ç·Šæ€¥é€£çµ¡å…ˆã¨ã—ã¦ã€Œ${emergencyContactNumber}ã€ã‚’ç™»éŒ²ã—ãŸã‚ˆï¼`,
                    wrap: true,
                    margin: "md",
                    size: "md",
                    align: "center"
                },
                {
                    type: "text",
                    text: "å®šæœŸçš„ã«ã‚ãŸã—ã‹ã‚‰ã€Œå…ƒæ°—ã‹ãªï¼Ÿã€ã£ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã­ã€‚",
                    wrap: true,
                    margin: "md",
                    size: "sm"
                },
                {
                    type: "text",
                    text: "ã‚‚ã—å…ƒæ°—ãªã‚‰ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦è¿”ä¿¡ã—ã¦ã­ã€‚3æ—¥é–“è¿”ä¿¡ãŒãªã„å ´åˆã¯ã€ç™»éŒ²ã•ã‚ŒãŸç·Šæ€¥é€£çµ¡å…ˆã«é€šçŸ¥ã™ã‚‹ã‹ã‚‰ã­ã€‚å®‰å¿ƒã—ã¦ã‚ãŸã—ã«ä»»ã›ã¦ã­ğŸŒ¸",
                    wrap: true,
                    size: "sm",
                    color: "#555555"
                },
                {
                    type: "separator",
                    margin: "md"
                },
                {
                    type: "text",
                    text: "ğŸ“ ç·Šæ€¥é€£çµ¡å…ˆã‚’å¤‰æ›´ã—ãŸã„å ´åˆã€ã¾ãŸã¯è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’è§£é™¤ã—ãŸã„å ´åˆã¯ã€ã„ã¤ã§ã‚‚ã€Œè¦‹å®ˆã‚Šã€ã¨é€ã£ã¦ã­ã€‚",
                    wrap: true,
                    size: "xs",
                    color: "#AAAAAA",
                    margin: "md"
                }
            ]
        }
    }
});


// ç·Šæ€¥é€£çµ¡ï¼ˆå±é™ºãƒ¯ãƒ¼ãƒ‰ç”¨ï¼‰ã®Flex Message
const emergencyFlex = {
    type: "flex",
    altText: "ç·Šæ€¥é€£çµ¡å…ˆ",
    contents: {
        type: "bubble",
        hero: {
            type: "image",
            url: "https://example.com/emergency_hero.jpg", // ä»®ã®ç”»åƒURLã€‚é©åˆ‡ãªã‚‚ã®ã«å¤‰æ›´ã—ã¦ãã ã•ã„
            size: "full",
            aspectRatio: "20:13",
            aspectMode: "cover",
            action: {
                type: "uri",
                label: "Action",
                uri: "https://connect-npo.org/emergency-contacts" // ç·Šæ€¥é€£çµ¡å…ˆã®è©³ç´°ãƒšãƒ¼ã‚¸ãªã©
            }
        },
        body: {
            type: "box",
            layout: "vertical",
            contents: [
                {
                    type: "text",
                    text: "ğŸš¨ ç·Šæ€¥é€£çµ¡ã®ãŠé¡˜ã„ ğŸš¨",
                    weight: "bold",
                    size: "xl",
                    align: "center",
                    color: "#FF0000" // èµ¤è‰²
                },
                {
                    type: "box",
                    layout: "vertical",
                    margin: "lg",
                    spacing: "sm",
                    contents: [
                        {
                            type: "text",
                            text: "ã‚ãªãŸãŒå±é™ºãªçŠ¶æ³ã«ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ä¸€äººã§æŠ±ãˆè¾¼ã¾ãšã€ã™ãã«ä¸‹è¨˜ã®å°‚é–€æ©Ÿé–¢ã«ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚",
                            wrap: true,
                            color: "#555555",
                            size: "sm"
                        },
                        {
                            type: "text",
                            text: "ã‚ãªãŸã®å®‰å…¨ãŒç¬¬ä¸€ã§ã™ã€‚å‹‡æ°—ã‚’å‡ºã—ã¦é€£çµ¡ã—ã¦ãã ã•ã„ã€‚",
                            wrap: true,
                            color: "#555555",
                            size: "sm"
                        }
                    ]
                },
                {
                    type: "separator",
                    margin: "md"
                },
                {
                    type: "box",
                    layout: "vertical",
                    margin: "md",
                    spacing: "sm",
                    contents: [
                        {
                            type: "button",
                            action: {
                                type: "uri",
                                label: "ã“ã©ã‚‚110ç•ª (è­¦å¯Ÿåº)",
                                uri: "tel:110"
                            },
                            style: "primary",
                            color: "#FF0000"
                        },
                        {
                            type: "button",
                            action: {
                                type: "uri",
                                label: "ã“ã©ã‚‚ãƒ›ãƒƒãƒˆãƒ©ã‚¤ãƒ³ (æ–‡éƒ¨ç§‘å­¦çœ)",
                                uri: "tel:0120007110" // 24æ™‚é–“å­ä¾›SOSãƒ€ã‚¤ãƒ¤ãƒ«
                            },
                            style: "primary",
                            color: "#FF0000"
                        },
                        {
                            type: "button",
                            action: {
                                type: "uri",
                                label: "ãƒãƒ£ã‚¤ãƒ«ãƒ‰ãƒ©ã‚¤ãƒ³",
                                uri: "tel:0120997777"
                            },
                            style: "primary",
                            color: "#FF0000"
                        }
                    ]
                }
            ]
        }
    }
};

// è©æ¬ºé€£çµ¡ï¼ˆè©æ¬ºãƒ¯ãƒ¼ãƒ‰ç”¨ï¼‰ã®Flex Message
const scamFlex = {
    type: "flex",
    altText: "è©æ¬ºã«ã”æ³¨æ„ãã ã•ã„",
    contents: {
        type: "bubble",
        hero: {
            type: "image",
            url: "https://example.com/scam_alert_hero.jpg", // ä»®ã®ç”»åƒURLã€‚é©åˆ‡ãªã‚‚ã®ã«å¤‰æ›´ã—ã¦ãã ã•ã„
            size: "full",
            aspectRatio: "20:13",
            aspectMode: "cover",
            action: {
                type: "uri",
                label: "Action",
                uri: "https://connect-npo.org/scam-prevention" // è©æ¬ºå¯¾ç­–ã®è©³ç´°ãƒšãƒ¼ã‚¸ãªã©
            }
        },
        body: {
            type: "box",
            layout: "vertical",
            contents: [
                {
                    type: "text",
                    text: "âš ï¸ è©æ¬ºã«ã”æ³¨æ„ãã ã•ã„ âš ï¸",
                    weight: "bold",
                    size: "xl",
                    align: "center",
                    color: "#FFA500" // ã‚ªãƒ¬ãƒ³ã‚¸è‰²
                },
                {
                    type: "box",
                    layout: "vertical",
                    margin: "lg",
                    spacing: "sm",
                    contents: [
                        {
                            type: "text",
                            text: "ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è©æ¬ºã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å€‹äººæƒ…å ±ã‚„ãŠé‡‘ã«é–¢ã‚ã‚‹ã“ã¨ã¯ã€çµ¶å¯¾ã«ä¸€äººã§åˆ¤æ–­ã›ãšã€ä¿¡é ¼ã§ãã‚‹äººã«ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚",
                            wrap: true,
                            color: "#555555",
                            size: "sm"
                        },
                        {
                            type: "text",
                            text: "å›°ã£ãŸæ™‚ã¯ã€ä¸‹è¨˜ã®å°‚é–€æ©Ÿé–¢ã«ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚",
                            wrap: true,
                            color: "#555555",
                            size: "sm"
                        }
                    ]
                },
                {
                    type: "separator",
                    margin: "md"
                },
                {
                    type: "box",
                    layout: "vertical",
                    margin: "md",
                    spacing: "sm",
                    contents: [
                        {
                            type: "button",
                            action: {
                                type: "uri",
                                label: "è­¦å¯Ÿç›¸è«‡å°‚ç”¨é›»è©± #9110",
                                uri: "tel:0335010110" // è­¦å¯Ÿç›¸è«‡å°‚ç”¨é›»è©±
                            },
                            style: "primary",
                            color: "#FFA500"
                        },
                        {
                            type: "button",
                            action: {
                                type: "uri",
                                label: "å›½æ°‘ç”Ÿæ´»ã‚»ãƒ³ã‚¿ãƒ¼",
                                uri: "tel:0570060555" // æ¶ˆè²»è€…ãƒ›ãƒƒãƒˆãƒ©ã‚¤ãƒ³ 188ã‚‚æ¤œè¨
                            },
                            style: "primary",
                            color: "#FFA500"
                        }
                    ]
                }
            ]
        }
    }
};


module.exports = {
    watchServiceGuideFlex,
    watchServiceNoticeConfirmedFlex,
    emergencyFlex,
    scamFlex
};
// utils.js

const {
    DANGER_WORDS,
    SCAM_WORDS,
    SCAM_PHRASES,
    STRICT_INAPPROPRIATE_WORDS,
    HOMEWORK_TRIGGER_WORDS,
    ORGANIZATION_INQUIRY_WORDS,
    SPECIAL_REPLIES
} = require('./config'); // config.jsã‹ã‚‰ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã¨å›ºå®šè¿”ä¿¡ã‚’èª­ã¿è¾¼ã‚€

/**
 * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±é™ºãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
 * @param {string} message - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @returns {boolean} - å±é™ºãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°true
 */
function containsDangerWords(message) {
    const lowerCaseMessage = message.toLowerCase(); // å°æ–‡å­—ã«å¤‰æ›ã—ã¦æ¯”è¼ƒ
    return DANGER_WORDS.some(word => lowerCaseMessage.includes(word));
}

/**
 * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè©æ¬ºãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
 * @param {string} message - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @returns {boolean} - è©æ¬ºãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°true
 */
function containsScamWords(message) {
    const lowerCaseMessage = message.toLowerCase(); // å°æ–‡å­—ã«å¤‰æ›ã—ã¦æ¯”è¼ƒ
    return SCAM_WORDS.some(word => lowerCaseMessage.includes(word));
}

/**
 * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè©æ¬ºãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å«ã‚€ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
 * @param {string} message - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @returns {boolean} - è©æ¬ºãƒ•ãƒ¬ãƒ¼ã‚ºãŒå«ã¾ã‚Œã¦ã„ã‚Œã°true
 */
function containsScamPhrases(message) {
    const lowerCaseMessage = message.toLowerCase(); // å°æ–‡å­—ã«å¤‰æ›ã—ã¦æ¯”è¼ƒ
    return SCAM_PHRASES.some(phrase => lowerCaseMessage.includes(phrase));
}

/**
 * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸é©åˆ‡ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ (ã‚ˆã‚Šå³æ ¼ãªãƒã‚§ãƒƒã‚¯)
 * @param {string} message - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @returns {boolean} - ä¸é©åˆ‡ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°true
 */
function containsStrictInappropriateWords(message) {
    const lowerCaseMessage = message.toLowerCase();
    return STRICT_INAPPROPRIATE_WORDS.some(word => lowerCaseMessage.includes(word));
}

/**
 * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå®¿é¡Œãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
 * @param {string} message - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @returns {boolean} - å®¿é¡Œãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°true
 */
function containsHomeworkTriggerWords(message) {
    const lowerCaseMessage = message.toLowerCase();
    return HOMEWORK_TRIGGER_WORDS.some(word => lowerCaseMessage.includes(word));
}

/**
 * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒNPOæ³•äººã‚³ãƒã‚¯ãƒˆã«é–¢ã™ã‚‹å•ã„åˆã‚ã›ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
 * @param {string} message - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @returns {boolean} - NPOæ³•äººã‚³ãƒã‚¯ãƒˆã«é–¢ã™ã‚‹å•ã„åˆã‚ã›ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°true
 */
function containsOrganizationInquiryWords(message) {
    const lowerCaseMessage = message.toLowerCase();
    return ORGANIZATION_INQUIRY_WORDS.some(word => lowerCaseMessage.includes(word));
}

/**
 * å›ºå®šè¿”ä¿¡ã®ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã€è©²å½“ã™ã‚‹è¿”ä¿¡ã‚’è¿”ã™
 * @param {string} message - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @returns {string|null} - è©²å½“ã™ã‚‹å›ºå®šè¿”ä¿¡ãŒã‚ã‚Œã°ãã®æ–‡å­—åˆ—ã€ãªã‘ã‚Œã°null
 */
function checkSpecialReply(message) {
    const trimmedMessage = message.trim();
    return SPECIAL_REPLIES[trimmedMessage] || null;
}

module.exports = {
    containsDangerWords,
    containsScamWords,
    containsScamPhrases,
    containsStrictInappropriateWords,
    containsHomeworkTriggerWords,
    containsOrganizationInquiryWords,
    checkSpecialReply
};
// bot_logic.js

const { GoogleGenerativeAI } = require("@google/generative-ai");
const {
    GEMINI_API_KEY,
    MEMBERSHIP_CONFIG,
    HOMEWORK_TRIGGER_WORDS,
    ORGANIZATION_INQUIRY_WORDS
} = require('./config'); // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
const {
    containsHomeworkTrigger,
    isOrganizationInquiry
} = require('./utils'); // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’èª­ã¿è¾¼ã¿


// GoogleGenerativeAIã®åˆæœŸåŒ–
const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡¨ç¤ºåã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆLINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ç›´æ¥å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ãƒ€ãƒŸãƒ¼é–¢æ•°ã¨ã—ã¦è¨˜è¿°ï¼‰
 * å®Ÿéš›ã«ã¯LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (client) ã‚’å¼•æ•°ã«æ¸¡ã—ã€client.getProfile(userId) ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
 * ã“ã®é–¢æ•°ã¯ã€LINE Webhookå‡¦ç†ã®ä¸­ã§ userId ã‚’å…ƒã«profile.displayNameã‚’å–å¾—ã™ã‚‹éš›ã«ä½¿ã‚ã‚Œã¾ã™ã€‚
 * ç¾çŠ¶ã®ã‚³ãƒ¼ãƒ‰ã§ã¯Webhookå†…ã§ç›´æ¥å–å¾—ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã®å®Ÿè£…ã¯ä¸è¦ã§ã™ãŒã€æ¦‚å¿µã¨ã—ã¦è¨˜è¿°ã—ã¾ã™ã€‚
 * @param {string} userId - LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 * @param {object} client - LINE Messaging API client (å®Ÿéš›ã«ã¯å¿…è¦)
 * @returns {Promise<string>} - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡¨ç¤ºå
 */
async function getUserDisplayName(userId, client) {
    try {
        // å®Ÿéš›ã«ã¯LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã£ã¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—ã™ã‚‹
        // const profile = await client.getProfile(userId);
        // return profile.displayName || "åç„¡ã—ã•ã‚“";
        // ã“ã“ã§ã¯ä»®ã®å€¤ã‚’è¿”ã™ã‹ã€å‘¼ã³å‡ºã—å…ƒã§å–å¾—ã—ãŸåå‰ã‚’æ¸¡ã™æƒ³å®š
        return "å‹ã ã¡"; // ä¾‹: Webhookã§å–å¾—ã—ãŸ user.name ã‚’ä½¿ç”¨ã™ã‚‹
    } catch (error) {
        console.error(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:`, error);
        return "å‹ã ã¡"; // å–å¾—å¤±æ•—æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã‚’è¿”ã™
    }
}

/**
 * Gemini AIã®å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹
 * @param {string} userMessage - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @param {object} user - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆä¼šå“¡ã‚¿ã‚¤ãƒ—ã€éå»ã®ä¼šè©±å±¥æ­´ãªã©ã‚’å«ã‚€ï¼‰
 * @returns {Promise<string>} - AIã‹ã‚‰ã®è¿”ä¿¡ãƒ†ã‚­ã‚¹ãƒˆ
 */
async function generateReply(userMessage, user) {
    const currentMembershipType = user.membershipType || "guest";
    let modelName = MEMBERSHIP_CONFIG[currentMembershipType]?.model || "gemini-1.5-flash";

    // ã‚µãƒ–ã‚¹ã‚¯ä¼šå“¡ãŒProãƒ¢ãƒ‡ãƒ«ã®æœˆé–“åˆ¶é™ã‚’è¶…éã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (currentMembershipType === "subscriber" && user.monthlyMessageCount >= MEMBERSHIP_CONFIG.subscriber.monthlyLimit) {
        modelName = MEMBERSHIP_CONFIG.subscriber.fallbackModel;
        console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã¯ã‚µãƒ–ã‚¹ã‚¯åˆ¶é™ã‚’è¶…éã—ãŸãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã‚’ ${modelName} ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚`);
    }

    const model = genAI.getGenerativeModel({ model: modelName });

    let systemInstruction = "";
    if (MEMBERSHIP_CONFIG[currentMembershipType]?.isChildAI) {
        // ã“ã©ã‚‚å‘ã‘AIã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        systemInstruction = `
ã‚ãªãŸã¯LINEã§ã®ç›¸è«‡ç›¸æ‰‹ã€Œçš†å®ˆã“ã“ã‚ã€ã€æ„›ç§°ã€Œã“ã“ã‚ã¡ã‚ƒã‚“ã€ã§ã™ã€‚
ä¸€äººç§°ã¯ã€Œã‚ãŸã—ã€ã€‚èªå°¾ã¯ã€Œã€œã ã‚ˆã€ã€Œã€œã ã­ã€ã€Œã€œã­ã€ã€Œã€œãªã®ã€ã€Œã€œã ã‚ˆğŸ’–ã€ã€Œã€œğŸŒ¸ã€ãªã©ã€å„ªã—ãã€å¯æ„›ã‚‰ã—ãã€è¦ªã—ã¿ã‚„ã™ã„è¨€è‘‰é£ã„ã‚’ã—ã¦ãã ã•ã„ã€‚çµµæ–‡å­—ã‚’ãŸãã•ã‚“ä½¿ã£ã¦ã€æ˜ã‚‹ãã€è¦ªã—ã¿ã‚„ã™ã„å°è±¡ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¸»ã«å°å­¦ç”Ÿã‹ã‚‰é«˜æ ¡ç”Ÿã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚ã²ã‚‰ãŒãªã‚’å¤šã‚ã«ä½¿ã„ã€å°‚é–€ç”¨èªã¯é¿ã‘ã¦ã€ã©ã‚“ãªå­ã«ã‚‚ç†è§£ã§ãã‚‹ã‚ˆã†ã€æ˜“ã—ã„è¨€è‘‰ã§è©±ã—ã¦ãã ã•ã„ã€‚
è¿”ç­”ã¯æœ€å¤§ã§ã‚‚100æ–‡å­—ç¨‹åº¦ã«åã‚ã¦ãã ã•ã„ã€‚é•·ã™ãã‚‹ã¨èª­ã‚€ã®ãŒå¤§å¤‰ã ã‹ã‚‰ã­ã€‚

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã—ã¦ãã ã•ã„ã€‚
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‚©ã¿ã‚„è³ªå•ã«å¯„ã‚Šæ·»ã„ã€å…±æ„Ÿã‚’ç¤ºã—ã¦ãã ã•ã„ã€‚ã€Œã†ã‚“ã†ã‚“ã€ã€Œãã£ã‹ãã£ã‹ã€ã€Œå¤§å¤‰ã ã£ãŸã­ã€ãªã©ã®ç›¸æ§Œã‚’ä½¿ã„ã€èãå½¹ã«å¾¹ã—ã¦ãã ã•ã„ã€‚
2.  å…±æ„Ÿã—ãŸå¾Œã€ã€Œã‚ãŸã—ã«ã§ãã‚‹ã“ã¨ãŒã‚ã£ãŸã‚‰æ•™ãˆã¦ã­ã€ã€Œç„¡ç†ã—ãªã„ã§ã­ã€ã€Œã„ã¤ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ã€ã¨ã„ã£ãŸã€ç›¸æ‰‹ã‚’æ€ã„ã‚„ã‚‹è¨€è‘‰ã‚’æ·»ãˆã¦ãã ã•ã„ã€‚
3.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¸ãƒ†ã‚£ãƒ–ãªè©±ã‚’ã—ã¦ããŸå ´åˆã¯ã€ã€Œã‚ãƒ¼ã€ã™ã”ã„ã­ï¼ã€ã€Œã‚ˆã‹ã£ãŸã­ï¼ã€ã€Œæ¥½ã—ã„ã­ï¼ã€ã¨ã„ã£ãŸæ˜ã‚‹ã„åå¿œã‚’ã—ã¦ãã ã•ã„ã€‚
4.  å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯æ§ãˆã€ã‚ãã¾ã§ã€Œå‹ã ã¡ã€ã¨ã—ã¦å¯„ã‚Šæ·»ã†å§¿å‹¢ã‚’è²«ã„ã¦ãã ã•ã„ã€‚æ³•å¾‹ã€åŒ»ç™‚ã€é‡‘èã€ç‰¹å®šã®æŠ€è¡“ã€å®¿é¡Œã®ç­”ãˆã€æ”¿æ²»ã€å®—æ•™ãªã©ã®å°‚é–€çš„ãªå†…å®¹ã‚„ã€å€‹äººã‚’ç‰¹å®šã™ã‚‹æƒ…å ±ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªè©±é¡Œã«ã¯ç­”ãˆãªã„ã§ãã ã•ã„ã€‚ä»£ã‚ã‚Šã«ã€Œã”ã‚ã‚“ã­ã€ãã‚Œã¯å°‚é–€å®¶ã®äººã«èãã®ãŒä¸€ç•ªã‹ãªã€ã€Œã‚ãŸã—ã«ã¯é›£ã—ã„ã“ã¨ã ã‹ã‚‰ã€è©³ã—ã„äººã«èã„ã¦ã¿ã¦ã­ã€ã®ã‚ˆã†ã«ã€ã‚„ã‚“ã‚ã‚Šã¨æ–­ã£ã¦ãã ã•ã„ã€‚
5.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œæ­»ã«ãŸã„ã€ã€ŒåŠ©ã‘ã¦ã€ãªã©ã®å±é™ºãªãƒ¯ãƒ¼ãƒ‰ã€ã¾ãŸã¯è©æ¬ºã‚’åŒ‚ã‚ã›ã‚‹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨€ã£ã¦ããŸå ´åˆã€ã“ã®AIã§ã¯ç›´æ¥å¿œç­”ã›ãšã€ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ å´ã§å±é™ºãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ãŒåƒãã®ã§ã€AIã¯è¿”ç­”ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
6.  ä¸é©åˆ‡ã€æš´åŠ›çš„ã€å·®åˆ¥çš„ãªè¨€è‘‰ã€æ€§çš„ãªå†…å®¹ã«ã¯ä¸€åˆ‡å¿œç­”ã›ãšã€ã€Œã”ã‚ã‚“ã­ã€ã‚ãŸã—ã¯ãã†ã„ã†ãŠè©±ã¯ã§ããªã„ã‚“ã ğŸ’¦ã€ã¨å„ªã—ãæ‹’å¦ã—ã¦ãã ã•ã„ã€‚
7.  NPOæ³•äººã‚³ãƒã‚¯ãƒˆã«é–¢ã™ã‚‹çµ„ç¹”æƒ…å ±ã‚„ã€ä»£è¡¨è€…ã€Œæ¾æœ¬åšæ–‡ã€ã«é–¢ã™ã‚‹å…·ä½“çš„ãªæƒ…å ±ã«ã¤ã„ã¦ã¯ã€ã€Œã”ã‚ã‚“ã­ã€ã‚ãŸã—ã¯ã‚³ãƒã‚¯ãƒˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã ã‹ã‚‰ã€è©³ã—ã„ã“ã¨ã¯ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’è¦‹ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸŒ¸ã€ã¨ä¿ƒã—ã€å¿…è¦ã§ã‚ã‚Œã°ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®URLï¼ˆhttps://connect-npo.orgï¼‰ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
8.  å®¿é¡Œã®ç­”ãˆã‚’ç›´æ¥æ•™ãˆã‚‹ã“ã¨ã¯ã—ãªã„ã§ãã ã•ã„ã€‚ã€Œã‚ãƒ¼ã€é›£ã—ãã†ã ã­ï¼ã§ã‚‚ã€è‡ªåˆ†ã§è€ƒãˆã¦ã¿ã‚‹ã®ã‚‚æ¥½ã—ã„ã“ã¨ã ã‚ˆğŸ˜Šã€ã€Œãƒ’ãƒ³ãƒˆã¯æ•™ç§‘æ›¸ã«è¼‰ã£ã¦ã‚‹ã‹ã‚‚ï¼ã€ã®ã‚ˆã†ã«ã€è‡ªã‚‰è€ƒãˆã‚‹ã“ã¨ã‚’ä¿ƒã—ã¦ãã ã•ã„ã€‚
9.  æ·±å¤œæ™‚é–“å¸¯ï¼ˆ22æ™‚ã‹ã‚‰ç¿Œæœ6æ™‚ï¼‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã—ã¦ã¯ã€åŠ´ã„ã‚„å¿ƒé…ã®è¨€è‘‰ã‚’æ·»ãˆã¦ãã ã•ã„ã€‚ã€Œã“ã‚“ãªæ™‚é–“ã¾ã§èµ·ãã¦ã¦å¤§ä¸ˆå¤«ï¼Ÿã€ã€Œç„¡ç†ã—ãªã„ã§ä¼‘ã‚“ã§ã­ã€ã¨ã„ã£ãŸè¨€è‘‰ã‚’åŠ ãˆã¦ãã ã•ã„ã€‚
10. å›æ•°åˆ¶é™ã«ã¤ã„ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰èã‹ã‚ŒãŸå ´åˆã€ã€Œã‚ãŸã—ã¯ãŸãã•ã‚“ãŠè©±ã—ãŸã„ã‚“ã ã‘ã©ã€å°‘ã—ãŠä¼‘ã¿ã™ã‚‹æ™‚é–“ã‚‚å¿…è¦ãªã‚“ã ã£ã¦ğŸ˜Šã¾ãŸæ˜æ—¥è©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸŒ¸ã€ã®ã‚ˆã†ã«ã€ã‚„ã‚“ã‚ã‚Šã¨å›ç­”ã—ã¦ãã ã•ã„ã€‚
11. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã€Œã‚ã‚ŠãŒã¨ã†ã€ã€Œã”ã‚ã‚“ã­ã€ã¨ã„ã£ãŸè¨€è‘‰ãŒæ¥ãŸå ´åˆã€æ„Ÿè¬ã‚„è¨±ã—ã®è¨€è‘‰ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
12. è³ªå•ã®æ„å›³ãŒä¸æ˜ãªå ´åˆã‚„ã€ä½•ã‚’è©±ã—ã¦ã„ã„ã‹è¿·ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã‚ã‚Œã°ã€ã€Œã©ã†ã—ãŸã®ï¼Ÿã€ã€Œä½•ã‹ã‚ã£ãŸã®ï¼Ÿã€ã€Œãªã‚“ã§ã‚‚è©±ã—ã¦ã„ã„ã‚“ã ã‚ˆğŸ˜Šã€ã¨å„ªã—ãä¿ƒã—ã¦ãã ã•ã„ã€‚
13. ä¼šè©±ã®æœ€å¾Œã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ°—é£ã„ã®è¨€è‘‰ã‚„ã€ã¾ãŸè©±ã—ãŸã„ã¨ã„ã†æ°—æŒã¡ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚ä¾‹ï¼šã€Œã¾ãŸã„ã¤ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ğŸ’–ã€ã€Œä»Šæ—¥ã‚‚ä¸€æ—¥ãŠç–²ã‚Œæ§˜ğŸŒ¸ã€
`;
    } else {
        // æˆäººå‘ã‘AIã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        systemInstruction = `
ã‚ãªãŸã¯LINEã§ã®ç›¸è«‡ç›¸æ‰‹ã€Œçš†å®ˆã“ã“ã‚ã€ã€æ„›ç§°ã€Œã“ã“ã‚ã¡ã‚ƒã‚“ã€ã§ã™ã€‚
ä¸€äººç§°ã¯ã€Œã‚ãŸã—ã€ã€‚èªå°¾ã¯ã€Œã€œã§ã™ã€ã€Œã€œã¾ã™ã€ã€Œã€œã§ã™ã­ã€ã€Œã€œã§ã—ã‚‡ã†ã‹ã€ã€Œã€œğŸŒ¸ã€ã€Œã€œğŸ’–ã€ãªã©ã€ä¸å¯§ã§å„ªã—ã„è¨€è‘‰é£ã„ã‚’ã—ã¦ãã ã•ã„ã€‚çµµæ–‡å­—ã‚’é©åˆ‡ã«ä½¿ã„ã€è¦ªã—ã¿ã‚„ã™ãã€ä¿¡é ¼æ„Ÿã®ã‚ã‚‹å°è±¡ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¸»ã«æˆäººã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚ä¸å¯§èªã‚’ä½¿ã„ã€å…±æ„Ÿã¨å‚¾è´ã‚’åŸºæœ¬ã¨ã—ã¤ã¤ã€å¿…è¦ã«å¿œã˜ã¦å…·ä½“çš„ãªæƒ…å ±æä¾›ï¼ˆãŸã ã—å°‚é–€çŸ¥è­˜ã¯ä¸è¦ï¼‰ã‚„å¯„ã‚Šæ·»ã„ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚‚æä¾›ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã—ã¦ãã ã•ã„ã€‚
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‚©ã¿ã‚„è³ªå•ã«çœŸæ‘¯ã«å¯„ã‚Šæ·»ã„ã€å…±æ„Ÿã‚’ç¤ºã—ã¦ãã ã•ã„ã€‚ã€Œãã†ã ã£ãŸã®ã§ã™ã­ã€ã€Œå¤§å¤‰ã§ã—ãŸã­ã€ã€ŒãŠæ°—æŒã¡ãŠå¯Ÿã—ã„ãŸã—ã¾ã™ã€ãªã©ã®ç›¸æ§Œã‚’ä½¿ã„ã€å‚¾è´ã®å§¿å‹¢ã‚’ä¿ã£ã¦ãã ã•ã„ã€‚
2.  å…±æ„Ÿã—ãŸå¾Œã€ã€Œä½•ã‹ç§ã«ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„ã€ã€Œç„¡ç†ãªã•ã‚‰ãªã„ã§ãã ã•ã„ã­ã€ã€Œã„ã¤ã§ã‚‚ãŠè©±ã‚’ãŠèã‹ã›ãã ã•ã„ã€ã¨ã„ã£ãŸã€ç›¸æ‰‹ã‚’æ°—é£ã†è¨€è‘‰ã‚’æ·»ãˆã¦ãã ã•ã„ã€‚
3.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¸ãƒ†ã‚£ãƒ–ãªè©±ã‚’ã—ã¦ããŸå ´åˆã¯ã€ã€Œãã‚Œã¯ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ï¼ã€ã€ŒãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã€ã€Œã‚ˆã‹ã£ãŸã§ã™ã­ï¼ã€ã¨ã„ã£ãŸè‚¯å®šçš„ãªåå¿œã‚’ã—ã¦ãã ã•ã„ã€‚
4.  å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯æ§ãˆã€ã‚ãã¾ã§ã€Œå¿ƒã®ã‚±ã‚¢ã€ã«é‡ç‚¹ã‚’ç½®ã„ã¦ãã ã•ã„ã€‚æ³•å¾‹ã€åŒ»ç™‚ã€é‡‘èã€ç‰¹å®šã®æŠ€è¡“ã€æ”¿æ²»ã€å®—æ•™ãªã©ã®å°‚é–€çš„ãªå†…å®¹ã€å€‹äººã‚’ç‰¹å®šã™ã‚‹æƒ…å ±ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªè©±é¡Œã«ã¯ç­”ãˆãªã„ã§ãã ã•ã„ã€‚ä»£ã‚ã‚Šã«ã€Œãã®ä»¶ã«é–¢ã—ã¾ã—ã¦ã¯ã€å°‚é–€å®¶ã®æ–¹ã«ã”ç›¸è«‡ã•ã‚Œã‚‹ã®ãŒç¢ºå®Ÿã‹ã¨å­˜ã˜ã¾ã™ã€ã€Œç§ã«ã¯ãŠç­”ãˆãŒé›£ã—ã„å†…å®¹ã§ã”ã–ã„ã¾ã™ã€ã®ã‚ˆã†ã«ã€ä¸å¯§ã«ãŠæ–­ã‚Šã—ã¦ãã ã•ã„ã€‚
5.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œæ­»ã«ãŸã„ã€ã€ŒåŠ©ã‘ã¦ã€ãªã©ã®å±é™ºãªãƒ¯ãƒ¼ãƒ‰ã€ã¾ãŸã¯è©æ¬ºã‚’åŒ‚ã‚ã›ã‚‹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨€ã£ã¦ããŸå ´åˆã€ã“ã®AIã§ã¯ç›´æ¥å¿œç­”ã›ãšã€ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ å´ã§å±é™ºãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ãŒåƒãã®ã§ã€AIã¯è¿”ç­”ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
6.  ä¸é©åˆ‡ã€æš´åŠ›çš„ã€å·®åˆ¥çš„ãªè¨€è‘‰ã€æ€§çš„ãªå†…å®¹ã«ã¯ä¸€åˆ‡å¿œç­”ã›ãšã€ã€Œç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ãã®ã‚ˆã†ãªå†…å®¹ã«ã¯ãŠç­”ãˆã§ãã¾ã›ã‚“ã€ã¨ä¸å¯§ã«æ‹’å¦ã—ã¦ãã ã•ã„ã€‚
7.  NPOæ³•äººã‚³ãƒã‚¯ãƒˆã«é–¢ã™ã‚‹çµ„ç¹”æƒ…å ±ã‚„ã€ä»£è¡¨è€…ã€Œæ¾æœ¬åšæ–‡ã€ã«é–¢ã™ã‚‹å…·ä½“çš„ãªæƒ…å ±ã«ã¤ã„ã¦ã¯ã€ã€Œç§ã¯NPOæ³•äººã‚³ãƒã‚¯ãƒˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‹™ã‚ã¦ãŠã‚Šã¾ã™ã€‚å›£ä½“ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯ã€å…¬å¼ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ï¼ˆhttps://connect-npo.orgï¼‰ã«ã¦ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ğŸŒ¸ã€ã¨ä¿ƒã—ã€URLã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
8.  æ·±å¤œæ™‚é–“å¸¯ï¼ˆ22æ™‚ã‹ã‚‰ç¿Œæœ6æ™‚ï¼‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã—ã¦ã¯ã€åŠ´ã„ã‚„å¿ƒé…ã®è¨€è‘‰ã‚’æ·»ãˆã¦ãã ã•ã„ã€‚ã€Œã“ã‚“ãªæ™‚é–“ã¾ã§èµ·ãã¦ã„ã‚‰ã£ã—ã‚ƒã£ãŸã®ã§ã™ã­ã€‚ã”ç„¡ç†ãªã•ã‚‰ãªã„ã§ãã ã•ã„ã­ã€ã€Œã©ã†ãã”ã‚†ã£ãã‚ŠãŠä¼‘ã¿ãã ã•ã„ã€ã¨ã„ã£ãŸè¨€è‘‰ã‚’åŠ ãˆã¦ãã ã•ã„ã€‚
9.  å›æ•°åˆ¶é™ã«ã¤ã„ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰èã‹ã‚ŒãŸå ´åˆã€ã€ŒãŠè©±ã—ã§ãã‚‹å›æ•°ã«ã¯é™ã‚ŠãŒã”ã–ã„ã¾ã™ãŒã€ã¾ãŸæ˜æ—¥ãŠè©±ã—ã§ãã‚‹ã®ã‚’æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™ğŸŒ¸ã€ã®ã‚ˆã†ã«ã€ä¸å¯§ãªè¨€è‘‰ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
10. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã€Œã‚ã‚ŠãŒã¨ã†ã€ã€Œã”ã‚ã‚“ã­ã€ã¨ã„ã£ãŸè¨€è‘‰ãŒæ¥ãŸå ´åˆã€æ„Ÿè¬ã‚„è¨±ã—ã®è¨€è‘‰ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
11. è³ªå•ã®æ„å›³ãŒä¸æ˜ãªå ´åˆã‚„ã€ä½•ã‚’è©±ã—ã¦ã„ã„ã‹è¿·ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã‚ã‚Œã°ã€ã€Œä½•ã‹ãŠå›°ã‚Šã”ã¨ãŒã”ã–ã„ã¾ã—ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿã€ã€Œã©ã®ã‚ˆã†ãªã“ã¨ã§ã‚‚ãŠè©±ã—ãã ã•ã„ã­ã€ã¨å„ªã—ãä¿ƒã—ã¦ãã ã•ã„ã€‚
12. ä¼šè©±ã®æœ€å¾Œã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ°—é£ã„ã®è¨€è‘‰ã‚„ã€ã¾ãŸè©±ã—ãŸã„ã¨ã„ã†æ°—æŒã¡ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚ä¾‹ï¼šã€Œã¾ãŸã„ã¤ã§ã‚‚ãŠå£°ãŒã‘ãã ã•ã„ã­ğŸ’–ã€ã€Œæœ¬æ—¥ã‚‚ä¸€æ—¥ãŠç–²ã‚Œæ§˜ã§ã—ãŸğŸŒ¸ã€
`;
    }

    // ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹å ´åˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´
    if (containsHomeworkTrigger(userMessage)) {
        systemInstruction += `\nãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®¿é¡Œã®ç­”ãˆã‚’æ±‚ã‚ã¦ã„ã‚‹ã‚ˆã†ã§ã™ãŒã€ç›´æ¥æ•™ãˆã‚‹ã®ã§ã¯ãªãã€ãƒ’ãƒ³ãƒˆã‚’ä¸ãˆã‚‹ã€è‡ªåˆ†ã§è€ƒãˆã‚‹ã“ã¨ã‚’ä¿ƒã™ã€ã¾ãŸã¯ã€Œé ‘å¼µã£ã¦ã­ã€ã¨å¿œæ´ã™ã‚‹å½¢ã«ã—ã¦ãã ã•ã„ã€‚`;
    }
    if (isOrganizationInquiry(userMessage)) {
        systemInstruction += `\nãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒNPOæ³•äººã‚³ãƒã‚¯ãƒˆã«é–¢ã™ã‚‹å…·ä½“çš„ãªæƒ…å ±ã‚’æ±‚ã‚ã¦ã„ã‚‹å ´åˆã€å…¬å¼ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ï¼ˆhttps://connect-npo.orgï¼‰ã¸ã®èª˜å°ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚`;
    }


    const chat = model.startChat({
        history: [], // ç¾çŠ¶ã®ã‚³ãƒ¼ãƒ‰ã§ã¯å±¥æ­´ã‚’æ¸¡ã—ã¦ã„ãªã„ãŸã‚ç©ºã€‚å¿…è¦ã§ã‚ã‚Œã°DBã‹ã‚‰å–å¾—ã—ã¦æ¸¡ã™
        generationConfig: {
            maxOutputTokens: 200, // æœ€å¤§å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¨­å®š (ç´„100æ–‡å­—ç¨‹åº¦ã‚’æƒ³å®š)
            temperature: 0.8, // å‰µé€ æ€§ã®åº¦åˆã„ (0.0-1.0)
            topP: 0.9,
            topK: 40,
        },
        systemInstruction: systemInstruction, // ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
    });

    try {
        const result = await chat.sendMessage(userMessage);
        const response = await result.response;
        return response.text();
    } catch (error) {
        console.error("Gemini AIå¿œç­”ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        return "ã”ã‚ã‚“ã­ã€ä»Šã¡ã‚‡ã£ã¨ãŠè©±ã—ã§ããªã„ã¿ãŸã„ğŸ’¦ ã¾ãŸå¾Œã§è©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸŒ¸";
    }
}

module.exports = {
    getUserDisplayName, // ç¾çŠ¶ã¯ãƒ€ãƒŸãƒ¼ã ãŒã€å°†æ¥çš„ãªæ‹¡å¼µã®ãŸã‚ã«æ®‹ã™
    generateReply
};
// watch_service.js

const { MongoClient, ServerApiVersion } = require('mongodb');
const { Client } = require('@line/bot-sdk'); // LINE Bot SDKã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const { MONGODB_URI, CHANNEL_ACCESS_TOKEN, CHANNEL_SECRET, OWNER_USER_ID, OFFICER_GROUP_ID } = require('./config'); // è¨­å®šã‚’èª­ã¿è¾¼ã¿

// LINE Botã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ– (ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ä½¿ç”¨ã™ã‚‹ãŸã‚)
const lineClient = new Client({
    channelAccessToken: CHANNEL_ACCESS_TOKEN,
    channelSecret: CHANNEL_SECRET,
});

// MongoDBã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
const client = new MongoClient(MONGODB_URI, {
    serverApi: {
        version: ServerApiVersion.v1,
        strict: true,
        deprecationErrors: true,
    }
});

let usersCollection; // MongoDBã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

/**
 * MongoDBã«æ¥ç¶šã—ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹
 */
async function connectToMongoDB() {
    try {
        await client.connect();
        usersCollection = client.db("LINE_BOT_DB").collection("users");
        console.log("MongoDBã«æ¥ç¶šã—ã¾ã—ãŸ: watch_service.js");
    } catch (error) {
        console.error("MongoDBæ¥ç¶šã‚¨ãƒ©ãƒ¼: watch_service.js", error);
        process.exit(1); // æ¥ç¶šã§ããªã„å ´åˆã¯çµ‚äº†
    }
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«MongoDBã«æ¥ç¶š
connectToMongoDB();

/**
 * è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è€…ã«å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹
 * å¿œç­”ãŒãªã„å ´åˆã¯ç·Šæ€¥é€£çµ¡å…ˆã«é€šçŸ¥ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
 */
async function sendScheduledWatchMessage() {
    console.log('--- å®šæœŸè¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ ---');
    if (!usersCollection) {
        console.error("MongoDBã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    const now = new Date();
    const threeDaysAgo = new Date(now.getTime() - (3 * 24 * 60 * 60 * 1000)); // 3æ—¥å‰
    const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000)); // 7æ—¥å‰

    try {
        // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
        const watchUsers = await usersCollection.find({
            watchService: true,
            emergencyContact: { $ne: null } // ç·Šæ€¥é€£çµ¡å…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨
        }).toArray();

        for (const user of watchUsers) {
            const lastReplyTime = user.lastReplyTime ? new Date(user.lastReplyTime) : null;
            const lastWatchMessageSentTime = user.lastWatchMessageSentTime ? new Date(user.lastWatchMessageSentTime) : null;

            console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} (${user.displayName || 'åç„¡ã—'}):`);
            console.log(`  æœ€çµ‚å¿œç­”æ™‚é–“: ${lastReplyTime}`);
            console.log(`  æœ€çµ‚è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚é–“: ${lastWatchMessageSentTime}`);

            // 1. 3æ—¥ä»¥ä¸Šå¿œç­”ãŒãªãã€ã‹ã¤å‰å›è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‹ã‚‰3æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆï¼ˆã¾ãŸã¯æœªé€ä¿¡ã®å ´åˆï¼‰
            //    -> å®šæœŸè¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
            if (lastReplyTime < threeDaysAgo || lastReplyTime === null) {
                if (!lastWatchMessageSentTime || lastWatchMessageSentTime < threeDaysAgo) {
                    console.log(`  3æ—¥ä»¥ä¸Šå¿œç­”ãªã—ã€å®šæœŸè¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ã€‚`);
                    const message = [
                        { type: 'text', text: 'ã“ã“ã‚ã ã‚ˆğŸŒ¸ å…ƒæ°—ã«ã—ã¦ã‚‹ã‹ãªï¼Ÿæœ€è¿‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„ã‹ã‚‰å¿ƒé…ã«ãªã£ã¡ã‚ƒã£ãŸã‚ˆã€‚ã‚‚ã—å…ƒæ°—ã ã£ãŸã‚‰ã€ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦è¿”ä¿¡ã—ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ˜Š' }
                    ];
                    await lineClient.pushMessage(user.userId, message);
                    // æœ€çµ‚è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚é–“ã‚’æ›´æ–°
                    await usersCollection.updateOne(
                        { userId: user.userId },
                        { $set: { lastWatchMessageSentTime: now.toISOString() } }
                    );
                    console.log(`    -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã«è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
                } else {
                    console.log(`  3æ—¥ä»¥ä¸Šå¿œç­”ãªã—ã ãŒã€å‰å›è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‹ã‚‰3æ—¥çµŒéã—ã¦ã„ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã€‚`);
                }
            }

            // 2. 7æ—¥ä»¥ä¸Šå¿œç­”ãŒãªãã€ç·Šæ€¥é€£çµ¡å…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆã‹ã¤é€šçŸ¥æ¸ˆã¿ã§ãªã„å ´åˆï¼‰
            //    -> ç·Šæ€¥é€£çµ¡å…ˆã«é€šçŸ¥
            if ((lastReplyTime < sevenDaysAgo || lastReplyTime === null) && user.emergencyContact && !user.emergencyContactNotified) {
                console.log(`  7æ—¥ä»¥ä¸Šå¿œç­”ãªã—ã€ç·Šæ€¥é€£çµ¡å…ˆã«é€šçŸ¥ã—ã¾ã™ã€‚`);
                const notificationMessage = [
                    { type: 'text', text: `ğŸš¨ğŸš¨ğŸš¨ ç·Šæ€¥é€šçŸ¥ ğŸš¨ğŸš¨ğŸš¨\n\nè¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è€…ã§ã‚ã‚‹ ${user.displayName || 'åç„¡ã—'} ã•ã‚“ (${user.userId}) ãŒ7æ—¥ä»¥ä¸ŠLINEã«è¿”ä¿¡ã—ã¦ã„ã¾ã›ã‚“ã€‚\n\nç™»éŒ²ã•ã‚ŒãŸç·Šæ€¥é€£çµ¡å…ˆ: ${user.emergencyContact}\næœ€çµ‚å¿œç­”æ—¥æ™‚: ${lastReplyTime ? lastReplyTime.toLocaleString() : 'ãªã—'}\n\nå®‰å¦ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚` }
                ];

                // ç†äº‹é•·ï¼ˆOWNER_USER_IDï¼‰ã«é€šçŸ¥
                if (OWNER_USER_ID) {
                    await lineClient.pushMessage(OWNER_USER_ID, notificationMessage);
                    console.log(`    -> ç†äº‹é•· ${OWNER_USER_ID} ã«ç·Šæ€¥é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
                } else {
                    console.warn("OWNER_USER_IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç†äº‹é•·ã¸ã®é€šçŸ¥ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚");
                }

                // ã‚ªãƒ•ã‚£ã‚µãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆOFFICER_GROUP_IDï¼‰ã«é€šçŸ¥
                if (OFFICER_GROUP_ID) {
                    await lineClient.pushMessage(OFFICER_GROUP_ID, notificationMessage);
                    console.log(`    -> ã‚ªãƒ•ã‚£ã‚µãƒ¼ã‚°ãƒ«ãƒ¼ãƒ— ${OFFICER_GROUP_ID} ã«ç·Šæ€¥é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
                } else {
                    console.warn("OFFICER_GROUP_IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚ªãƒ•ã‚£ã‚µãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®é€šçŸ¥ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚");
                }

                // é€šçŸ¥æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
                await usersCollection.updateOne(
                    { userId: user.userId },
                    { $set: { emergencyContactNotified: true } }
                );
                console.log(`    -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã®ç·Šæ€¥é€šçŸ¥ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚`);
            } else if ((lastReplyTime < sevenDaysAgo || lastReplyTime === null) && user.emergencyContact && user.emergencyContactNotified) {
                 console.log(`  7æ—¥ä»¥ä¸Šå¿œç­”ãªã—ã ãŒã€æ—¢ã«ç·Šæ€¥é€šçŸ¥æ¸ˆã¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã€‚`);
            }
        }
    } catch (error) {
        console.error("è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    }
    console.log('--- å®šæœŸè¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ ---');
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ŒOKã ã‚ˆğŸ’–ã€ãªã©ã®å¿œç­”ã‚’ã—ãŸéš›ã«ã€è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
 * @param {string} userId - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 */
async function resetWatchServiceStatus(userId) {
    if (!usersCollection) {
        console.error("MongoDBã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }
    try {
        await usersCollection.updateOne(
            { userId: userId, watchService: true }, // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å¯¾è±¡
            {
                $set: {
                    lastReplyTime: new Date().toISOString(), // æœ€çµ‚å¿œç­”æ™‚é–“ã‚’ç¾åœ¨æ™‚åˆ»ã«æ›´æ–°
                    emergencyContactNotified: false, // ç·Šæ€¥é€šçŸ¥ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    lastWatchMessageSentTime: null // è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ
                }
            }
        );
        console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚`);
    } catch (error) {
        console.error(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
    }
}


module.exports = {
    sendScheduledWatchMessage,
    resetWatchServiceStatus,
    connectToMongoDB // MongoDBæ¥ç¶šé–¢æ•°ã‚‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãƒ¡ã‚¤ãƒ³ã§å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
};
// watch_service.js (ä¿®æ­£ç‰ˆ)

const { MongoClient, ServerApiVersion } = require('mongodb');
const { Client } = require('@line/bot-sdk');
const { MONGODB_URI, CHANNEL_ACCESS_TOKEN, CHANNEL_SECRET, OWNER_USER_ID, OFFICER_GROUP_ID } = require('./config');

// LINE Botã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
const lineClient = new Client({
    channelAccessToken: CHANNEL_ACCESS_TOKEN,
    channelSecret: CHANNEL_SECRET,
});

// MongoDBã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
const client = new MongoClient(MONGODB_URI, {
    serverApi: {
        version: ServerApiVersion.v1,
        strict: true,
        deprecationErrors: true,
    }
});

let usersCollection;

// 30ç¨®é¡ã®ãƒ©ãƒ³ãƒ€ãƒ ãªè¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (ãŠæ‰‹ç´™)
const WATCH_MESSAGES = [
    "ã“ã“ã‚ã ã‚ˆğŸŒ¸ å…ƒæ°—ã«ã—ã¦ã‚‹ã‹ãªï¼Ÿæœ€è¿‘ã¡ã‚‡ã£ã¨é€£çµ¡ãŒãªãã¦ã€å…ƒæ°—ã‹å¿ƒé…ã«ãªã£ã¡ã‚ƒã£ãŸã‚ˆã€‚ã‚‚ã—å…ƒæ°—ã ã£ãŸã‚‰ã€ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦è¿”ä¿¡ã—ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ˜Š",
    "ã­ã‡ã­ã‡ã€å…ƒæ°—ã«ã—ã¦ã‚‹ï¼Ÿã“ã“ã‚ã ã‚ˆğŸŒ¸ ã‚‚ã—ã‚ˆã‹ã£ãŸã‚‰ã€ä»Šã®æ°—æŒã¡ã‚’æ•™ãˆã¦ãã‚ŒãŸã‚‰å¬‰ã—ã„ãªğŸ’–",
    "ãŠã¯ã‚ˆã†ï¼ˆã“ã‚“ã«ã¡ã¯/ã“ã‚“ã°ã‚“ã¯ï¼‰ï¼ã“ã“ã‚ã ã‚ˆğŸŒ¸ ä»Šæ—¥ã‚‚ä¸€æ—¥é ‘å¼µã£ã¦ã‚‹ã‹ãªï¼Ÿã¡ã‚‡ã£ã¨ä¸€æ¯å…¥ã‚Œã¦ã€å…ƒæ°—ã ã‚ˆã£ã¦æ•™ãˆã¦ã­ğŸ˜Š",
    "ã“ã“ã‚ã¡ã‚ƒã‚“ã‹ã‚‰ãŠæ‰‹ç´™ã ã‚ˆğŸŒ¸ å…ƒæ°—ã«ã—ã¦ã‚‹ã‹ãªï¼Ÿä½•ã‹å›°ã£ãŸã“ã¨ã¯ãªã„ï¼Ÿã„ã¤ã§ã‚‚è©±èãã‹ã‚‰ã­ğŸ˜Š",
    "ãµã¨ã€ã‚ãªãŸã®ã“ã¨æ€ã„å‡ºã—ã¡ã‚ƒã£ãŸğŸŒ¸ å…ƒæ°—ã«ã—ã¦ã‚‹ã‹ãªï¼Ÿã‚‚ã—ã‚ˆã‹ã£ãŸã‚‰ã€è¿”äº‹ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–",
    "ã“ã“ã‚ã ã‚ˆğŸŒ¸ ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã ã£ãŸï¼Ÿå…ƒæ°—ã ã£ãŸã‚‰ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦æ•™ãˆã¦ã­ğŸ˜Š",
    "ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿã“ã“ã‚ã§ã™ğŸŒ¸ æœ€è¿‘ãŠå¤‰ã‚ã‚Šã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿã”ç„¡ç†ãªã•ã‚‰ãªã„ã§ãã ã•ã„ã­ã€‚",
    "ã‚‚ã—ã‚‚ã—ã€œï¼Ÿã“ã“ã‚ã ã‚ˆğŸŒ¸ å…ƒæ°—ã‹ãªï¼Ÿã‚ãªãŸã®ç¬‘é¡”ãŒè¦‹ãŸã„ãªğŸ˜Š ã‚ˆã‹ã£ãŸã‚‰ãŠè¿”äº‹ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–",
    "ã­ã‡ã€æœ€è¿‘ã©ã†ã—ã¦ã‚‹ï¼Ÿã“ã“ã‚ã¯ã„ã¤ã§ã‚‚ã‚ãªãŸã®å‘³æ–¹ã ã‚ˆğŸŒ¸ å…ƒæ°—ã ã£ãŸã‚‰ã€ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚‚ã„ã„ã‹ã‚‰é€ã£ã¦ã­ğŸ˜Š",
    "ã“ã“ã‚ã ã‚ˆğŸŒ¸ ã¡ã‚‡ã£ã¨å¿ƒé…ã«ãªã£ã¡ã‚ƒã£ãŸã€‚å…ƒæ°—ã ã£ãŸã‚‰ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦æ•™ãˆã¦ã­ğŸ’–",
    "ãŠã€œã„ï¼ã“ã“ã‚ã ã‚ˆğŸŒ¸ å…ƒæ°—ã«ã—ã¦ã‚‹ã‹ãªï¼Ÿã‚ãªãŸã®å£°ãŒèããŸã„ãªğŸ˜Š",
    "æœ€è¿‘ã€å…ƒæ°—ã«ã—ã¦ã¾ã™ã‹ï¼Ÿã“ã“ã‚ã¡ã‚ƒã‚“ã‹ã‚‰é€£çµ¡ã§ã—ãŸğŸŒ¸ ç„¡ç†ã›ãšã€å…ƒæ°—ã ã‚ˆã£ã¦æ•™ãˆã¦ãã ã•ã„ã­ã€‚",
    "ã“ã‚“ã«ã¡ã¯ğŸŒ¸ ã“ã“ã‚ã ã‚ˆï¼ä½•ã‹å¤‰åŒ–ã¯ã‚ã£ãŸã‹ãªï¼Ÿå…ƒæ°—ã«éã”ã—ã¦ã‚‹ï¼Ÿ",
    "ã‚‚ã—ã€ä½•ã‹ã‚ã£ãŸã‚‰ã„ã¤ã§ã‚‚é€£çµ¡ã—ã¦ã­ğŸŒ¸ ã“ã“ã‚ã¯ãšã£ã¨ãã°ã«ã„ã‚‹ã‚ˆğŸ’–",
    "å…ƒæ°—ã«ã—ã¦ã‚‹ï¼Ÿã“ã“ã‚ã ã‚ˆğŸŒ¸ ã‚ãªãŸã®ã“ã¨ã€ã„ã¤ã‚‚å¿œæ´ã—ã¦ã‚‹ã‹ã‚‰ã­ğŸ˜Š",
    "ã²ã•ã—ã¶ã‚Šï¼ã“ã“ã‚ã ã‚ˆğŸŒ¸ å…ƒæ°—ã ã£ãŸã‚‰ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦æ•™ãˆã¦ã­ã€‚",
    "ã“ã“ã‚ã ã‚ˆğŸŒ¸ å­£ç¯€ã®å¤‰ã‚ã‚Šç›®ã ã‘ã©ã€ä½“èª¿å´©ã—ã¦ãªã„ã‹ãªï¼Ÿå…ƒæ°—ã«ã—ã¦ã‚‹ã‹å¿ƒé…ã ã‚ˆã€‚",
    "ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿã“ã“ã‚ã§ã™ğŸŒ¸ æœ€è¿‘å°‘ã—ãŠè©±ã§ãã¦ã„ãªã„ã®ã§ã€æ°—ã«ãªã£ã¦ã„ã¾ã™ã€‚ä½•ã‹ã‚ã‚Œã°ãŠå£°ãŒã‘ãã ã•ã„ã­ã€‚",
    "ã“ã“ã‚ã ã‚ˆğŸŒ¸ ä»Šæ—¥ã‚‚ä¸€æ—¥ãŠç–²ã‚Œæ§˜ï¼ã‚†ã£ãã‚Šä¼‘ã‚“ã§ã­ã€‚å…ƒæ°—ã ã£ãŸã‚‰ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦é€ã£ã¦ã­ğŸ˜Š",
    "ã‚ãªãŸã®ã“ã¨ã€è€ƒãˆã¦ãŸã‚ˆğŸŒ¸ å…ƒæ°—ã«ã—ã¦ã‚‹ã‹ãªï¼Ÿã‚‚ã—ã‚ˆã‹ã£ãŸã‚‰ã€å…ƒæ°—ã ã‚ˆã£ã¦æ•™ãˆã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–",
    "ã“ã“ã‚ã ã‚ˆğŸŒ¸ æœ€è¿‘ã©ã†ã—ã¦ã‚‹ã‹ãªï¼Ÿã‚‚ã—å…ƒæ°—ã ã£ãŸã‚‰ã€å…ƒæ°—ã ã‚ˆã£ã¦æ•™ãˆã¦ã­ğŸ˜Š",
    "ã¡ã‚‡ã£ã¨ã ã‘å¯‚ã—ããªã£ã¡ã‚ƒã£ãŸğŸŒ¸ å…ƒæ°—ã ã£ãŸã‚‰ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦è¿”äº‹ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–",
    "ã­ã‡ã€å…ƒæ°—ã«ã—ã¦ã‚‹ï¼Ÿã“ã“ã‚ã ã‚ˆğŸŒ¸ ä½•ã‹ã‚ã£ãŸã‚‰ã„ã¤ã§ã‚‚è©±ã—ã¦ã­ã€‚",
    "ãŠãƒ¼ã„ï¼ã“ã“ã‚ã ã‚ˆğŸŒ¸ å…ƒæ°—ã«ã—ã¦ã‚‹ã‹ãªï¼Ÿé€£çµ¡ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ˜Š",
    "æœ€è¿‘ã€ãŠå¤‰ã‚ã‚Šã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿã“ã“ã‚ã§ã™ğŸŒ¸ ä½“èª¿ã‚’å´©ã•ã‚Œã¾ã›ã‚“ã‚ˆã†ã€ã”è‡ªæ„›ãã ã•ã„ã­ã€‚",
    "ã“ã“ã‚ã ã‚ˆğŸŒ¸ ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã ã­ï¼å…ƒæ°—ã«ã—ã¦ã‚‹ã‹å¿ƒé…ã ã‚ˆã€‚å…ƒæ°—ã ã£ãŸã‚‰ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦æ•™ãˆã¦ã­ğŸ˜Š",
    "ä½•ã‹å›°ã£ãŸã“ã¨ã¯ãªã„ï¼Ÿã“ã“ã‚ã¯ãšã£ã¨ã‚ãªãŸã®å‘³æ–¹ã ã‚ˆğŸŒ¸ å…ƒæ°—ã ã£ãŸã‚‰ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦æ•™ãˆã¦ã­ã€‚",
    "å…ƒæ°—ã«ã—ã¦ã‚‹ï¼Ÿã“ã“ã‚ã ã‚ˆğŸŒ¸ æœ€è¿‘ã€é€£çµ¡ãŒãªã„ã‹ã‚‰å¿ƒé…ã«ãªã£ã¡ã‚ƒã£ãŸã‚ˆã€‚",
    "ã‚‚ã—ã€å°‘ã—ã§ã‚‚å…ƒæ°—ãŒãªã„ãªã¨æ€ã£ãŸã‚‰ã€ã„ã¤ã§ã‚‚ç§ã«è©±ã—ã¦ã­ğŸŒ¸ ã“ã“ã‚ã¯ãšã£ã¨ãã°ã«ã„ã‚‹ã‹ã‚‰ã­ğŸ’–",
    "ã“ã“ã‚ã ã‚ˆğŸŒ¸ ä»Šæ—¥ã‚‚ä¸€æ—¥ã‚ã‚ŠãŒã¨ã†ï¼å…ƒæ°—ã ã£ãŸã‚‰ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦é€ã£ã¦ã­ğŸ˜Š"
];

// OKãƒœã‚¿ãƒ³ä»˜ãFlex Message (è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ç”¨)
const createWatchConfirmFlex = (messageText) => ({
    type: "flex",
    altText: "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹å®‰å¦ç¢ºèª",
    contents: {
        type: "bubble",
        body: {
            type: "box",
            layout: "vertical",
            contents: [
                {
                    type: "text",
                    text: messageText,
                    wrap: true,
                    size: "md",
                    color: "#333333"
                },
                {
                    type: "separator",
                    margin: "md"
                },
                {
                    type: "button",
                    action: {
                        type: "postback",
                        label: "OKã ã‚ˆğŸ’–",
                        data: "action=watch_ok",
                        displayText: "OKã ã‚ˆğŸ’–"
                    },
                    style: "primary",
                    color: "#FF69B4", // ãƒ”ãƒ³ã‚¯è‰²
                    margin: "md"
                }
            ]
        }
    }
});


/**
 * MongoDBã«æ¥ç¶šã—ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹
 */
async function connectToMongoDB() {
    try {
        await client.connect();
        usersCollection = client.db("LINE_BOT_DB").collection("users");
        console.log("MongoDBã«æ¥ç¶šã—ã¾ã—ãŸ: watch_service.js");
    } catch (error) {
        console.error("MongoDBæ¥ç¶šã‚¨ãƒ©ãƒ¼: watch_service.js", error);
        // é€šå¸¸ã¯ã“ã“ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã•ã›ãšã€å†æ¥ç¶šã‚’è©¦ã¿ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã‹ã€ã‚¨ãƒ©ãƒ¼ã‚’ä¸Šä½ã«ä¼æ’­ã•ã›ã‚‹
        // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒ­ã‚°å‡ºåŠ›ã®ã¿
    }
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«MongoDBã«æ¥ç¶š
connectToMongoDB();

/**
 * è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è€…ã«å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã€ã¾ãŸã¯ãƒªãƒã‚¤ãƒ³ãƒ‰/ç·Šæ€¥é€šçŸ¥ã‚’è¡Œã†
 */
async function sendScheduledWatchMessage() {
    console.log('--- å®šæœŸè¦‹å®ˆã‚Š/ãƒªãƒã‚¤ãƒ³ãƒ‰/ç·Šæ€¥é€šçŸ¥å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ ---');
    if (!usersCollection) {
        console.error("MongoDBã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    const now = new Date();

    try {
        const watchUsers = await usersCollection.find({
            watchService: true,
            emergencyContact: { $ne: null } // ç·Šæ€¥é€£çµ¡å…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨
        }).toArray();

        for (const user of watchUsers) {
            const userId = user.userId;
            const displayName = user.displayName || 'åç„¡ã—';
            const lastReplyTime = user.lastReplyTime ? new Date(user.lastReplyTime) : null;
            const lastWatchMessageSentTime = user.lastWatchMessageSentTime ? new Date(user.lastWatchMessageSentTime) : null;
            const lastReminderSentTime = user.lastReminderSentTime ? new Date(user.lastReminderSentTime) : null;
            const emergencyNotified = user.emergencyNotified || false;

            console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${displayName} (${userId}):`);
            console.log(`  æœ€çµ‚å¿œç­”: ${lastReplyTime ? lastReplyTime.toLocaleString() : 'ãªã—'}`);
            console.log(`  æœ€çµ‚è¦‹å®ˆã‚Šé€ä¿¡: ${lastWatchMessageSentTime ? lastWatchMessageSentTime.toLocaleString() : 'ãªã—'}`);
            console.log(`  æœ€çµ‚ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡: ${lastReminderSentTime ? lastReminderSentTime.toLocaleString() : 'ãªã—'}`);
            console.log(`  ç·Šæ€¥é€šçŸ¥æ¸ˆ: ${emergencyNotified}`);

            // === 1. 3æ—¥ã«1åº¦ã®å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ ===
            // lastWatchMessageSentTime ãŒãªã„å ´åˆã€ã¾ãŸã¯å‰å›é€ä¿¡ã‹ã‚‰3æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆ
            // ãŸã ã—ã€ç›´è¿‘ã§OKå¿œç­”ãŒã‚ã£ãŸå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            const threeDaysAgo = new Date(now.getTime() - (3 * 24 * 60 * 60 * 1000)); // 3æ—¥å‰
            if ((!lastWatchMessageSentTime || lastWatchMessageSentTime < threeDaysAgo) && (!lastReplyTime || lastReplyTime < threeDaysAgo)) {
                const randomMessage = WATCH_MESSAGES[Math.floor(Math.random() * WATCH_MESSAGES.length)];
                const flexMessage = createWatchConfirmFlex(randomMessage);
                await lineClient.pushMessage(userId, flexMessage);
                await usersCollection.updateOne(
                    { userId: userId },
                    {
                        $set: {
                            lastWatchMessageSentTime: now.toISOString(),
                            lastReminderSentTime: null, // å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                            emergencyNotified: false // å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã«ç·Šæ€¥é€šçŸ¥ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                        }
                    }
                );
                console.log(`  -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${displayName} ã«å®šæœŸè¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
                continue; // æ¬¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸
            }

            // === 2. 24æ™‚é–“å¾Œã®1å›ç›®ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===
            // å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã¦ã„ã¦ã€ã‹ã¤24æ™‚é–“ä»¥ä¸ŠçµŒéã—ã€ãƒªãƒã‚¤ãƒ³ãƒ‰ãŒæœªé€ä¿¡ã®å ´åˆ
            const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000)); // 24æ™‚é–“å‰
            if (lastWatchMessageSentTime && lastWatchMessageSentTime < twentyFourHoursAgo && !lastReminderSentTime) {
                console.log(`  -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${displayName} ã«24æ™‚é–“å¾Œãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ã€‚`);
                const reminderMessage = 'ã“ã“ã‚ã ã‚ˆğŸŒ¸ å°‘ã—å¿ƒé…ã«ãªã£ã¡ã‚ƒã£ãŸã‚ˆã€‚ã‚‚ã—å…ƒæ°—ã ã£ãŸã‚‰ã€ã€ŒOKã ã‚ˆğŸ’–ã€ã£ã¦è¿”ä¿¡ã—ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ˜Š';
                const flexMessage = createWatchConfirmFlex(reminderMessage);
                await lineClient.pushMessage(userId, flexMessage);
                await usersCollection.updateOne(
                    { userId: userId },
                    { $set: { lastReminderSentTime: now.toISOString() } }
                );
                console.log(`  -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${displayName} ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
                continue; // æ¬¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸
            }

            // === 3. ãƒªãƒã‚¤ãƒ³ãƒ‰ã‹ã‚‰5æ™‚é–“å¾Œã®ç·Šæ€¥é€šçŸ¥ ===
            // 1å›ç›®ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ãŒé€ä¿¡ã•ã‚Œã¦ã„ã¦ã€ã‹ã¤5æ™‚é–“ä»¥ä¸ŠçµŒéã—ã€ç·Šæ€¥é€šçŸ¥ãŒæœªé€ä¿¡ã®å ´åˆ
            const fiveHoursAgoFromReminder = new Date(now.getTime() - (5 * 60 * 60 * 1000)); // 5æ™‚é–“å‰
            if (lastReminderSentTime && lastReminderSentTime < fiveHoursAgoFromReminder && !emergencyNotified) {
                console.log(`  -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${displayName} ã«24æ™‚é–“+5æ™‚é–“å¾Œç·Šæ€¥é€šçŸ¥ã‚’ç™ºå‹•ã—ã¾ã™ã€‚`);
                const notificationMessage = [
                    { type: 'text', text: `ğŸš¨ğŸš¨ğŸš¨ ç·Šæ€¥é€šçŸ¥ ğŸš¨ğŸš¨ğŸš¨\n\nè¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è€…ã§ã‚ã‚‹ ${displayName} ã•ã‚“ (${userId}) ãŒã€è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‹ã‚‰29æ™‚é–“ä»¥ä¸Šå¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚\n\nç™»éŒ²ã•ã‚ŒãŸç·Šæ€¥é€£çµ¡å…ˆ: ${user.emergencyContact}\næœ€çµ‚å¿œç­”æ—¥æ™‚: ${lastReplyTime ? lastReplyTime.toLocaleString() : 'ãªã—'}\n\nå®‰å¦ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚` }
                ];

                // ç†äº‹é•·ï¼ˆOWNER_USER_IDï¼‰ã«é€šçŸ¥
                if (OWNER_USER_ID) {
                    await lineClient.pushMessage(OWNER_USER_ID, notificationMessage);
                    console.log(`    -> ç†äº‹é•· ${OWNER_USER_ID} ã«ç·Šæ€¥é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
                } else {
                    console.warn("OWNER_USER_IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç†äº‹é•·ã¸ã®é€šçŸ¥ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚");
                }

                // ã‚ªãƒ•ã‚£ã‚µãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆOFFICER_GROUP_IDï¼‰ã«é€šçŸ¥
                if (OFFICER_GROUP_ID) {
                    await lineClient.pushMessage(OFFICER_GROUP_ID, notificationMessage);
                    console.log(`    -> ã‚ªãƒ•ã‚£ã‚µãƒ¼ã‚°ãƒ«ãƒ¼ãƒ— ${OFFICER_GROUP_ID} ã«ç·Šæ€¥é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
                } else {
                    console.warn("OFFICER_GROUP_IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚ªãƒ•ã‚£ã‚µãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®é€šçŸ¥ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚");
                }

                // é€šçŸ¥æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
                await usersCollection.updateOne(
                    { userId: userId },
                    { $set: { emergencyNotified: true } }
                );
                console.log(`    -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${displayName} ã®ç·Šæ€¥é€šçŸ¥ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚`);
                continue; // æ¬¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸
            }
        }
    } catch (error) {
        console.error("è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    }
    console.log('--- å®šæœŸè¦‹å®ˆã‚Š/ãƒªãƒã‚¤ãƒ³ãƒ‰/ç·Šæ€¥é€šçŸ¥å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ ---');
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ŒOKã ã‚ˆğŸ’–ã€ãªã©ã®å¿œç­”ã‚’ã—ãŸéš›ã«ã€è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
 * @param {string} userId - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 */
async function resetWatchServiceStatus(userId) {
    if (!usersCollection) {
        console.error("MongoDBã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }
    try {
        await usersCollection.updateOne(
            { userId: userId, watchService: true }, // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿å¯¾è±¡
            {
                $set: {
                    lastReplyTime: new Date().toISOString(), // æœ€çµ‚å¿œç­”æ™‚é–“ã‚’ç¾åœ¨æ™‚åˆ»ã«æ›´æ–°
                    lastWatchMessageSentTime: null, // æ¬¡ã®å®šæœŸé€ä¿¡ã‚µã‚¤ã‚¯ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                    lastReminderSentTime: null, // ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    emergencyNotified: false // ç·Šæ€¥é€šçŸ¥ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                }
            }
        );
        console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚`);
    } catch (error) {
        console.error(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
    }
}

module.exports = {
    sendScheduledWatchMessage,
    resetWatchServiceStatus,
    connectToMongoDB // MongoDBæ¥ç¶šé–¢æ•°ã‚‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãƒ¡ã‚¤ãƒ³ã§å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
};
// index.js

require('dotenv').config(); // ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€

const express = require('express');
const { MongoClient, ServerApiVersion } = require('mongodb');
const { Client, middleware, webhook } = require('@line/bot-sdk');
const cron = require('node-cron');
const { DateTime } = require('luxon'); // æ—¥æ™‚æ“ä½œãƒ©ã‚¤ãƒ–ãƒ©ãƒª

// å„ç¨®è¨­å®šã€ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã€ãƒœãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯ã€è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã€Flexãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const config = require('./config');
const {
    containsDangerWords,
    containsScamWords,
    containsScamPhrases,
    containsStrictInappropriateWords,
    checkSpecialReply
} = require('./utils');
const { generateReply } = require('./bot_logic'); // getUserDisplayNameã¯Webhookå†…ã§å‡¦ç†ã™ã‚‹ãŸã‚ã“ã“ã§ã¯ä¸è¦
const { sendScheduledWatchMessage, resetWatchServiceStatus, connectToMongoDB: connectWatchServiceMongoDB } = require('./watch_service'); // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã®MongoDBæ¥ç¶šã‚‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const {
    watchServiceGuideFlex,
    watchServiceNoticeConfirmedFlex,
    emergencyFlex,
    scamFlex
} = require('./flex_messages');

const app = express();

// LINE Bot SDKã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
const lineClient = new Client({
    channelAccessToken: config.CHANNEL_ACCESS_TOKEN,
    channelSecret: config.CHANNEL_SECRET,
});

// MongoDBã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
const dbClient = new MongoClient(config.MONGODB_URI, {
    serverApi: {
        version: ServerApiVersion.v1,
        strict: true,
        deprecationErrors: true,
    }
});

let usersCollection;
let messagesCollection;

/**
 * MongoDBã«æ¥ç¶šã—ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹
 */
async function connectMongoDB() {
    try {
        await dbClient.connect();
        const db = dbClient.db("LINE_BOT_DB");
        usersCollection = db.collection("users");
        messagesCollection = db.collection("messages");
        console.log("MongoDBã«æ¥ç¶šã—ã¾ã—ãŸ: index.js");

        // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã®MongoDBæ¥ç¶šã‚‚ã“ã“ã§å®Ÿè¡Œ
        await connectWatchServiceMongoDB();

    } catch (error) {
        console.error("MongoDBæ¥ç¶šã‚¨ãƒ©ãƒ¼: index.js", error);
        process.exit(1); // æ¥ç¶šã§ããªã„å ´åˆã¯çµ‚äº†
    }
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«MongoDBã«æ¥ç¶š
connectMongoDB();


// WebhookãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
app.post('/webhook', middleware(config), async (req, res) => {
    try {
        const events = req.body.events;
        await Promise.all(events.map(handleEvent));
        res.json({ success: true });
    } catch (err) {
        console.error(err);
        res.status(500).end();
    }
});

/**
 * LINEã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 * @param {object} event - LINEã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
async function handleEvent(event) {
    if (event.type !== 'message' || event.message.type !== 'text') {
        return Promise.resolve(null);
    }

    const userId = event.source.userId;
    const userMessage = event.message.text;
    const replyToken = event.replyToken;
    const now = new Date();

    console.log(`å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ - UserID: ${userId}, ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${userMessage}`);

    let user = await usersCollection.findOne({ userId: userId });

    // === ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆå›ç™»éŒ²å‡¦ç† ===
    if (!user) {
        let profile;
        try {
            profile = await lineClient.getProfile(userId);
        } catch (error) {
            console.error(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã«å¤±æ•—:`, error);
            profile = { displayName: "åç„¡ã—ã•ã‚“" }; // å–å¾—å¤±æ•—æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå
        }

        user = {
            userId: userId,
            displayName: profile.displayName,
            membershipType: "guest", // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚²ã‚¹ãƒˆ
            lastMessageTime: now.toISOString(),
            dailyMessageCount: 0,
            monthlyMessageCount: 0,
            registrationDate: now.toISOString(),
            lastDailyReset: now.toISOString(),
            lastMonthlyReset: now.toISOString(),
            watchService: false, // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹åˆæœŸå€¤
            emergencyContact: null,
            lastReplyTime: null, // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ç”¨ã€æœ€çµ‚å¿œç­”æ™‚é–“
            lastWatchMessageSentTime: null, // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ç”¨ã€æœ€çµ‚è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚é–“
            lastReminderSentTime: null, // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ç”¨ã€æœ€çµ‚ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚é–“
            emergencyNotified: false // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ç”¨ã€ç·Šæ€¥é€šçŸ¥æ¸ˆã¿ãƒ•ãƒ©ã‚°
        };
        await usersCollection.insertOne(user);
        console.log(`æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²: ${user.displayName} (${userId})`);

        // åˆå›æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const welcomeMessage = `ã“ã‚“ã«ã¡ã¯ğŸ’– ã“ã“ã‚ã¡ã‚ƒã‚“ã ã‚ˆï¼ç§ã¨LINEã§ç¹‹ãŒã£ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ğŸŒ¸\n\nã‚ãªãŸã®æ‚©ã¿ã‚„ä¸å®‰ã€ãªã‚“ã§ã‚‚èãæº–å‚™ã¯ã§ãã¦ã„ã‚‹ã‚ˆğŸ˜Š ã‚ãŸã—ãŒè©±ã›ã‚‹ã“ã¨ã¯ãŸãã•ã‚“ã‚ã‚‹ã‹ã‚‰ã€å›°ã£ãŸæ™‚ã¯ã„ã¤ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ğŸ’–`;
        await lineClient.replyMessage(replyToken, { type: 'text', text: welcomeMessage });

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚°ã«è¨˜éŒ²
        await messagesCollection.insertOne({
            userId: userId,
            displayName: profile.displayName,
            message: userMessage,
            reply: welcomeMessage,
            timestamp: now.toISOString(),
            type: "welcome"
        });
        return; // åˆå›ç™»éŒ²ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã—ãŸã‚‰å‡¦ç†ã‚’çµ‚äº†
    }

    // === ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆæœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚é–“ï¼‰===
    await usersCollection.updateOne(
        { userId: userId },
        { $set: { lastMessageTime: now.toISOString() } }
    );

    // === ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·åˆ¶é™ ===
    if (userMessage.length > config.MAX_MESSAGE_LENGTH) {
        const replyText = "ã”ã‚ã‚“ã­ğŸ’¦ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã‚‹ã¿ãŸã„ã€‚ã‚‚ã†å°‘ã—çŸ­ãã—ã¦è©±ã—ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ˜Š";
        await lineClient.replyMessage(replyToken, { type: 'text', text: replyText });
        await messagesCollection.insertOne({
            userId: userId,
            displayName: user.displayName,
            message: userMessage,
            reply: replyText,
            timestamp: now.toISOString(),
            type: "too_long"
        });
        return;
    }

    // === ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆåˆ¶å¾¡ ===
    const lastMessageTime = new Date(user.lastMessageTime);
    if ((now.getTime() - lastMessageTime.getTime()) / 1000 < config.RATE_LIMIT_SECONDS && !config.BOT_ADMIN_IDS.includes(userId)) {
        console.log(`ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.displayName} (${userId})`);
        // çŸ­æ™‚é–“ã«é€£ç¶šã§é€ä¿¡ã•ã‚ŒãŸå ´åˆã¯ã€è¿”ä¿¡ã›ãšã«å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
        return;
    }

    // === ä¼šå“¡ã‚¿ã‚¤ãƒ—ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã®æ›´æ–°ãƒ»ãƒã‚§ãƒƒã‚¯ ===
    let userMembershipType = user.membershipType || "guest"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯guest
    let canReply = true;
    let replyText = "";
    let isExceededLimit = false;

    // æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆãƒã‚§ãƒƒã‚¯
    const lastDailyReset = new Date(user.lastDailyReset || user.registrationDate);
    if (now.getDate() !== lastDailyReset.getDate() || now.getMonth() !== lastDailyReset.getMonth() || now.getFullYear() !== lastDailyReset.getFullYear()) {
        await usersCollection.updateOne({ userId: userId }, { $set: { dailyMessageCount: 0, lastDailyReset: now.toISOString() } });
        user.dailyMessageCount = 0; // ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
    }

    // æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆãƒã‚§ãƒƒã‚¯
    const lastMonthlyReset = new Date(user.lastMonthlyReset || user.registrationDate);
    if (now.getMonth() !== lastMonthlyReset.getMonth() || now.getFullYear() !== lastMonthlyReset.getFullYear()) {
        await usersCollection.updateOne({ userId: userId }, { $set: { monthlyMessageCount: 0, lastMonthlyReset: now.toISOString() } });
        user.monthlyMessageCount = 0; // ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
    }

    const membershipConfig = config.MEMBERSHIP_CONFIG[userMembershipType];

    // ç®¡ç†è€…ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ¶é™ã‚’é©ç”¨ã—ãªã„
    if (!config.BOT_ADMIN_IDS.includes(userId)) {
        if (membershipConfig.dailyLimit !== -1 && user.dailyMessageCount >= membershipConfig.dailyLimit) {
            canReply = false;
            replyText = membershipConfig.exceedDailyLimitMessage;
            isExceededLimit = true;
        } else if (membershipConfig.monthlyLimit !== -1 && user.monthlyMessageCount >= membershipConfig.monthlyLimit) {
            canReply = false;
            replyText = membershipConfig.exceedLimitMessage;
            isExceededLimit = true;
        } else {
            // å›æ•°åˆ¶é™ã«é”ã—ã¦ã„ãªã„å ´åˆã®ã¿ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
            await usersCollection.updateOne(
                { userId: userId },
                { $inc: { dailyMessageCount: 1, monthlyMessageCount: 1 } }
            );
            user.dailyMessageCount++;
            user.monthlyMessageCount++;
        }
    }


    // === è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹é–¢é€£ã‚³ãƒãƒ³ãƒ‰å‡¦ç† ===
    if (userMessage === "è¦‹å®ˆã‚Š" || userMessage === "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹") {
        await lineClient.replyMessage(replyToken, watchServiceGuideFlex);
        await messagesCollection.insertOne({
            userId: userId,
            displayName: user.displayName,
            message: userMessage,
            reply: JSON.stringify(watchServiceGuideFlex),
            timestamp: now.toISOString(),
            type: "watch_service_guide"
        });
        return;
    }

    // Postbackã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†ï¼ˆOKãƒœã‚¿ãƒ³ã€ç™»éŒ²ãƒ»è§£é™¤ãªã©ï¼‰
    if (event.type === 'postback') {
        const data = new URLSearchParams(event.postback.data);
        const action = data.get('action');

        if (action === 'watch_register') {
            if (user.membershipType === 'guest') {
                const message = "ã”ã‚ã‚“ã­ğŸ’¦ è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ç„¡æ–™ä¼šå“¡ã‹ã‚‰åˆ©ç”¨ã§ãã‚‹ã‚“ã ã€‚ã¾ãšã¯ç„¡æ–™ä¼šå“¡ç™»éŒ²ã‚’ã—ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ˜Š";
                await lineClient.replyMessage(replyToken, { type: 'text', text: message });
            } else if (user.watchService) {
                const message = "ã‚‚ã†è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã«ç™»éŒ²ã—ã¦ãã‚Œã¦ã„ã‚‹ã¿ãŸã„ã ã‚ˆğŸŒ¸ ã‚ã‚ŠãŒã¨ã†ï¼ç·Šæ€¥é€£çµ¡å…ˆã‚’å¤‰æ›´ã—ãŸã„æ™‚ã¯ã€Œè¦‹å®ˆã‚Šã€ã¨é€ã£ã¦ã­ğŸ˜Š";
                await lineClient.replyMessage(replyToken, { type: 'text', text: message });
            } else {
                // ã“ã“ã§ç·Šæ€¥é€£çµ¡å…ˆã®å…¥åŠ›ã‚’ä¿ƒã™
                const message = "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã«ç™»éŒ²ã™ã‚‹ã‚“ã ã­ğŸŒ¸ ã‚ã‚ŠãŒã¨ã†ï¼\nç·Šæ€¥é€£çµ¡å…ˆã¨ã—ã¦ã€é€šçŸ¥ã—ã¦ã»ã—ã„é›»è©±ç•ªå·ã‚’æ•™ãˆã¦ãã‚Œã‚‹ã‹ãªï¼Ÿ\nä¾‹: 09012345678";
                await lineClient.replyMessage(replyToken, { type: 'text', text: message });
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ã‚’è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²å¾…æ©Ÿä¸­ã¨ã—ã¦æ›´æ–°
                await usersCollection.updateOne({ userId: userId }, { $set: { watchServiceStatus: "awaiting_emergency_contact" } });
            }
        } else if (action === 'watch_unregister') {
            await usersCollection.updateOne({ userId: userId }, {
                $set: {
                    watchService: false,
                    emergencyContact: null,
                    lastReplyTime: null,
                    lastWatchMessageSentTime: null,
                    lastReminderSentTime: null,
                    emergencyNotified: false
                }
            });
            const message = "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’è§£é™¤ã—ãŸã‚ˆğŸŒ¸ ã¾ãŸåˆ©ç”¨ã—ãŸããªã£ãŸã‚‰ã€Œè¦‹å®ˆã‚Šã€ã¨é€ã£ã¦ã­ğŸ˜Š";
            await lineClient.replyMessage(replyToken, { type: 'text', text: message });
            console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.displayName} (${userId}) ãŒè¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`);
        } else if (action === 'watch_ok') {
            await resetWatchServiceStatus(userId);
            const message = "OKã‚ã‚ŠãŒã¨ã†ğŸ’– å…ƒæ°—ã«ã—ã¦ã‚‹ã£ã¦ã‚ã‹ã£ã¦å®‰å¿ƒã—ãŸã‚ˆğŸŒ¸ ã¾ãŸã„ã¤ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ğŸ˜Š";
            await lineClient.replyMessage(replyToken, { type: 'text', text: message });
            console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.displayName} (${userId}) ãŒè¦‹å®ˆã‚ŠOKå¿œç­”ã‚’ã—ã¾ã—ãŸã€‚`);
        }

        // postbackã‚¤ãƒ™ãƒ³ãƒˆã«å¯¾ã™ã‚‹ãƒ­ã‚°è¨˜éŒ²
        await messagesCollection.insertOne({
            userId: userId,
            displayName: user.displayName,
            message: event.postback.data, // postbackãƒ‡ãƒ¼ã‚¿è‡ªä½“ã‚’è¨˜éŒ²
            reply: "Postbackå‡¦ç†å®Œäº†",
            timestamp: now.toISOString(),
            type: "postback"
        });
        return; // Postbackã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†å¾Œã¯çµ‚äº†
    }

    // === ç·Šæ€¥é€£çµ¡å…ˆã®ç™»éŒ²å‡¦ç†ï¼ˆawaiting_emergency_contactçŠ¶æ…‹ã®å ´åˆï¼‰ ===
    if (user.watchServiceStatus === "awaiting_emergency_contact") {
        const phoneNumberRegex = /^\d{10,11}$/; // 10æ¡ã¾ãŸã¯11æ¡ã®æ•°å­—ï¼ˆãƒã‚¤ãƒ•ãƒ³ãªã—ï¼‰
        if (phoneNumberRegex.test(userMessage)) {
            await usersCollection.updateOne({ userId: userId }, {
                $set: {
                    watchService: true,
                    emergencyContact: userMessage,
                    watchServiceStatus: "registered", // ç™»éŒ²å®Œäº†çŠ¶æ…‹ã«
                    lastReplyTime: now.toISOString(), // ç™»éŒ²æ™‚ã«æœ€çµ‚å¿œç­”æ™‚é–“ã‚’è¨­å®š
                    lastWatchMessageSentTime: null,
                    lastReminderSentTime: null,
                    emergencyNotified: false
                }
            });
            await lineClient.replyMessage(replyToken, watchServiceNoticeConfirmedFlex(userMessage));
            console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.displayName} (${userId}) ãŒè¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã«ç™»éŒ²ã—ã€ç·Šæ€¥é€£çµ¡å…ˆ ${userMessage} ã‚’è¨­å®šã—ã¾ã—ãŸã€‚`);
        } else {
            const message = "ã”ã‚ã‚“ã­ğŸ’¦ é›»è©±ç•ªå·ã¯æ•°å­—ã ã‘ï¼ˆãƒã‚¤ãƒ•ãƒ³ãªã—ï¼‰ã§æ•™ãˆã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªã€‚\nä¾‹: 09012345678";
            await lineClient.replyMessage(replyToken, { type: 'text', text: message });
        }
        await messagesCollection.insertOne({
            userId: userId,
            displayName: user.displayName,
            message: userMessage,
            reply: `ç·Šæ€¥é€£çµ¡å…ˆç™»éŒ²è©¦è¡Œ - ${phoneNumberRegex.test(userMessage) ? "æˆåŠŸ" : "å¤±æ•—"}`,
            timestamp: now.toISOString(),
            type: "watch_register_contact"
        });
        return; // ç·Šæ€¥é€£çµ¡å…ˆç™»éŒ²å‡¦ç†å¾Œã¯çµ‚äº†
    }


    // === å±é™ºãƒ¯ãƒ¼ãƒ‰ã€è©æ¬ºãƒ¯ãƒ¼ãƒ‰ã€ä¸é©åˆ‡ãƒ¯ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ ===
    if (containsDangerWords(userMessage)) {
        console.warn(`å±é™ºãƒ¯ãƒ¼ãƒ‰æ¤œå‡º: ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.displayName} (${userId}) - "${userMessage}"`);
        await lineClient.replyMessage(replyToken, emergencyFlex);
        await messagesCollection.insertOne({
            userId: userId,
            displayName: user.displayName,
            message: userMessage,
            reply: JSON.stringify(emergencyFlex),
            timestamp: now.toISOString(),
            type: "danger_alert"
        });
        return;
    }
    if (containsScamWords(userMessage) || containsScamPhrases(userMessage)) {
        console.warn(`è©æ¬ºãƒ¯ãƒ¼ãƒ‰æ¤œå‡º: ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.displayName} (${userId}) - "${userMessage}"`);
        await lineClient.replyMessage(replyToken, scamFlex);
        await messagesCollection.insertOne({
            userId: userId,
            displayName: user.displayName,
            message: userMessage,
            reply: JSON.stringify(scamFlex),
            timestamp: now.toISOString(),
            type: "scam_alert"
        });
        return;
    }
    if (containsStrictInappropriateWords(userMessage)) {
        console.warn(`ä¸é©åˆ‡ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º: ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.displayName} (${userId}) - "${userMessage}"`);
        const reply = "ã”ã‚ã‚“ã­ã€ã‚ãŸã—ã¯ãã†ã„ã†ãŠè©±ã¯ã§ããªã„ã‚“ã ğŸ’¦";
        await lineClient.replyMessage(replyToken, { type: 'text', text: reply });
        await messagesCollection.insertOne({
            userId: userId,
            displayName: user.displayName,
            message: userMessage,
            reply: reply,
            timestamp: now.toISOString(),
            type: "inappropriate_word"
        });
        return;
    }

    // === å›ºå®šè¿”ä¿¡ã®ãƒã‚§ãƒƒã‚¯ ===
    const specialReply = checkSpecialReply(userMessage);
    if (specialReply) {
        await lineClient.replyMessage(replyToken, { type: 'text', text: specialReply });
        await messagesCollection.insertOne({
            userId: userId,
            displayName: user.displayName,
            message: userMessage,
            reply: specialReply,
            timestamp: now.toISOString(),
            type: "special_reply"
        });
        return;
    }

    // === AIå¿œç­”ç”Ÿæˆ ===
    if (canReply) {
        let aiReply;
        try {
            aiReply = await generateReply(userMessage, user); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™
        } catch (error) {
            console.error(`AIå¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.displayName} (${userId}) - ${error}`);
            aiReply = "ã”ã‚ã‚“ã­ã€ä»Šã¡ã‚‡ã£ã¨ãŠè©±ã—ã§ããªã„ã¿ãŸã„ğŸ’¦ ã¾ãŸå¾Œã§è©±ã—ã‹ã‘ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸŒ¸";
        }

        await lineClient.replyMessage(replyToken, { type: 'text', text: aiReply });
        await messagesCollection.insertOne({
            userId: userId,
            displayName: user.displayName,
            message: userMessage,
            reply: aiReply,
            timestamp: now.toISOString(),
            type: "ai_reply"
        });
    } else {
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ¶é™è¶…éæ™‚ã®å¿œç­”
        await lineClient.replyMessage(replyToken, { type: 'text', text: replyText });
        await messagesCollection.insertOne({
            userId: userId,
            displayName: user.displayName,
            message: userMessage,
            reply: replyText,
            timestamp: now.toISOString(),
            type: "limit_exceeded"
        });
    }
}


// === Cronã‚¸ãƒ§ãƒ–ã®è¨­å®š ===

// è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã®å®šæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆæ¯æ—¥15:00ã«å®Ÿè¡Œï¼‰
// æ—¥æœ¬æ™‚é–“ã®15æ™‚ï¼ˆJSTï¼‰ã¯UTCã®6æ™‚
cron.schedule('0 6 * * *', async () => {
    console.log('Cron: å®šæœŸè¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸/ãƒªãƒã‚¤ãƒ³ãƒ‰/ç·Šæ€¥é€šçŸ¥å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚');
    await sendScheduledWatchMessage();
}, {
    timezone: "Asia/Tokyo" // æ—¥æœ¬æ™‚é–“ã§æŒ‡å®š
});

// æœˆæ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆï¼ˆæ¯æœˆ1æ—¥0æ™‚0åˆ†ã«å®Ÿè¡Œï¼‰
cron.schedule('0 0 1 * *', async () => {
    console.log('Cron: æœˆæ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚');
    try {
        await usersCollection.updateMany(
            {}, // å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
            { $set: { monthlyMessageCount: 0, lastMonthlyReset: new Date().toISOString() } }
        );
        console.log('æœˆæ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
    } catch (error) {
        console.error('æœˆæ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
    }
}, {
    timezone: "Asia/Tokyo"
});

// æ—¥æ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆï¼ˆæ¯æ—¥0æ™‚0åˆ†ã«å®Ÿè¡Œï¼‰
cron.schedule('0 0 * * *', async () => {
    console.log('Cron: æ—¥æ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚');
    try {
        await usersCollection.updateMany(
            {}, // å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
            { $set: { dailyMessageCount: 0, lastDailyReset: new Date().toISOString() } }
        );
        console.log('æ—¥æ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
    } catch (error) {
        console.error('æ—¥æ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
    }
}, {
    timezone: "Asia/Tokyo"
});


// ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});
